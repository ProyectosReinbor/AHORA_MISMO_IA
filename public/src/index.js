var j3=Object.create;var{getPrototypeOf:R3,defineProperty:B1,getOwnPropertyNames:N3}=Object;var G3=Object.prototype.hasOwnProperty;var t5=(f,Y,K)=>{K=f!=null?j3(R3(f)):{};let A=Y||!f||!f.__esModule?B1(K,"default",{value:f,enumerable:!0}):K;for(let L of N3(f))if(!G3.call(A,L))B1(A,L,{get:()=>f[L],enumerable:!0});return A};var y3=(f,Y)=>()=>(Y||f((Y={exports:{}}).exports,Y),Y.exports);var y0=(f,Y)=>{for(var K in Y)B1(f,K,{get:Y[K],enumerable:!0,configurable:!0,set:(A)=>Y[K]=()=>A})};var P5=y3((Q9,h5)=>{var h={};h.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)};h.localCName=h.generateIdentifier();h.splitLines=function(f){return f.trim().split(`
`).map((Y)=>Y.trim())};h.splitSections=function(f){return f.split(`
m=`).map((K,A)=>(A>0?"m="+K:K).trim()+`\r
`)};h.getDescription=function(f){let Y=h.splitSections(f);return Y&&Y[0]};h.getMediaSections=function(f){let Y=h.splitSections(f);return Y.shift(),Y};h.matchPrefix=function(f,Y){return h.splitLines(f).filter((K)=>K.indexOf(Y)===0)};h.parseCandidate=function(f){let Y;if(f.indexOf("a=candidate:")===0)Y=f.substring(12).split(" ");else Y=f.substring(10).split(" ");let K={foundation:Y[0],component:{1:"rtp",2:"rtcp"}[Y[1]]||Y[1],protocol:Y[2].toLowerCase(),priority:parseInt(Y[3],10),ip:Y[4],address:Y[4],port:parseInt(Y[5],10),type:Y[7]};for(let A=8;A<Y.length;A+=2)switch(Y[A]){case"raddr":K.relatedAddress=Y[A+1];break;case"rport":K.relatedPort=parseInt(Y[A+1],10);break;case"tcptype":K.tcpType=Y[A+1];break;case"ufrag":K.ufrag=Y[A+1],K.usernameFragment=Y[A+1];break;default:if(K[Y[A]]===void 0)K[Y[A]]=Y[A+1];break}return K};h.writeCandidate=function(f){let Y=[];Y.push(f.foundation);let K=f.component;if(K==="rtp")Y.push(1);else if(K==="rtcp")Y.push(2);else Y.push(K);Y.push(f.protocol.toUpperCase()),Y.push(f.priority),Y.push(f.address||f.ip),Y.push(f.port);let A=f.type;if(Y.push("typ"),Y.push(A),A!=="host"&&f.relatedAddress&&f.relatedPort)Y.push("raddr"),Y.push(f.relatedAddress),Y.push("rport"),Y.push(f.relatedPort);if(f.tcpType&&f.protocol.toLowerCase()==="tcp")Y.push("tcptype"),Y.push(f.tcpType);if(f.usernameFragment||f.ufrag)Y.push("ufrag"),Y.push(f.usernameFragment||f.ufrag);return"candidate:"+Y.join(" ")};h.parseIceOptions=function(f){return f.substring(14).split(" ")};h.parseRtpMap=function(f){let Y=f.substring(9).split(" "),K={payloadType:parseInt(Y.shift(),10)};return Y=Y[0].split("/"),K.name=Y[0],K.clockRate=parseInt(Y[1],10),K.channels=Y.length===3?parseInt(Y[2],10):1,K.numChannels=K.channels,K};h.writeRtpMap=function(f){let Y=f.payloadType;if(f.preferredPayloadType!==void 0)Y=f.preferredPayloadType;let K=f.channels||f.numChannels||1;return"a=rtpmap:"+Y+" "+f.name+"/"+f.clockRate+(K!==1?"/"+K:"")+`\r
`};h.parseExtmap=function(f){let Y=f.substring(9).split(" ");return{id:parseInt(Y[0],10),direction:Y[0].indexOf("/")>0?Y[0].split("/")[1]:"sendrecv",uri:Y[1],attributes:Y.slice(2).join(" ")}};h.writeExtmap=function(f){return"a=extmap:"+(f.id||f.preferredId)+(f.direction&&f.direction!=="sendrecv"?"/"+f.direction:"")+" "+f.uri+(f.attributes?" "+f.attributes:"")+`\r
`};h.parseFmtp=function(f){let Y={},K,A=f.substring(f.indexOf(" ")+1).split(";");for(let L=0;L<A.length;L++)K=A[L].trim().split("="),Y[K[0].trim()]=K[1];return Y};h.writeFmtp=function(f){let Y="",K=f.payloadType;if(f.preferredPayloadType!==void 0)K=f.preferredPayloadType;if(f.parameters&&Object.keys(f.parameters).length){let A=[];Object.keys(f.parameters).forEach((L)=>{if(f.parameters[L]!==void 0)A.push(L+"="+f.parameters[L]);else A.push(L)}),Y+="a=fmtp:"+K+" "+A.join(";")+`\r
`}return Y};h.parseRtcpFb=function(f){let Y=f.substring(f.indexOf(" ")+1).split(" ");return{type:Y.shift(),parameter:Y.join(" ")}};h.writeRtcpFb=function(f){let Y="",K=f.payloadType;if(f.preferredPayloadType!==void 0)K=f.preferredPayloadType;if(f.rtcpFeedback&&f.rtcpFeedback.length)f.rtcpFeedback.forEach((A)=>{Y+="a=rtcp-fb:"+K+" "+A.type+(A.parameter&&A.parameter.length?" "+A.parameter:"")+`\r
`});return Y};h.parseSsrcMedia=function(f){let Y=f.indexOf(" "),K={ssrc:parseInt(f.substring(7,Y),10)},A=f.indexOf(":",Y);if(A>-1)K.attribute=f.substring(Y+1,A),K.value=f.substring(A+1);else K.attribute=f.substring(Y+1);return K};h.parseSsrcGroup=function(f){let Y=f.substring(13).split(" ");return{semantics:Y.shift(),ssrcs:Y.map((K)=>parseInt(K,10))}};h.getMid=function(f){let Y=h.matchPrefix(f,"a=mid:")[0];if(Y)return Y.substring(6)};h.parseFingerprint=function(f){let Y=f.substring(14).split(" ");return{algorithm:Y[0].toLowerCase(),value:Y[1].toUpperCase()}};h.getDtlsParameters=function(f,Y){return{role:"auto",fingerprints:h.matchPrefix(f+Y,"a=fingerprint:").map(h.parseFingerprint)}};h.writeDtlsParameters=function(f,Y){let K="a=setup:"+Y+`\r
`;return f.fingerprints.forEach((A)=>{K+="a=fingerprint:"+A.algorithm+" "+A.value+`\r
`}),K};h.parseCryptoLine=function(f){let Y=f.substring(9).split(" ");return{tag:parseInt(Y[0],10),cryptoSuite:Y[1],keyParams:Y[2],sessionParams:Y.slice(3)}};h.writeCryptoLine=function(f){return"a=crypto:"+f.tag+" "+f.cryptoSuite+" "+(typeof f.keyParams==="object"?h.writeCryptoKeyParams(f.keyParams):f.keyParams)+(f.sessionParams?" "+f.sessionParams.join(" "):"")+`\r
`};h.parseCryptoKeyParams=function(f){if(f.indexOf("inline:")!==0)return null;let Y=f.substring(7).split("|");return{keyMethod:"inline",keySalt:Y[0],lifeTime:Y[1],mkiValue:Y[2]?Y[2].split(":")[0]:void 0,mkiLength:Y[2]?Y[2].split(":")[1]:void 0}};h.writeCryptoKeyParams=function(f){return f.keyMethod+":"+f.keySalt+(f.lifeTime?"|"+f.lifeTime:"")+(f.mkiValue&&f.mkiLength?"|"+f.mkiValue+":"+f.mkiLength:"")};h.getCryptoParameters=function(f,Y){return h.matchPrefix(f+Y,"a=crypto:").map(h.parseCryptoLine)};h.getIceParameters=function(f,Y){let K=h.matchPrefix(f+Y,"a=ice-ufrag:")[0],A=h.matchPrefix(f+Y,"a=ice-pwd:")[0];if(!(K&&A))return null;return{usernameFragment:K.substring(12),password:A.substring(10)}};h.writeIceParameters=function(f){let Y="a=ice-ufrag:"+f.usernameFragment+`\r
a=ice-pwd:`+f.password+`\r
`;if(f.iceLite)Y+=`a=ice-lite\r
`;return Y};h.parseRtpParameters=function(f){let Y={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},A=h.splitLines(f)[0].split(" ");Y.profile=A[2];for(let z=3;z<A.length;z++){let X=A[z],I=h.matchPrefix(f,"a=rtpmap:"+X+" ")[0];if(I){let J=h.parseRtpMap(I),H=h.matchPrefix(f,"a=fmtp:"+X+" ");switch(J.parameters=H.length?h.parseFmtp(H[0]):{},J.rtcpFeedback=h.matchPrefix(f,"a=rtcp-fb:"+X+" ").map(h.parseRtcpFb),Y.codecs.push(J),J.name.toUpperCase()){case"RED":case"ULPFEC":Y.fecMechanisms.push(J.name.toUpperCase());break;default:break}}}h.matchPrefix(f,"a=extmap:").forEach((z)=>{Y.headerExtensions.push(h.parseExtmap(z))});let L=h.matchPrefix(f,"a=rtcp-fb:* ").map(h.parseRtcpFb);return Y.codecs.forEach((z)=>{L.forEach((X)=>{if(!z.rtcpFeedback.find((J)=>{return J.type===X.type&&J.parameter===X.parameter}))z.rtcpFeedback.push(X)})}),Y};h.writeRtpDescription=function(f,Y){let K="";K+="m="+f+" ",K+=Y.codecs.length>0?"9":"0",K+=" "+(Y.profile||"UDP/TLS/RTP/SAVPF")+" ",K+=Y.codecs.map((L)=>{if(L.preferredPayloadType!==void 0)return L.preferredPayloadType;return L.payloadType}).join(" ")+`\r
`,K+=`c=IN IP4 0.0.0.0\r
`,K+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,Y.codecs.forEach((L)=>{K+=h.writeRtpMap(L),K+=h.writeFmtp(L),K+=h.writeRtcpFb(L)});let A=0;if(Y.codecs.forEach((L)=>{if(L.maxptime>A)A=L.maxptime}),A>0)K+="a=maxptime:"+A+`\r
`;if(Y.headerExtensions)Y.headerExtensions.forEach((L)=>{K+=h.writeExtmap(L)});return K};h.parseRtpEncodingParameters=function(f){let Y=[],K=h.parseRtpParameters(f),A=K.fecMechanisms.indexOf("RED")!==-1,L=K.fecMechanisms.indexOf("ULPFEC")!==-1,z=h.matchPrefix(f,"a=ssrc:").map((Z)=>h.parseSsrcMedia(Z)).filter((Z)=>Z.attribute==="cname"),X=z.length>0&&z[0].ssrc,I,J=h.matchPrefix(f,"a=ssrc-group:FID").map((Z)=>{return Z.substring(17).split(" ").map((q)=>parseInt(q,10))});if(J.length>0&&J[0].length>1&&J[0][0]===X)I=J[0][1];if(K.codecs.forEach((Z)=>{if(Z.name.toUpperCase()==="RTX"&&Z.parameters.apt){let Q={ssrc:X,codecPayloadType:parseInt(Z.parameters.apt,10)};if(X&&I)Q.rtx={ssrc:I};if(Y.push(Q),A)Q=JSON.parse(JSON.stringify(Q)),Q.fec={ssrc:X,mechanism:L?"red+ulpfec":"red"},Y.push(Q)}}),Y.length===0&&X)Y.push({ssrc:X});let H=h.matchPrefix(f,"b=");if(H.length){if(H[0].indexOf("b=TIAS:")===0)H=parseInt(H[0].substring(7),10);else if(H[0].indexOf("b=AS:")===0)H=parseInt(H[0].substring(5),10)*1000*0.95-16000;else H=void 0;Y.forEach((Z)=>{Z.maxBitrate=H})}return Y};h.parseRtcpParameters=function(f){let Y={},K=h.matchPrefix(f,"a=ssrc:").map((z)=>h.parseSsrcMedia(z)).filter((z)=>z.attribute==="cname")[0];if(K)Y.cname=K.value,Y.ssrc=K.ssrc;let A=h.matchPrefix(f,"a=rtcp-rsize");Y.reducedSize=A.length>0,Y.compound=A.length===0;let L=h.matchPrefix(f,"a=rtcp-mux");return Y.mux=L.length>0,Y};h.writeRtcpParameters=function(f){let Y="";if(f.reducedSize)Y+=`a=rtcp-rsize\r
`;if(f.mux)Y+=`a=rtcp-mux\r
`;if(f.ssrc!==void 0&&f.cname)Y+="a=ssrc:"+f.ssrc+" cname:"+f.cname+`\r
`;return Y};h.parseMsid=function(f){let Y,K=h.matchPrefix(f,"a=msid:");if(K.length===1)return Y=K[0].substring(7).split(" "),{stream:Y[0],track:Y[1]};let A=h.matchPrefix(f,"a=ssrc:").map((L)=>h.parseSsrcMedia(L)).filter((L)=>L.attribute==="msid");if(A.length>0)return Y=A[0].value.split(" "),{stream:Y[0],track:Y[1]}};h.parseSctpDescription=function(f){let Y=h.parseMLine(f),K=h.matchPrefix(f,"a=max-message-size:"),A;if(K.length>0)A=parseInt(K[0].substring(19),10);if(isNaN(A))A=65536;let L=h.matchPrefix(f,"a=sctp-port:");if(L.length>0)return{port:parseInt(L[0].substring(12),10),protocol:Y.fmt,maxMessageSize:A};let z=h.matchPrefix(f,"a=sctpmap:");if(z.length>0){let X=z[0].substring(10).split(" ");return{port:parseInt(X[0],10),protocol:X[1],maxMessageSize:A}}};h.writeSctpDescription=function(f,Y){let K=[];if(f.protocol!=="DTLS/SCTP")K=["m="+f.kind+" 9 "+f.protocol+" "+Y.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+Y.port+`\r
`];else K=["m="+f.kind+" 9 "+f.protocol+" "+Y.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+Y.port+" "+Y.protocol+` 65535\r
`];if(Y.maxMessageSize!==void 0)K.push("a=max-message-size:"+Y.maxMessageSize+`\r
`);return K.join("")};h.generateSessionId=function(){return Math.random().toString().substr(2,22)};h.writeSessionBoilerplate=function(f,Y,K){let A,L=Y!==void 0?Y:2;if(f)A=f;else A=h.generateSessionId();return`v=0\r
o=`+(K||"thisisadapterortc")+" "+A+" "+L+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`};h.getDirection=function(f,Y){let K=h.splitLines(f);for(let A=0;A<K.length;A++)switch(K[A]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return K[A].substring(2);default:}if(Y)return h.getDirection(Y);return"sendrecv"};h.getKind=function(f){return h.splitLines(f)[0].split(" ")[0].substring(2)};h.isRejected=function(f){return f.split(" ",2)[1]==="0"};h.parseMLine=function(f){let K=h.splitLines(f)[0].substring(2).split(" ");return{kind:K[0],port:parseInt(K[1],10),protocol:K[2],fmt:K.slice(3).join(" ")}};h.parseOLine=function(f){let K=h.matchPrefix(f,"o=")[0].substring(2).split(" ");return{username:K[0],sessionId:K[1],sessionVersion:parseInt(K[2],10),netType:K[3],addressType:K[4],address:K[5]}};h.isValidSDP=function(f){if(typeof f!=="string"||f.length===0)return!1;let Y=h.splitLines(f);for(let K=0;K<Y.length;K++)if(Y[K].length<2||Y[K].charAt(1)!=="=")return!1;return!0};if(typeof h5==="object")h5.exports=h});var F3=(()=>{for(var f=new Uint8Array(128),Y=0;Y<64;Y++)f[Y<26?Y+65:Y<52?Y+71:Y<62?Y-4:Y*4-205]=Y;return(K)=>{for(var A=K.length,L=new Uint8Array((A-(K[A-1]=="=")-(K[A-2]=="="))*3/4|0),z=0,X=0;z<A;){var I=f[K.charCodeAt(z++)],J=f[K.charCodeAt(z++)],H=f[K.charCodeAt(z++)],Z=f[K.charCodeAt(z++)];L[X++]=I<<2|J>>4,L[X++]=J<<4|H>>2,L[X++]=H<<6|Z}return L}})(),E3={name:"kaplay",description:"KAPLAY is a JavaScript & TypeScript game library that helps you make games fast and fun! (formerly known as Kaboom.js)",version:"3001.0.18",license:"MIT",homepage:"https://kaplayjs.com/",bugs:{url:"https://github.com/kaplayjs/kaplay/issues"},funding:{type:"opencollective",url:"https://opencollective.com/kaplay"},repository:{type:"git",url:"git+https://github.com/kaplayjs/kaplay.git"},type:"module",main:"./dist/kaplay.cjs",module:"./dist/kaplay.mjs",types:"./dist/doc.d.ts",readme:"./README.md",exports:{".":{import:{types:"./dist/doc.d.ts",default:"./dist/kaplay.mjs"},require:{types:"./dist/doc.d.ts",default:"./dist/kaplay.cjs"}},"./global":"./dist/declaration/global.js"},typesVersions:{"*":{global:["./dist/declaration/global.d.ts"]}},keywords:["game development","javascript","typescript","game engine","2d games","physics engine","webgl","canvas","game library","kaplay","kaboom","kaboomjs","kaboom.js"],files:["dist/","kaplay.webp","CHANGELOG.md"],scripts:{dev:"NODE_ENV=development node scripts/dev.js","win:dev":"set NODE_ENV=development && node scripts/dev.js",build:"node scripts/generateIndex.js && npm run doc-dts && node scripts/build.js","build:fast":"node scripts/buildFast.js",check:"tsc",fmt:"dprint fmt",test:"node scripts/test.js","doc-dts":"dts-bundle-generator -o dist/doc.d.ts src/index.ts","test:vite":"vitest --typecheck",desktop:"tauri dev",prepare:"npm run build","publish:next":"npm publish --tag next"},devDependencies:{"@kaplayjs/dprint-config":"^1.2.0","@types/jest":"^29.5.14",dprint:"^0.49.1","dts-bundle-generator":"^9.5.1",ejs:"^3.1.10",esbuild:"^0.25.2",express:"^5.1.0",puppeteer:"^22.15.0","tar-fs":"3.0.8",typescript:"5.6.3",vite:"5.4.16",vitest:"^3.1.1","vitest-environment-puppeteer":"^11.0.3","vitest-puppeteer":"^11.0.3"},engines:{node:">=20.0.0"},packageManager:"pnpm@9.9.0+sha512.60c18acd138bff695d339be6ad13f7e936eea6745660d4cc4a776d5247c540d0edee1a563695c183a66eb917ef88f2b4feb1fc25f32a7adcadc7aaf3438e99c1"};function af(f,Y,K){return Y>K?af(f,K,Y):Math.min(Math.max(f,Y),K)}var a=class f{r=255;g=255;b=255;constructor(Y,K,A){this.r=af(Y,0,255),this.g=af(K,0,255),this.b=af(A,0,255)}static fromArray(Y){return new f(Y[0],Y[1],Y[2])}static fromHex(Y){if(typeof Y=="number")return new f(Y>>16&255,Y>>8&255,Y>>0&255);if(typeof Y=="string"){let K=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(Y);if(!K)throw new Error("Invalid hex color format");return new f(parseInt(K[1],16),parseInt(K[2],16),parseInt(K[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(Y,K,A){if(K==0)return new f(255*A,255*A,255*A);let L=(Z,Q,q)=>(q<0&&(q+=1),q>1&&(q-=1),q<0.16666666666666666?Z+(Q-Z)*6*q:q<0.5?Q:q<0.6666666666666666?Z+(Q-Z)*(0.6666666666666666-q)*6:Z),z=A<0.5?A*(1+K):A+K-A*K,X=2*A-z,I=L(X,z,Y+0.3333333333333333),J=L(X,z,Y),H=L(X,z,Y-0.3333333333333333);return new f(Math.round(I*255),Math.round(J*255),Math.round(H*255))}static RED=new f(255,0,0);static GREEN=new f(0,255,0);static BLUE=new f(0,0,255);static YELLOW=new f(255,255,0);static MAGENTA=new f(255,0,255);static CYAN=new f(0,255,255);static WHITE=new f(255,255,255);static BLACK=new f(0,0,0);clone(){return new f(this.r,this.g,this.b)}lighten(Y){return new f(this.r+Y,this.g+Y,this.b+Y)}darken(Y){return this.lighten(-Y)}invert(){return new f(255-this.r,255-this.g,255-this.b)}mult(Y){return new f(this.r*Y.r/255,this.g*Y.g/255,this.b*Y.b/255)}lerp(Y,K){return new f(hf(this.r,Y.r,K),hf(this.g,Y.g,K),hf(this.b,Y.b,K))}toHSL(){let Y=this.r/255,K=this.g/255,A=this.b/255,L=Math.max(Y,K,A),z=Math.min(Y,K,A),X=(L+z)/2,I=X,J=X;if(L==z)X=I=0;else{let H=L-z;switch(I=J>0.5?H/(2-L-z):H/(L+z),L){case Y:X=(K-A)/H+(K<A?6:0);break;case K:X=(A-Y)/H+2;break;case A:X=(Y-K)/H+4;break}X/=6}return[X,I,J]}eq(Y){return this.r===Y.r&&this.g===Y.g&&this.b===Y.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+(16777216+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function ff(...f){if(f.length===0)return new a(255,255,255);if(f.length===1){if(f[0]instanceof a)return f[0].clone();if(typeof f[0]=="string")return a.fromHex(f[0]);if(Array.isArray(f[0])&&f[0].length===3)return a.fromArray(f[0])}else if(f.length===2){if(f[0]instanceof a)return f[0].clone()}else if(f.length===3||f.length===4)return new a(f[0],f[1],f[2]);throw new Error("Invalid color arguments")}var C3=(f,Y,K)=>a.fromHSL(f,Y,K);function Qf(f){return f*Math.PI/180}function G2(f){return f*180/Math.PI}function hf(f,Y,K){if(typeof f=="number"&&typeof Y=="number")return f+(Y-f)*K;if(f instanceof E&&Y instanceof E)return f.lerp(Y,K);if(f instanceof a&&Y instanceof a)return f.lerp(Y,K);throw new Error(`Bad value for lerp(): ${f}, ${Y}. Only number, Vec2 and Color is supported.`)}function df(f,Y,K,A,L){return A+(f-Y)/(K-Y)*(L-A)}function M3(f,Y,K,A,L){return af(df(f,Y,K,A,L),A,L)}var E=class f{x=0;y=0;constructor(Y=0,K=Y){this.x=Y,this.y=K}static fromAngle(Y){let K=Qf(Y);return new f(Math.cos(K),Math.sin(K))}static fromArray(Y){return new f(Y[0],Y[1])}static ZERO=new f(0,0);static ONE=new f(1,1);static LEFT=new f(-1,0);static RIGHT=new f(1,0);static UP=new f(0,-1);static DOWN=new f(0,1);clone(){return new f(this.x,this.y)}add(...Y){let K=y(...Y);return new f(this.x+K.x,this.y+K.y)}sub(...Y){let K=y(...Y);return new f(this.x-K.x,this.y-K.y)}scale(...Y){let K=y(...Y);return new f(this.x*K.x,this.y*K.y)}dist(...Y){let K=y(...Y);return this.sub(K).len()}sdist(...Y){let K=y(...Y);return this.sub(K).slen()}static sdist(Y,K){let A=Y.x-K.x,L=Y.y-K.y;return A*A+L*L}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let Y=this.len();return Y===0?new f(0):this.scale(1/Y)}normal(){return new f(this.y,-this.x)}reflect(Y){return this.sub(Y.scale(2*this.dot(Y)))}project(Y){return Y.scale(Y.dot(this)/Y.len())}reject(Y){return this.sub(this.project(Y))}dot(Y){return this.x*Y.x+this.y*Y.y}static dot(Y,K){return Y.x*K.x+Y.y*K.y}cross(Y){return this.x*Y.y-this.y*Y.x}static cross(Y,K){return Y.x*K.y-Y.y*K.x}angle(...Y){let K=y(...Y);return G2(Math.atan2(this.y-K.y,this.x-K.x))}angleBetween(...Y){let K=y(...Y);return G2(Math.atan2(this.cross(K),this.dot(K)))}lerp(Y,K){return new f(hf(this.x,Y.x,K),hf(this.y,Y.y,K))}slerp(Y,K){let A=this.dot(Y),L=this.cross(Y),z=Math.atan2(L,A);return this.scale(Math.sin((1-K)*z)).add(Y.scale(Math.sin(K*z))).scale(1/L)}isZero(){return this.x===0&&this.y===0}toFixed(Y){return new f(Number(this.x.toFixed(Y)),Number(this.y.toFixed(Y)))}transform(Y){return Y.multVec2(this)}eq(Y){return this.x===Y.x&&this.y===Y.y}bbox(){return new Af(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function y(...f){if(f.length===1){if(f[0]instanceof E)return new E(f[0].x,f[0].y);if(Array.isArray(f[0])&&f[0].length===2)return new E(...f[0])}return new E(...f)}var Xf=class f{x=0;y=0;w=1;h=1;constructor(Y,K,A,L){this.x=Y,this.y=K,this.w=A,this.h=L}scale(Y){return new f(this.x+this.w*Y.x,this.y+this.h*Y.y,this.w*Y.w,this.h*Y.h)}pos(){return new E(this.x,this.y)}clone(){return new f(this.x,this.y,this.w,this.h)}eq(Y){return this.x===Y.x&&this.y===Y.y&&this.w===Y.w&&this.h===Y.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function $f(f,Y,K,A){return new Xf(f,Y,K,A)}var x0=class f{a;b;c;d;constructor(Y,K,A,L){this.a=Y,this.b=K,this.c=A,this.d=L}mul(Y){return new f(this.a*Y.a+this.b*Y.c,this.a*Y.b+this.b*Y.d,this.c*Y.a+this.d*Y.c,this.c*Y.b+this.d*Y.d)}transform(Y){return y(this.a*Y.x+this.b*Y.y,this.c*Y.x+this.d*Y.y)}get inverse(){let Y=this.det;return new f(this.d/Y,-this.b/Y,-this.c/Y,this.a/Y)}get transpose(){return new f(this.a,this.c,this.b,this.d)}get eigenvalues(){let Y=this.trace/2,K=this.det,A=Y+Math.sqrt(Y*Y-K),L=Y-Math.sqrt(Y*Y-K);return[A,L]}eigenvectors(Y,K){return this.c!=0?[[Y-this.d,this.c],[K-this.d,this.c]]:this.b!=0?[[this.b,Y-this.a],[this.b,K-this.a]]:Math.abs(this.transform(y(1,0)).x-Y)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(Y){let K=Math.cos(Y),A=Math.sin(Y);return new f(K,A,-A,K)}static scale(Y,K){return new f(Y,0,0,K)}},o2=class f{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(Y,K,A,L,z,X,I,J,H){this.m11=Y,this.m12=K,this.m13=A,this.m21=L,this.m22=z,this.m23=X,this.m31=I,this.m32=J,this.m33=H}static fromMat2(Y){return new f(Y.a,Y.b,0,Y.c,Y.d,0,0,0,1)}toMat2(){return new x0(this.m11,this.m12,this.m21,this.m22)}mul(Y){return new f(this.m11*Y.m11+this.m12*Y.m21+this.m13*Y.m31,this.m11*Y.m12+this.m12*Y.m22+this.m13*Y.m32,this.m11*Y.m13+this.m12*Y.m23+this.m13*Y.m33,this.m21*Y.m11+this.m22*Y.m21+this.m23*Y.m31,this.m21*Y.m12+this.m22*Y.m22+this.m23*Y.m32,this.m21*Y.m13+this.m22*Y.m23+this.m23*Y.m33,this.m31*Y.m11+this.m32*Y.m21+this.m33*Y.m31,this.m31*Y.m12+this.m32*Y.m22+this.m33*Y.m32,this.m31*Y.m13+this.m32*Y.m23+this.m33*Y.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(Y){let K=Math.cos(Y),A=Math.sin(Y),L=this.m11,z=this.m12;return this.m11=K*this.m11+A*this.m21,this.m12=K*this.m12+A*this.m22,this.m21=K*this.m21-A*L,this.m22=K*this.m22-A*z,this}scale(Y,K){return this.m11*=Y,this.m12*=Y,this.m21*=K,this.m22*=K,this}get inverse(){let Y=this.det;return new f((this.m22*this.m33-this.m23*this.m32)/Y,(this.m13*this.m32-this.m12*this.m33)/Y,(this.m12*this.m23-this.m13*this.m22)/Y,(this.m23*this.m31-this.m21*this.m33)/Y,(this.m11*this.m33-this.m13*this.m31)/Y,(this.m13*this.m21-this.m11*this.m23)/Y,(this.m21*this.m32-this.m22*this.m31)/Y,(this.m12*this.m31-this.m11*this.m32)/Y,(this.m11*this.m22-this.m12*this.m21)/Y)}get transpose(){return new f(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},wf=class f{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(Y){Y&&(this.m=Y)}static translate(Y){return new f([1,0,0,0,0,1,0,0,0,0,1,0,Y.x,Y.y,0,1])}static scale(Y){return new f([Y.x,0,0,0,0,Y.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(Y){Y=Qf(-Y);let K=Math.cos(Y),A=Math.sin(Y);return new f([1,0,0,0,0,K,-A,0,0,A,K,0,0,0,0,1])}static rotateY(Y){Y=Qf(-Y);let K=Math.cos(Y),A=Math.sin(Y);return new f([K,0,A,0,0,1,0,0,-A,0,K,0,0,0,0,1])}static rotateZ(Y){Y=Qf(-Y);let K=Math.cos(Y),A=Math.sin(Y);return new f([K,-A,0,0,A,K,0,0,0,0,1,0,0,0,0,1])}translate(Y){return this.m[12]+=this.m[0]*Y.x+this.m[4]*Y.y,this.m[13]+=this.m[1]*Y.x+this.m[5]*Y.y,this.m[14]+=this.m[2]*Y.x+this.m[6]*Y.y,this.m[15]+=this.m[3]*Y.x+this.m[7]*Y.y,this}scale(Y){return this.m[0]*=Y.x,this.m[4]*=Y.y,this.m[1]*=Y.x,this.m[5]*=Y.y,this.m[2]*=Y.x,this.m[6]*=Y.y,this.m[3]*=Y.x,this.m[7]*=Y.y,this}rotate(Y){Y=Qf(-Y);let K=Math.cos(Y),A=Math.sin(Y),L=this.m[0],z=this.m[1],X=this.m[4],I=this.m[5];return this.m[0]=L*K+z*A,this.m[1]=-L*A+z*K,this.m[4]=X*K+I*A,this.m[5]=-X*A+I*K,this}mult(Y){let K=[];for(let A=0;A<4;A++)for(let L=0;L<4;L++)K[A*4+L]=this.m[0+L]*Y.m[A*4+0]+this.m[4+L]*Y.m[A*4+1]+this.m[8+L]*Y.m[A*4+2]+this.m[12+L]*Y.m[A*4+3];return new f(K)}multVec2(Y){return new E(Y.x*this.m[0]+Y.y*this.m[4]+this.m[12],Y.x*this.m[1]+Y.y*this.m[5]+this.m[13])}getTranslation(){return new E(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let Y=this.m[0]*this.m[5]-this.m[1]*this.m[4],K=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new E(K,Y/K)}else if(this.m[4]!=0||this.m[5]!=0){let Y=this.m[0]*this.m[5]-this.m[1]*this.m[4],K=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new E(Y/K,K)}else return new E(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let Y=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return G2(this.m[1]>0?Math.acos(this.m[0]/Y):-Math.acos(this.m[0]/Y))}else if(this.m[4]!=0||this.m[5]!=0){let Y=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return G2(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/Y):-Math.acos(this.m[4]/Y)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let Y=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new E(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(Y*Y),0)}else if(this.m[4]!=0||this.m[5]!=0){let Y=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new E(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(Y*Y))}else return new E(0,0)}invert(){let Y=[],K=this.m[10]*this.m[15]-this.m[14]*this.m[11],A=this.m[9]*this.m[15]-this.m[13]*this.m[11],L=this.m[9]*this.m[14]-this.m[13]*this.m[10],z=this.m[8]*this.m[15]-this.m[12]*this.m[11],X=this.m[8]*this.m[14]-this.m[12]*this.m[10],I=this.m[8]*this.m[13]-this.m[12]*this.m[9],J=this.m[6]*this.m[15]-this.m[14]*this.m[7],H=this.m[5]*this.m[15]-this.m[13]*this.m[7],Z=this.m[5]*this.m[14]-this.m[13]*this.m[6],Q=this.m[4]*this.m[15]-this.m[12]*this.m[7],q=this.m[4]*this.m[14]-this.m[12]*this.m[6],V=this.m[5]*this.m[15]-this.m[13]*this.m[7],W=this.m[4]*this.m[13]-this.m[12]*this.m[5],N=this.m[6]*this.m[11]-this.m[10]*this.m[7],_=this.m[5]*this.m[11]-this.m[9]*this.m[7],j=this.m[5]*this.m[10]-this.m[9]*this.m[6],M=this.m[4]*this.m[11]-this.m[8]*this.m[7],U=this.m[4]*this.m[10]-this.m[8]*this.m[6],D=this.m[4]*this.m[9]-this.m[8]*this.m[5];Y[0]=this.m[5]*K-this.m[6]*A+this.m[7]*L,Y[4]=-(this.m[4]*K-this.m[6]*z+this.m[7]*X),Y[8]=this.m[4]*A-this.m[5]*z+this.m[7]*I,Y[12]=-(this.m[4]*L-this.m[5]*X+this.m[6]*I),Y[1]=-(this.m[1]*K-this.m[2]*A+this.m[3]*L),Y[5]=this.m[0]*K-this.m[2]*z+this.m[3]*X,Y[9]=-(this.m[0]*A-this.m[1]*z+this.m[3]*I),Y[13]=this.m[0]*L-this.m[1]*X+this.m[2]*I,Y[2]=this.m[1]*J-this.m[2]*H+this.m[3]*Z,Y[6]=-(this.m[0]*J-this.m[2]*Q+this.m[3]*q),Y[10]=this.m[0]*V-this.m[1]*Q+this.m[3]*W,Y[14]=-(this.m[0]*Z-this.m[1]*q+this.m[2]*W),Y[3]=-(this.m[1]*N-this.m[2]*_+this.m[3]*j),Y[7]=this.m[0]*N-this.m[2]*M+this.m[3]*U,Y[11]=-(this.m[0]*_-this.m[1]*M+this.m[3]*D),Y[15]=this.m[0]*j-this.m[1]*U+this.m[2]*D;let C=this.m[0]*Y[0]+this.m[1]*Y[4]+this.m[2]*Y[8]+this.m[3]*Y[12];for(let R=0;R<4;R++)for(let G=0;G<4;G++)Y[R*4+G]*=1/C;return new f(Y)}clone(){return new f([...this.m])}toString(){return this.m.toString()}};function VY(f,Y,K,A=(L)=>-Math.cos(L)){return f+(A(K)+1)/2*(Y-f)}var O3=1103515245,x3=12345,e5=2147483648,WY=class{seed;constructor(f){this.seed=f}gen(){return this.seed=(O3*this.seed+x3)%e5,this.seed/e5}genNumber(f,Y){return f+this.gen()*(Y-f)}genVec2(f,Y){return new E(this.genNumber(f.x,Y.x),this.genNumber(f.y,Y.y))}genColor(f,Y){return new a(this.genNumber(f.r,Y.r),this.genNumber(f.g,Y.g),this.genNumber(f.b,Y.b))}genAny(...f){if(f.length===0)return this.gen();if(f.length===1){if(typeof f[0]=="number")return this.genNumber(0,f[0]);if(f[0]instanceof E)return this.genVec2(y(0,0),f[0]);if(f[0]instanceof a)return this.genColor(ff(0,0,0),f[0])}else if(f.length===2){if(typeof f[0]=="number"&&typeof f[1]=="number")return this.genNumber(f[0],f[1]);if(f[0]instanceof E&&f[1]instanceof E)return this.genVec2(f[0],f[1]);if(f[0]instanceof a&&f[1]instanceof a)return this.genColor(f[0],f[1])}throw new Error("More than 2 arguments not supported")}},N1=new WY(Date.now());function U3(f){return f!=null&&(N1.seed=f),N1.seed}function Bf(...f){return N1.genAny(...f)}function BY(...f){return Math.floor(Bf(...f.length>0?f:[2]))}function h3(f){return Bf()<=f}function _Y(f){for(let Y=f.length-1;Y>0;Y--){let K=Math.floor(Math.random()*(Y+1));[f[Y],f[K]]=[f[K],f[Y]]}return f}function P3(f,Y){return f.length<=Y?f.slice():_Y(f.slice()).slice(0,Y)}function T3(f){return f[BY(f.length)]}function jY(f,Y){return f.pos.x+f.width>Y.pos.x&&f.pos.x<Y.pos.x+Y.width&&f.pos.y+f.height>Y.pos.y&&f.pos.y<Y.pos.y+Y.height}function D3(f,Y){if(f.p1.x===f.p2.x&&f.p1.y===f.p2.y||Y.p1.x===Y.p2.x&&Y.p1.y===Y.p2.y)return null;let K=(Y.p2.y-Y.p1.y)*(f.p2.x-f.p1.x)-(Y.p2.x-Y.p1.x)*(f.p2.y-f.p1.y);if(K===0)return null;let A=((Y.p2.x-Y.p1.x)*(f.p1.y-Y.p1.y)-(Y.p2.y-Y.p1.y)*(f.p1.x-Y.p1.x))/K,L=((f.p2.x-f.p1.x)*(f.p1.y-Y.p1.y)-(f.p2.y-f.p1.y)*(f.p1.x-Y.p1.x))/K;return A<0||A>1||L<0||L>1?null:A}function u1(f,Y){let K=D3(f,Y);return K?y(f.p1.x+K*(f.p2.x-f.p1.x),f.p1.y+K*(f.p2.y-f.p1.y)):null}function v1(f,Y){let K=Y.p2.sub(Y.p1),A=Number.NEGATIVE_INFINITY,L=Number.POSITIVE_INFINITY;if(K.x!=0){let z=(f.pos.x-Y.p1.x)/K.x,X=(f.pos.x+f.width-Y.p1.x)/K.x;A=Math.max(A,Math.min(z,X)),L=Math.min(L,Math.max(z,X))}if(K.y!=0){let z=(f.pos.y-Y.p1.y)/K.y,X=(f.pos.y+f.height-Y.p1.y)/K.y;A=Math.max(A,Math.min(z,X)),L=Math.min(L,Math.max(z,X))}return L>=A&&L>=0&&A<=1}function S0(f,Y){return Y.x>f.pos.x&&Y.x<f.pos.x+f.width&&Y.y>f.pos.y&&Y.y<f.pos.y+f.height}function RY(f,Y){let K=Math.max(f.pos.x,Math.min(Y.center.x,f.pos.x+f.width)),A=Math.max(f.pos.y,Math.min(Y.center.y,f.pos.y+f.height));return y(K,A).sdist(Y.center)<=Y.radius*Y.radius}function NY(f,Y){return GY(Y,new Ef(f.points()))}function S1(f,Y){let K=Y.sub(f.p1),A=f.p2.sub(f.p1);if(Math.abs(K.cross(A))>Number.EPSILON)return!1;let L=K.dot(A)/A.dot(A);return L>=0&&L<=1}function H0(f,Y){let K=f.p2.sub(f.p1),A=K.dot(K),L=f.p1.sub(Y.center),z=2*K.dot(L),X=L.dot(L)-Y.radius*Y.radius,I=z*z-4*A*X;if(A<=Number.EPSILON||I<0)return!1;if(I==0){let J=-z/(2*A);if(J>=0&&J<=1)return!0}else{let J=(-z+Math.sqrt(I))/(2*A),H=(-z-Math.sqrt(I))/(2*A);if(J>=0&&J<=1||H>=0&&H<=1)return!0}return p0(Y,f.p1)}function p1(f,Y){if(Z2(Y,f.p1)||Z2(Y,f.p2))return!0;for(let K=0;K<Y.pts.length;K++){let A=Y.pts[K],L=Y.pts[(K+1)%Y.pts.length];if(u1(f,new Tf(A,L)))return!0}return!1}function p0(f,Y){return f.center.sdist(Y)<f.radius*f.radius}function g3(f,Y){return f.center.sdist(Y.center)<(f.radius+Y.radius)*(f.radius+Y.radius)}function l0(f,Y){let K=Y.pts[Y.pts.length-1];for(let A of Y.pts){if(H0(new Tf(K,A),f))return!0;K=A}return p0(f,Y.pts[0])?!0:Z2(Y,f.center)}function GY(f,Y){for(let K=0;K<f.pts.length;K++)if(p1(new Tf(f.pts[K],f.pts[(K+1)%f.pts.length]),Y))return!0;return!!(f.pts.some((K)=>Z2(Y,K))||Y.pts.some((K)=>Z2(f,K)))}function Z2(f,Y){let K=!1,A=f.pts;for(let L=0,z=A.length-1;L<A.length;z=L++)A[L].y>Y.y!=A[z].y>Y.y&&Y.x<(A[z].x-A[L].x)*(Y.y-A[L].y)/(A[z].y-A[L].y)+A[L].x&&(K=!K);return K}function l1(f,Y){Y=Y.sub(f.center);let K=Qf(f.angle),A=Math.cos(K),L=Math.sin(K),z=Y.x*A+Y.y*L,X=-Y.x*L+Y.y*A;return z*z/(f.radiusX*f.radiusX)+X*X/(f.radiusY*f.radiusY)<1}function U0(f,Y){let K=Y.center.sub(f.center),A=Qf(f.angle),L=Math.cos(A),z=Math.sin(A),X=K.x*L+K.y*z,I=-K.x*z+K.y*L;return l1(new K2(y(),f.radiusX+Y.radius,f.radiusY+Y.radius,0),y(X,I))}function yY(f,Y){let K=f.toMat2().inverse;return Y=new Tf(K.transform(Y.p1.sub(f.center)),K.transform(Y.p2.sub(f.center))),H0(Y,new Pf(y(),1))}function u3(f,Y){if(f.radiusX===f.radiusY)return U0(Y,new Pf(f.center,f.radiusX));if(Y.radiusX===Y.radiusY)return U0(f,new Pf(Y.center,Y.radiusX));let K=new o2(1/f.radiusX**2,0,0,0,1/f.radiusY**2,0,0,0,-1),A=new o2(1/Y.radiusX**2,0,0,0,1/Y.radiusY**2,0,0,0,-1),L=f.center.x,z=f.center.y,X=Y.center.x,I=Y.center.y,J=Qf(f.angle),H=Qf(Y.angle),Z=new o2(Math.cos(J),-Math.sin(J),L,Math.sin(J),Math.cos(J),z,0,0,1),Q=new o2(Math.cos(H),-Math.sin(H),X,Math.sin(H),Math.cos(H),I,0,0,1),q=Z.inverse,V=Q.inverse,W=q.transpose.mul(K).mul(q),N=V.transpose.mul(A).mul(V),_=W.m11,j=W.m12,M=W.m13,U=W.m21,D=W.m22,C=W.m23,R=W.m31,G=W.m32,O=W.m33,P=N.m11,T=N.m12,u=N.m13,p=N.m21,s=N.m22,d=N.m23,w=N.m31,b=N.m32,l=N.m33,Kf=_*D*O-_*C*G-j*U*O+j*C*R+M*U*G-M*D*R,o=(_*D*l-_*C*b-_*G*d+_*O*s-j*U*l+j*C*w+j*R*d-j*O*p+M*U*b-M*D*w-M*R*s+M*G*p+U*G*u-U*O*T-D*R*u+D*O*P+C*R*T-C*G*P)/Kf,t=(_*s*l-_*d*b-j*p*l+j*d*w+M*p*b-M*s*w-U*T*l+U*u*b+D*P*l-D*u*w-C*P*b+C*T*w+R*T*d-R*u*s-G*P*d+G*u*p+O*P*s-O*T*p)/Kf,Vf=(P*s*l-P*d*b-T*p*l+T*d*w+u*p*b-u*s*w)/Kf;if(o>=0){let k=-3*t+o**2,ef=3*o*Vf+t*o**2-4*t**2,L2=-27*Vf**2+18*Vf*o*t+o**2*t**2-4*o**3*Vf-4*t**3;return!(k>0&&ef<0&&L2>0)}else{let k=-3*t+o**2,ef=-27*Vf**2+18*Vf*o*t+o**2*t**2-4*o**3*Vf-4*t**3;return!(k>0&&ef>0)}}function FY(f,Y){return k1(f,new Ef(Y.points()))}function k1(f,Y){let K=f.toMat2().inverse;return Y=new Ef(Y.pts.map((A)=>K.transform(A.sub(f.center)))),l0(new Pf(y(),1),Y)}function v3(f,Y){return f.x===Y.x&&f.y===Y.y}function S3(f,Y){return Y instanceof E?v3(Y,f.pt):Y instanceof Pf?p0(Y,f.pt):Y instanceof Tf?S1(Y,f.pt):Y instanceof Af?S0(Y,f.pt):Y instanceof Ef?Z2(Y,f.pt):Y instanceof K2?l1(Y,f.pt):!1}function p3(f,Y){return Y instanceof E?S1(f,Y):Y instanceof Pf?H0(f,Y):Y instanceof Tf?u1(f,Y)!=null:Y instanceof Af?v1(Y,f):Y instanceof Ef?p1(f,Y):Y instanceof K2?yY(Y,f):!1}function l3(f,Y){return Y instanceof E?p0(f,Y):Y instanceof Pf?g3(f,Y):Y instanceof Tf?H0(Y,f):Y instanceof Af?RY(Y,f):Y instanceof Ef?l0(f,Y):Y instanceof K2?U0(Y,f):!1}function k3(f,Y){return Y instanceof E?S0(f,Y):Y instanceof Pf?RY(f,Y):Y instanceof Tf?v1(f,Y):Y instanceof Af?jY(f,Y):Y instanceof Ef?NY(f,Y):Y instanceof K2?FY(Y,f):!1}function b3(f,Y){return Y instanceof E?Z2(f,Y):Y instanceof Pf?l0(Y,f):Y instanceof Tf?p1(Y,f):Y instanceof Af?NY(Y,f):Y instanceof Ef?GY(Y,f):Y instanceof K2?k1(Y,f):!1}function m3(f,Y){return Y instanceof E?l1(f,Y):Y instanceof Pf?U0(f,Y):Y instanceof Tf?yY(f,Y):Y instanceof Af?FY(f,Y):Y instanceof Ef?k1(f,Y):Y instanceof K2?u3(Y,f):!1}function EY(f,Y,K){let A=f,L=K.p1,z=K.p2,X=Y,I=z.sub(L),J=X.cross(I);if(Math.abs(J)<Number.EPSILON)return null;let H=L.sub(A),Z=H.cross(I)/J;if(Z<=0||Z>=1)return null;let Q=H.cross(X)/J;if(Q<=0||Q>=1)return null;let q=I.normal().unit();return Y.dot(q)>0&&(q.x*=-1,q.y*=-1),{point:A.add(X.scale(Z)),normal:q,fraction:Z}}function c3(f,Y,K){let{NEGATIVE_INFINITY:A,POSITIVE_INFINITY:L}=Number,z;if(f.x!=0){let X=(K.pos.x-f.x)/Y.x,I=(K.pos.x+K.width-f.x)/Y.x;z=y(-Math.sign(Y.x),0),A=Math.max(A,Math.min(X,I)),L=Math.min(L,Math.max(X,I))}if(f.y!=0){let X=(K.pos.y-f.y)/Y.y,I=(K.pos.y+K.height-f.y)/Y.y;Math.min(X,I)>A&&(z=y(0,-Math.sign(Y.y))),A=Math.max(A,Math.min(X,I)),L=Math.min(L,Math.max(X,I))}return L>=A&&A>=0&&A<=1?{point:f.add(Y.scale(A)),normal:z,fraction:A}:null}function CY(f,Y,K){let A=f,L=K.center,z=Y,X=z.dot(z),I=A.sub(L),J=2*z.dot(I),H=I.dot(I)-K.radius*K.radius,Z=J*J-4*X*H;if(X<=Number.EPSILON||Z<0)return null;if(Z==0){let Q=-J/(2*X);if(Q>=0&&Q<=1){let q=A.add(z.scale(Q));return{point:q,normal:q.sub(L),fraction:Q}}}else{let Q=(-J+Math.sqrt(Z))/(2*X),q=(-J-Math.sqrt(Z))/(2*X),V=null;if(Q>=0&&Q<=1&&(V=Q),q>=0&&q<=1&&(V=Math.min(q,V??q)),V!=null){let W=A.add(z.scale(V));return{point:W,normal:W.sub(L).unit(),fraction:V}}}return null}function r3(f,Y,K){let A=K.pts,L=null,z=A[A.length-1];for(let X=0;X<A.length;X++){let I=A[X],J=EY(f,Y,new Tf(z,I));J&&(!L||L.fraction>J.fraction)&&(L=J),z=I}return L}function s3(f,Y,K){let A=K.toMat2(),L=A.inverse,z=L.transform(f.sub(K.center)),X=L.transform(Y),I=CY(z,X,new Pf(y(),1));if(I){let J=x0.rotation(Qf(-K.angle)),H=x0.scale(K.radiusX,K.radiusY).transform(I.point),Z=A.transform(I.point).add(K.center),Q=Z.dist(f)/Y.len();return{point:Z,normal:J.transform(y(K.radiusY**2*H.x,K.radiusX**2*H.y)).unit(),fraction:Q}}return I}function d3(f,Y,K,A=64){let L=f,z=Y.len(),X=Y.scale(1/z),I=0,J=y(Math.floor(f.x),Math.floor(f.y)),H=y(X.x>0?1:-1,X.y>0?1:-1),Z=y(Math.abs(1/X.x),Math.abs(1/X.y)),Q=y(H.x>0?J.x+1-f.x:f.x-J.x,H.y>0?J.y+1-f.y:f.y-J.y),q=y(Z.x<1/0?Z.x*Q.x:1/0,Z.y<1/0?Z.y*Q.y:1/0),V=-1;for(;I<=A;){let W=K(J);if(W===!0)return{point:L.add(X.scale(I)),normal:y(V===0?-H.x:0,V===1?-H.y:0),fraction:I/z,gridPos:J};if(W)return W;q.x<q.y?(J.x+=H.x,I=q.x,q.x+=Z.x,V=0):(J.y+=H.y,I=q.y,q.y+=Z.y,V=1)}return null}var a3=class f{pt;constructor(Y){this.pt=Y.clone()}transform(Y){return new f(Y.multVec2(this.pt))}bbox(){return new Af(this.pt,0,0)}area(){return 0}clone(){return new f(this.pt)}collides(Y){return S3(this,Y)}contains(Y){return this.pt.eq(Y)}raycast(Y,K){return null}random(){return this.pt.clone()}},Tf=class f{p1;p2;constructor(Y,K){this.p1=Y.clone(),this.p2=K.clone()}transform(Y){return new f(Y.multVec2(this.p1),Y.multVec2(this.p2))}bbox(){return Af.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new f(this.p1,this.p2)}collides(Y){return p3(this,Y)}contains(Y){return this.collides(Y)}raycast(Y,K){return EY(Y,K,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(Bf(1)))}},Af=class f{pos;width;height;constructor(Y,K,A){this.pos=Y.clone(),this.width=K,this.height=A}static fromPoints(Y,K){return new f(Y.clone(),K.x-Y.x,K.y-Y.y)}center(){return new E(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(Y){return new Ef(this.points().map((K)=>Y.multVec2(K)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new f(this.pos.clone(),this.width,this.height)}distToPoint(Y){return Math.sqrt(this.sdistToPoint(Y))}sdistToPoint(Y){let K=this.pos,A=this.pos.add(this.width,this.height),L=Math.max(K.x-Y.x,0,Y.x-A.x),z=Math.max(K.y-Y.y,0,Y.y-A.y);return L*L+z*z}collides(Y){return k3(this,Y)}contains(Y){return this.collides(Y)}raycast(Y,K){return c3(Y,K,this)}random(){return this.pos.add(Bf(this.width),Bf(this.height))}},Pf=class f{center;radius;constructor(Y,K){this.center=Y.clone(),this.radius=K}transform(Y){return new K2(this.center,this.radius,this.radius).transform(Y)}bbox(){return Af.fromPoints(this.center.sub(y(this.radius)),this.center.add(y(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new f(this.center,this.radius)}collides(Y){return l3(this,Y)}contains(Y){return this.collides(Y)}raycast(Y,K){return CY(Y,K,this)}random(){return this.center.add(E.fromAngle(Bf(360)).scale(Bf(this.radius)))}},K2=class f{center;radiusX;radiusY;angle;constructor(Y,K,A,L=0){this.center=Y.clone(),this.radiusX=K,this.radiusY=A,this.angle=L}static fromMat2(Y){let K=Y.inverse,A=K.transpose.mul(K),[L,z]=A.eigenvalues,[X,I]=A.eigenvectors(L,z),[J,H]=[1/Math.sqrt(L),1/Math.sqrt(z)];return J>H?new f(y(),J,H,G2(Math.atan2(-X[1],X[0]))):new f(y(),H,J,G2(Math.atan2(-I[1],I[0])))}toMat2(){let Y=Qf(this.angle),K=Math.cos(Y),A=Math.sin(Y);return new x0(K*this.radiusX,-A*this.radiusY,A*this.radiusX,K*this.radiusY)}transform(Y){if(this.angle==0&&Y.getRotation()==0)return new f(Y.multVec2(this.center),Y.m[0]*this.radiusX,Y.m[5]*this.radiusY);{let K=this.toMat2(),A=Y.getRotation(),L=Y.getScale();K=o2.fromMat2(K).scale(L.x,L.y).rotate(A).toMat2();let z=f.fromMat2(K);return z.center=Y.multVec2(this.center),z}}bbox(){if(this.angle==0)return Af.fromPoints(this.center.sub(y(this.radiusX,this.radiusY)),this.center.add(y(this.radiusX,this.radiusY)));{let Y=Qf(this.angle),K=Math.cos(Y),A=Math.sin(Y),L=this.radiusX*K,z=this.radiusX*A,X=this.radiusY*A,I=this.radiusY*K,J=Math.sqrt(L*L+X*X),H=Math.sqrt(z*z+I*I);return Af.fromPoints(this.center.sub(y(J,H)),this.center.add(y(J,H)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new f(this.center,this.radiusX,this.radiusY,this.angle)}collides(Y){return m3(this,Y)}contains(Y){Y=Y.sub(this.center);let K=Qf(this.angle),A=Math.cos(K),L=Math.sin(K),z=Y.x*A+Y.y*L,X=-Y.x*L+Y.y*A;return z*z/(this.radiusX*this.radiusX)+X*X/(this.radiusY*this.radiusY)<1}raycast(Y,K){return s3(Y,K,this)}random(){return this.center}};function w3(f,Y,K,A){let L=Y.sub(f),z=A.sub(K),X=L.cross(z);return X<0.00001&&X>-0.00001||(X=K.sub(f).cross(z)/X,X<0||X>1)?null:f.add(L.scale(X))}var Ef=class f{pts;constructor(Y){if(Y.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=Y}transform(Y){return new f(this.pts.map((K)=>Y.multVec2(K)))}bbox(){let Y=y(Number.MAX_VALUE),K=y(-Number.MAX_VALUE);for(let A of this.pts)Y.x=Math.min(Y.x,A.x),K.x=Math.max(K.x,A.x),Y.y=Math.min(Y.y,A.y),K.y=Math.max(K.y,A.y);return Af.fromPoints(Y,K)}area(){let Y=0,K=this.pts.length;for(let A=0;A<K;A++){let L=this.pts[A],z=this.pts[(A+1)%K];Y+=L.x*z.y*0.5,Y-=z.x*L.y*0.5}return Math.abs(Y)}clone(){return new f(this.pts.map((Y)=>Y.clone()))}collides(Y){return b3(this,Y)}contains(Y){return this.collides(Y)}raycast(Y,K){return r3(Y,K,this)}random(){return y()}cut(Y,K){let A=new Tf(Y,K),L=[],z=[],X=K.sub(Y),I=this.pts[this.pts.length-1],J=I.sub(Y),H=X.cross(J)>0;return this.pts.forEach((Z)=>{J=Z.sub(Y);let Q=X.cross(J)>0;if(H!=Q){let q=w3(I,Z,Y,K);L.push(q),z.push(q),H=Q}(Q?L:z).push(Z),I=Z}),[L.length?new f(L):null,z.length?new f(z):null]}};function o3(f,Y,K,A){let L=A*A,z=1-A,X=z*z;return f.scale(X).add(Y.scale(2*z*A)).add(K.scale(L))}function i3(f,Y,K,A){let L=1-A;return Y.sub(f).scale(2*L).add(K.sub(Y).scale(2*A))}function n3(f,Y,K,A){return K.sub(Y.scale(2)).add(f).scale(2)}function b1(f,Y,K,A,L){let z=L*L,X=z*L,I=1-L,J=I*I,H=J*I;return f.scale(H).add(Y.scale(3*J*L)).add(K.scale(3*I*z)).add(A.scale(X))}function t3(f,Y,K,A,L){let z=L*L,X=1-L,I=X*X;return Y.sub(f).scale(3*I).add(K.sub(Y).scale(6*X*L)).add(A.sub(K).scale(3*z))}function e3(f,Y,K,A,L){let z=1-L;return K.sub(Y.scale(2)).add(f).scale(6*z).add(A.sub(K.scale(2)).add(Y).scale(6*L))}function f8(f,Y,K,A,L){let z=0.5*(((-L+2)*L-1)*L),X=0.5*((3*L-5)*L*L+2),I=0.5*(((-3*L+4)*L+1)*L),J=0.5*((L-1)*L*L);return f.scale(z).add(Y.scale(X)).add(K.scale(I)).add(A.scale(J))}function Y8(f,Y,K,A,L){let z=0.5*((-3*L+4)*L-1),X=0.5*((9*L-10)*L),I=0.5*((-9*L+8)*L+1),J=0.5*((3*L-2)*L);return f.scale(z).add(Y.scale(X)).add(K.scale(I)).add(A.scale(J))}function K8(f){let Y=MY(f),K=Y(1);return(A)=>{let L=A*K,z=Y(L,!0);return f(z)}}function MY(f,Y=10,K=10){let A=[0],L=[0],z=1/(Y-1)/K,X=0,I=f(0),J=0;for(let H=1;H<Y;H++){for(let Z=0;Z<K;Z++){J+=z;let Q=f(J),q=Q.dist(I);X+=q,I=Q}A[H]=X,L[H]=J}return L[Y-1]=1,(H,Z=!1)=>{if(Z){let Q=H;if(Q<=0)return 0;if(Q>=X)return 1;let q=0;for(;A[q+1]<Q;)q++;let V=L[q],W=L[q+1],N=A[q],_=A[q+1],j=(Q-N)/(_-N);return V+(W-V)*j}else{if(H<=0)return 0;if(H>=1)return A[Y-1];let Q=0;for(;L[Q+1]<H;)Q++;let q=L[Q],V=L[Q+1],W=A[Q],N=A[Q+1],_=(H-q)/(V-q);return W+(N-W)*_}}}function J0(f,Y,K,A){let L=2*f+Y-2*A+K,z=-3*f+3*A-2*Y-K,X=Y,I=f;return(J)=>{let H=J*J,Z=H*J;return L*Z+z*H+X*J+I}}function OY(f,Y,K,A,L,z=J0){let X=z(Y.x,(1-L)*(K.x-f.x),(1-L)*(A.x-Y.x),K.x),I=z(Y.y,(1-L)*(K.y-f.y),(1-L)*(A.y-Y.y),K.y);return(J)=>new E(X(J),I(J))}function h0(f,Y,K,A,L=J0){return OY(f,Y,K,A,0.5,L)}function A8(f,Y,K,A,L=J0){return h0(A.add(f.sub(Y).scale(6)),f,A,f.add(A.sub(K).scale(6)),L)}function L8(f,Y,K,A,L,z,X,I=J0){let J=I(Y.x,0.5*(1-L)*(1+X)*(1+z)*(Y.x-f.x)+0.5*(1-L)*(1-X)*(1-z)*(K.x-Y.x),0.5*(1-L)*(1+X)*(1-z)*(K.x-Y.x)+0.5*(1-L)*(1-X)*(1+z)*(A.x-K.x),K.x),H=I(Y.y,0.5*(1-L)*(1+X)*(1+z)*(Y.y-f.y)+0.5*(1-L)*(1-X)*(1-z)*(K.y-Y.y),0.5*(1-L)*(1+X)*(1-z)*(K.y-Y.y)+0.5*(1-L)*(1-X)*(1+z)*(A.y-K.y),K.y);return(Z)=>new E(J(Z),H(Z))}function z8(f,Y,K,A){let L=2*f+Y-2*A+K,z=-3*f+3*A-2*Y+K,X=Y;return(I)=>{let J=I*I;return 3*L*J+2*z*I+X}}function a2(f){return 0<=f&&f<=1}function _1(f,Y){return Math.abs(f-Y)<=Number.EPSILON}function w2(f){return f<0?-Math.pow(-f,0.3333333333333333):Math.pow(f,0.3333333333333333)}function X8(f,Y,K,A){let L=3*f-6*Y+3*K,z=-3*f+3*Y,X=f,I=-f+3*Y-3*K+A;if(_1(I,0)){if(_1(L,0))return _1(z,0)?[]:[-X/z].filter(a2);let _=Math.sqrt(z*z-4*L*X),j=2*L;return[(_-z)/j,(-z-_)/j].filter(a2)}L/=I,z/=I,X/=I;let J=(3*z-L*L)/3,H=J/3,Z=(2*L*L*L-9*L*z+27*X)/27,Q=Z/2,q=Q*Q+H*H*H;if(q<0){let _=-J/3,j=_*_*_,M=Math.sqrt(j),U=-Z/(2*M),D=U<-1?-1:U>1?1:U,C=Math.acos(D),R=2*w2(M),G=R*Math.cos(C/3)-L/3,O=R*Math.cos((C+2*Math.PI)/3)-L/3,P=R*Math.cos((C+4*Math.PI)/3)-L/3;return[G,O,P].filter(a2)}if(q===0){let _=Q<0?w2(-Q):-w2(Q),j=2*_-L/3,M=-_-L/3;return[j,M].filter(a2)}let V=Math.sqrt(q),W=w2(V-Q),N=w2(V+Q);return[W-N-L/3].filter(a2)}function H8(f,Y,K,A,L){let z=X8(f.x-L,Y.x-L,K.x-L,A.x-L);return z.length>0?b1(f,Y,K,A,z[0]).y:NaN}function J8(f){if(!f||f.length==0)throw new Error("Need at least one point for easingLinear.");let Y=f.length;return(K)=>{if(K<=0||f.length==1||K<=f[0].x)return f[0].y;for(let A=0;A<Y;A++)if(f[A].x>=K)return df(K,f[A-1].x,f[A].x,f[A-1].y,f[A].y);return f[f.length-1].y}}function I8(f,Y){return(K)=>H8(y(0,0),f,Y,y(1,1),K)}function Z8(f,Y="jump-end"){let K=1/f,A=Y=="jump-start"||Y=="jump-both",L=Y=="jump-end"||Y=="jump-both",z=1/(f+(L?1:0)),X=A?z:0;return(I)=>{let J=Math.floor(I/K);return X+J*z}}function q8(f,Y){let K=Number.MAX_VALUE,A={normal:y(0),distance:0};for(let L of[f,Y])for(let z=0;z<L.pts.length;z++){let X=L.pts[z],I=L.pts[(z+1)%L.pts.length].sub(X).normal().unit(),J=Number.MAX_VALUE,H=-Number.MAX_VALUE;for(let V=0;V<f.pts.length;V++){let W=f.pts[V].dot(I);J=Math.min(J,W),H=Math.max(H,W)}let Z=Number.MAX_VALUE,Q=-Number.MAX_VALUE;for(let V=0;V<Y.pts.length;V++){let W=Y.pts[V].dot(I);Z=Math.min(Z,W),Q=Math.max(Q,W)}let q=Math.min(H,Q)-Math.max(J,Z);if(q<0)return null;if(q<Math.abs(K)){let V=Q-J,W=Z-H;K=Math.abs(V)<Math.abs(W)?V:W,A.normal=I,A.distance=K}}return A}function xY(f,Y,K){return(Y.x-f.x)*(K.y-f.y)-(Y.y-f.y)*(K.x-f.x)>=0}function $8(f){let Y=0,K=f[f.length-1];for(let A=0;A<f.length;A++)Y+=(f[A].x-K.x)*(f[A].y+K.y),K=f[A];return Y<0}function j1(f,Y,K,A){let L=A.x-K.x,z=A.y-K.y,X=L*(f.y-K.y)-z*(f.x-K.x),I=L*(Y.y-K.y)-z*(Y.x-K.x);return X*I>=0}function Q8(f,Y,K,A){return j1(f,Y,K,A)&&j1(f,K,Y,A)&&j1(f,A,Y,K)}function V8(f,Y,K,A){for(let L of f)if(L!==Y&&L!==K&&L!==A&&Q8(L,Y,K,A))return!0;return!1}function W8(f,Y,K,A){return xY(f,Y,K)&&!V8(A,f,Y,K)}function UY(f){if(f.length<3)return[];if(f.length==3)return[f];let Y=[],K=[],A=0;for(let Q=0;Q<f.length;Q++){let q=f[A],V=f[Q];(V.x<q.x||V.x==q.x&&V.y<q.y)&&(A=A),Y[Q]=Q+1,K[Q]=Q-1}Y[Y.length-1]=0,K[0]=K.length-1,$8(f)||([Y,K]=[K,Y]);let L=[];for(let Q=0;Q<f.length;++Q)xY(f[K[Q]],f[Q],f[Y[Q]])||L.push(f[Q]);let z=[],X=f.length,I=1,J=0,H,Z;for(;X>3;){H=Y[I],Z=K[I];let Q=f[Z],q=f[I],V=f[H];if(W8(Q,q,V,L))z.push([Q,q,V]),Y[Z]=H,K[H]=Z,L.splice(L.indexOf(q),1),--X,J=0;else if(++J>X)return[];I=H}return H=Y[I],Z=K[I],z.push([f[Z],f[I],f[H]]),z}function B8(f){if(f.length<3)return!1;let Y=f.length-2,K=f.length-1,A=0,L=f[K].sub(f[Y]),z=f[A].sub(f[K]),X=L.cross(z);for(;A+1<f.length;)if(Y=K,K=A,A++,L=f[K].sub(f[Y]),z=f[A].sub(f[K]),L.cross(z)*X<0)return!1;return!0}var hY=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",k0="topleft",_8="monospace",P0="monospace",G1="linear",m1=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],j8=m1.reduce((f,Y)=>f+Y.size,0),PY=2048,R8=PY*4*j8,N8=PY*6,G8=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,y8=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,y1=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,F1=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,F8=new Set(["id","require"]),E8=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),fY=200,C8=640,M8=65536,TY=Symbol.for("kaplay.cancel"),DY=class extends Map{lastID=0;push(f){let Y=this.lastID;return this.set(Y,f),this.lastID++,Y}pushd(f){let Y=this.push(f);return()=>this.delete(Y)}},M2=class f{paused=!1;cancel;constructor(Y){this.cancel=Y}static join(Y){let K=new f(()=>Y.forEach((A)=>A.cancel()));return Object.defineProperty(K,"paused",{get:()=>Y[0].paused,set:(A)=>Y.forEach((L)=>L.paused=A)}),K.paused=!1,K}static replace(Y,K){return Y.cancel=()=>K.cancel(),K.paused=Y.paused,Object.defineProperty(Y,"paused",{get:()=>K.paused,set:(A)=>K.paused=A}),Y}},Ff=class{cancellers=new WeakMap;handlers=new DY;add(f){function Y(...L){if(!A.paused)return f(...L)}let K=this.handlers.pushd(Y),A=new M2(K);return this.cancellers.set(Y,K),A}addOnce(f){let Y=this.add((...K)=>{Y.cancel(),f(...K)});return Y}next(){return new Promise((f)=>this.addOnce(f))}trigger(...f){this.handlers.forEach((Y)=>{let K=Y(...f),A;K===TY&&(A=this.cancellers.get(Y))&&A()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},K0=class{handlers={};registers={};on(f,Y){return this.handlers[f]||(this.handlers[f]=new Ff),this.handlers[f].add(Y)}onOnce(f,Y){let K=this.on(f,(...A)=>{K.cancel(),Y(...A)});return K}next(f){return new Promise((Y)=>{this.onOnce(f,(...K)=>Y(K[0]))})}trigger(f,...Y){this.handlers[f]&&this.handlers[f].trigger(...Y)}remove(f){delete this.handlers[f]}clear(){this.handlers={}}numListeners(f){return this.handlers[f]?.numListeners()??0}},O8=(f)=>f[0]instanceof a,x8=(f)=>f[0]instanceof E,U8=(f)=>typeof f[0]=="number",gY=class{_items;_compareFn;constructor(f=(Y,K)=>Y<K){this._compareFn=f,this._items=[]}insert(f){this._items.push(f),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let f=this._items[0],Y=this._items.pop();return this._items.length!==0&&(this._items[0]=Y,this.moveDown(0)),f}clear(){this._items.splice(0,this._items.length)}moveUp(f){for(;f>0;){let Y=Math.floor((f-1)/2);if(!this._compareFn(this._items[f],this._items[Y])&&this._items[f]>=this._items[Y])break;this.swap(f,Y),f=Y}}moveDown(f){for(;f<Math.floor(this._items.length/2);){let Y=2*f+1;if(Y<this._items.length-1&&!this._compareFn(this._items[Y],this._items[Y+1])&&++Y,this._compareFn(this._items[f],this._items[Y]))break;this.swap(f,Y),f=Y}}swap(f,Y){[this._items[f],this._items[Y]]=[this._items[Y],this._items[f]]}get length(){return this._items.length}};function h8(f){let Y=window.atob(f),K=Y.length,A=new Uint8Array(K);for(let L=0;L<K;L++)A[L]=Y.charCodeAt(L);return A.buffer}function P8(f){return h8(f.split(",")[1])}function c1(f,Y){let K=document.createElement("a");K.href=Y,K.download=f,K.click()}function uY(f,Y){c1(f,"data:text/plain;charset=utf-8,"+Y)}function T8(f,Y){uY(f,JSON.stringify(Y))}function YY(f,Y){let K=URL.createObjectURL(Y);c1(f,K),URL.revokeObjectURL(K)}var vY=(f)=>f.match(/^data:\w+\/\w+;base64,.+/),D8=(f)=>f.split(".").slice(0,-1).join(".");function r1(f,Y){if(f===Y)return!0;let K=typeof f,A=typeof Y;if(K!==A)return!1;if(K==="object"&&A==="object"&&f!==null&&Y!==null){if(Array.isArray(f)!==Array.isArray(Y))return!1;let L=Object.keys(f),z=Object.keys(Y);if(L.length!==z.length)return!1;for(let X of L){let I=f[X],J=Y[X];if(!r1(I,J))return!1}return!0}return!1}var KY=new Set,g8=(f)=>f instanceof Error?f.message:String(f);function u8(f){KY.has(f)||(KY.add(f),console.warn(f))}function S2(f,Y){u8(`${f} is deprecated. Use ${Y} instead.`)}function E1(f,Y){return Number(f.toFixed(Y))}function Lf(f,Y){return(...K)=>{let A=K.length;if(A===f.length)return f(...K);if(A===Y.length)return Y(...K)}}var v8=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function S8(f){if(typeof f!="string")throw new TypeError("string cannot be undefined or null");let Y=[],K=0,A=0;for(;K<f.length;){if(A+=p8(K+A,f),s8(f[K+A])&&A++,m8(f[K+A])&&A++,c8(f[K+A])&&A++,d8(f[K+A])){A++;continue}Y.push(f.substring(K,K+A)),K+=A,A=0}return Y}function p8(f,Y){let K=Y[f];if(!l8(K)||f===Y.length-1)return 1;let A=K+Y[f+1],L=Y.substring(f+2,f+5);return AY(A)&&AY(L)?4:k8(A)&&r8(L)?Y.slice(f).indexOf(String.fromCodePoint(917631))+2:b8(L)?4:2}function l8(f){return f&&O2(f[0].charCodeAt(0),55296,56319)}function AY(f){return O2(s1(f),127462,127487)}function k8(f){return O2(s1(f),127988,127988)}function b8(f){return O2(s1(f),127995,127999)}function m8(f){return typeof f=="string"&&O2(f.charCodeAt(0),65024,65039)}function c8(f){return typeof f=="string"&&O2(f.charCodeAt(0),8400,8447)}function r8(f){let Y=f.codePointAt(0);return typeof f=="string"&&typeof Y=="number"&&O2(Y,917504,917631)}function s8(f){return typeof f=="string"&&v8.includes(f.charCodeAt(0))}function d8(f){return typeof f=="string"&&f.charCodeAt(0)===8205}function s1(f){let Y=f.charCodeAt(0)-55296,K=f.charCodeAt(1)-56320;return(Y<<10)+K+65536}function O2(f,Y,K){return f>=Y&&f<=K}var vf=(f,Y)=>Array.isArray(f)?f?.includes(Y):f===Y,sf=(f,Y)=>Array.isArray(Y)?Y.some((K)=>f.has(K)):f.has(Y),F0=(f,Y,K)=>{f.has(Y)?f.get(Y)?.push(K):f.set(Y,[K])},a8=(()=>{let f=0;return()=>f++})(),w8={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{"0":"south","1":"east","2":"west","3":"north","4":"lshoulder","5":"rshoulder","6":"ltrigger","7":"rtrigger","8":"select","9":"start","10":"lstick","11":"rstick","12":"dpad-up","13":"dpad-down","14":"dpad-left","15":"dpad-right","16":"home","17":"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{"0":"south","1":"east","2":"west","3":"north","4":"lshoulder","5":"rshoulder","9":"select","10":"lstick","16":"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{"0":"south","1":"east","2":"west","3":"north","4":"lshoulder","5":"rshoulder","9":"start","10":"lstick","16":"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{"0":"south","1":"east","2":"west","3":"north","4":"lshoulder","5":"rshoulder","6":"ltrigger","7":"rtrigger","8":"select","9":"start","10":"lstick","11":"rstick","12":"dpad-up","13":"dpad-down","14":"dpad-left","15":"dpad-right","16":"home","17":"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{"0":"south","1":"east","2":"west","3":"north","4":"lshoulder","5":"rshoulder","6":"ltrigger","7":"rtrigger","8":"select","9":"start","10":"lstick","11":"rstick","12":"dpad-up","13":"dpad-down","14":"dpad-left","15":"dpad-right","16":"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function SY(){let f=$.globalOpt.pixelDensity??1,Y=$.globalOpt.width,K=$.globalOpt.height,A=$.gfx.ggl.gl.drawingBufferWidth,L=$.gfx.ggl.gl.drawingBufferHeight,z=A/f,X=L/f,I=0,J=0,H=z,Z=X;if($.globalOpt.letterbox){if(!Y||!K)throw new Error("Letterboxing requires width and height defined.");let Q=z/X,q=Y/K;if(Q>q){let V=X*q;I=(z-V)/2,H=V}else{let V=z/q;Z=V,J=(X-V)/2}}if($.globalOpt.stretch&&(!$.globalOpt.width||!$.globalOpt.height))throw new Error("Stretching requires width and height defined.");$.gfx.viewport={x:I,y:J,width:H,height:Z,scale:($.gfx.viewport.width+$.gfx.viewport.height)/($.gfx.width+$.gfx.height)}}function o8(f){return new E(f.x*$.gfx.viewport.width/$.gfx.width,f.y*$.gfx.viewport.height/$.gfx.height)}function i8(f){return new E((f.x-$.gfx.viewport.x)*$.gfx.width/$.gfx.viewport.width,(f.y-$.gfx.viewport.y)*$.gfx.height/$.gfx.viewport.height)}var n8=()=>R2.lastInputDevice,t8=()=>{let f=R2.buttons;for(let Y in f){let K=f[Y].keyboard&&[f[Y].keyboard].flat(),A=f[Y].keyboardCode&&[f[Y].keyboardCode].flat(),L=f[Y].gamepad&&[f[Y].gamepad].flat(),z=f[Y].mouse&&[f[Y].mouse].flat();K&&K.forEach((X)=>{F0(R2.buttonsByKey,X,Y)}),A&&A.forEach((X)=>{F0(R2.buttonsByKeyCode,X,Y)}),L&&L.forEach((X)=>{F0(R2.buttonsByGamepad,X,Y)}),z&&z.forEach((X)=>{F0(R2.buttonsByMouse,X,Y)})}},t2=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(f){this.pressed.add(f),this.pressedRepeat.add(f),this.down.add(f)}pressRepeat(f){this.pressedRepeat.add(f)}release(f){this.down.delete(f),this.pressed.delete(f),this.released.add(f)}},e8=class{buttonState=new t2;stickState=new Map},f4=class{dts=[];timer=0;fps=0;tick(f){this.dts.push(f),this.timer+=f,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((Y,K)=>Y+K)/this.dts.length)),this.dts=[])}},R2,LY=w8,Y4=(f)=>{let Y=f.buttons??{};return{canvas:f.canvas,buttons:Y,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:0.02,restDt:0,time:0,realTime:0,fpsCounter:new f4,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new E(0),mouseDeltaPos:new E(0),keyState:new t2,mouseState:new t2,mergedGamepadState:new e8,gamepadStates:new Map,lastInputDevice:null,buttonState:new t2,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:f.canvas.offsetWidth,lastHeight:f.canvas.offsetHeight,events:new K0}},K4=(f)=>{if(!f.canvas)throw new Error("Please provide a canvas");let Y=Y4(f);R2=Y,t8();function K(){return Y.dt*Y.timeScale}function A(){return Y.fixedDt*Y.timeScale}function L(){return Y.restDt*Y.timeScale}function z(){return Y.isHidden}function X(){return Y.time}function I(){return Y.fpsCounter.fps}function J(){return Y.numFrames}function H(){return Y.canvas.toDataURL()}function Z(B){Y.canvas.style.cursor=B}function Q(){return Y.canvas.style.cursor}function q(B){if(B)try{let F=Y.canvas.requestPointerLock();F?.catch&&F.catch((x)=>console.error(x))}catch(F){console.error(F)}else document.exitPointerLock()}function V(){return!!document.pointerLockElement}function W(B){B.requestFullscreen?B.requestFullscreen():B.webkitRequestFullscreen&&B.webkitRequestFullscreen()}function N(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function _(B=!0){B?W(Y.canvas):N()}function j(){return document.fullscreenElement===Y.canvas||document.webkitFullscreenElement===Y.canvas}function M(){Y.stopped=!0;let B=Object.entries(xf),F=Object.entries(V1),x=Object.entries(G0);for(let[g,e]of B)Y.canvas.removeEventListener(g,e);for(let[g,e]of F)document.removeEventListener(g,e);for(let[g,e]of x)window.removeEventListener(g,e);n5.disconnect()}function U(B,F){Y.loopID!==null&&cancelAnimationFrame(Y.loopID);let x=0,g=0,e=(zf)=>{if(Y.stopped)return;if(document.visibilityState!=="visible"){Y.loopID=requestAnimationFrame(e);return}let uf=zf/1000,g2=Math.min(uf-Y.realTime,0.25),Y2=f.maxFPS?1/f.maxFPS:0;if(Y.realTime=uf,g+=g2,g>Y2){if(!Y.skipTime){for(x+=g,Y.dt=Y.fixedDt,Y.restDt=0;x>Y.fixedDt;)x-=Y.fixedDt,x<Y.fixedDt&&(Y.restDt=x),B();Y.restDt=x,Y.dt=g,Y.time+=K(),Y.fpsCounter.tick(Y.dt)}g=0,Y.skipTime=!1,Y.numFrames++,F(Q3,V3)}Y.loopID=requestAnimationFrame(e)};e(0)}function D(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function C(){return Y.mousePos.clone()}function R(){return Y.mouseDeltaPos.clone()}function G(B="left"){return Y.mouseState.pressed.has(B)}function O(B="left"){return Y.mouseState.down.has(B)}function P(B="left"){return Y.mouseState.released.has(B)}function T(){return Y.isMouseMoved}function u(B){return B===void 0?Y.keyState.pressed.size>0:sf(Y.keyState.pressed,B)}function p(B){return B===void 0?Y.keyState.pressedRepeat.size>0:sf(Y.keyState.pressedRepeat,B)}function s(B){return B===void 0?Y.keyState.down.size>0:sf(Y.keyState.down,B)}function d(B){return B===void 0?Y.keyState.released.size>0:sf(Y.keyState.released,B)}function w(B){return B===void 0?Y.mergedGamepadState.buttonState.pressed.size>0:sf(Y.mergedGamepadState.buttonState.pressed,B)}function b(B){return B===void 0?Y.mergedGamepadState.buttonState.down.size>0:sf(Y.mergedGamepadState.buttonState.down,B)}function l(B){return B===void 0?Y.mergedGamepadState.buttonState.released.size>0:sf(Y.mergedGamepadState.buttonState.released,B)}function Kf(B){return B===void 0?Y.buttonState.pressed.size>0:sf(Y.buttonState.pressed,B)}function o(B){return B===void 0?Y.buttonState.down.size>0:sf(Y.buttonState.down,B)}function t(B){return B===void 0?Y.buttonState.released.size>0:sf(Y.buttonState.released,B)}function Vf(B){return Y.buttons?.[B]}function k(B,F){Y.buttons[B]={...Y.buttons[B],...F}}function ef(B){Y.buttonState.press(B),Y.events.trigger("buttonPress",B)}function L2(B){Y.buttonState.release(B),Y.events.trigger("buttonRelease",B)}function B2(B){return Y.events.on("resize",B)}let P2=Lf((B)=>Y.events.on("keyDown",B),(B,F)=>Y.events.on("keyDown",(x)=>vf(B,x)&&F(x))),T2=Lf((B)=>Y.events.on("keyPress",(F)=>B(F)),(B,F)=>Y.events.on("keyPress",(x)=>vf(B,x)&&F(x))),c2=Lf((B)=>Y.events.on("keyPressRepeat",B),(B,F)=>Y.events.on("keyPressRepeat",(x)=>vf(B,x)&&F(x))),r2=Lf((B)=>Y.events.on("keyRelease",B),(B,F)=>Y.events.on("keyRelease",(x)=>vf(B,x)&&F(x))),z2=Lf((B)=>Y.events.on("mouseDown",(F)=>B(F)),(B,F)=>Y.events.on("mouseDown",(x)=>vf(B,x)&&F(x))),gf=Lf((B)=>Y.events.on("mousePress",(F)=>B(F)),(B,F)=>Y.events.on("mousePress",(x)=>vf(B,x)&&F(x))),D2=Lf((B)=>Y.events.on("mouseRelease",(F)=>B(F)),(B,F)=>Y.events.on("mouseRelease",(x)=>x===B&&F(x)));function S(B){return Y.events.on("mouseMove",()=>B(C(),R()))}function m(B){return Y.events.on("charInput",B)}function r(B){return Y.events.on("touchStart",B)}function Yf(B){return Y.events.on("touchMove",B)}function Zf(B){return Y.events.on("touchEnd",B)}function i(B){return Y.events.on("scroll",B)}function Wf(B){return Y.events.on("hide",B)}function cf(B){return Y.events.on("show",B)}let c=Lf((B)=>Y.events.on("gamepadButtonPress",(F,x)=>B(F,x)),(B,F)=>Y.events.on("gamepadButtonPress",(x,g)=>vf(B,x)&&F(x,g))),qf=Lf((B)=>Y.events.on("gamepadButtonDown",(F,x)=>B(F,x)),(B,F)=>Y.events.on("gamepadButtonDown",(x,g)=>vf(B,x)&&F(x,g))),s2=Lf((B)=>Y.events.on("gamepadButtonRelease",(F,x)=>B(F,x)),(B,F)=>Y.events.on("gamepadButtonRelease",(x,g)=>vf(B,x)&&F(x,g)));function Q1(B,F){return Y.events.on("gamepadStick",(x,g,e)=>x===B&&F(g,e))}function j0(B){Y.events.on("gamepadConnect",B)}function rf(B){Y.events.on("gamepadDisconnect",B)}function X2(B){return Y.mergedGamepadState.stickState.get(B)||new E(0)}function R0(){return[...Y.charInputted]}function Of(){return[...Y.gamepads]}let d2=Lf((B)=>Y.events.on("buttonPress",(F)=>B(F)),(B,F)=>Y.events.on("buttonPress",(x)=>vf(B,x)&&F(x))),f2=Lf((B)=>Y.events.on("buttonDown",(F)=>B(F)),(B,F)=>Y.events.on("buttonDown",(x)=>vf(B,x)&&F(x))),N0=Lf((B)=>Y.events.on("buttonRelease",(F)=>B(F)),(B,F)=>Y.events.on("buttonRelease",(x)=>vf(B,x)&&F(x)));function Q3(){Y.events.trigger("input"),Y.keyState.down.forEach((B)=>Y.events.trigger("keyDown",B)),Y.mouseState.down.forEach((B)=>Y.events.trigger("mouseDown",B)),Y.buttonState.down.forEach((B)=>{Y.events.trigger("buttonDown",B)}),B3()}function V3(){Y.keyState.update(),Y.mouseState.update(),Y.buttonState.update(),Y.mergedGamepadState.buttonState.update(),Y.mergedGamepadState.stickState.forEach((B,F)=>{Y.mergedGamepadState.stickState.set(F,new E(0))}),Y.charInputted=[],Y.isMouseMoved=!1,Y.mouseDeltaPos=new E(0),Y.gamepadStates.forEach((B)=>{B.buttonState.update(),B.stickState.forEach((F,x)=>{B.stickState.set(x,new E(0))})})}function a5(B){let F={index:B.index,isPressed:(x)=>Y.gamepadStates.get(B.index)?.buttonState.pressed.has(x)||!1,isDown:(x)=>Y.gamepadStates.get(B.index)?.buttonState.down.has(x)||!1,isReleased:(x)=>Y.gamepadStates.get(B.index)?.buttonState.released.has(x)||!1,getStick:(x)=>Y.gamepadStates.get(B.index)?.stickState.get(x)||y()};return Y.gamepads.push(F),Y.gamepadStates.set(B.index,{buttonState:new t2,stickState:new Map([["left",new E(0)],["right",new E(0)]])}),F}function W3(B){Y.gamepads=Y.gamepads.filter((F)=>F.index!==B.index),Y.gamepadStates.delete(B.index)}function B3(){for(let B of navigator.getGamepads())B&&!Y.gamepadStates.has(B.index)&&a5(B);for(let B of Y.gamepads){let F=navigator.getGamepads()[B.index];if(!F)continue;let x=(f.gamepads??{})[F.id]||LY[F.id]||LY.default,g=Y.gamepadStates.get(B.index);if(g){for(let e=0;e<F.buttons.length;e++){let zf=x.buttons[e],uf=F.buttons[e],g2=Y.buttonsByGamepad.has(zf);if(uf.pressed){if(g.buttonState.down.has(zf)){Y.events.trigger("gamepadButtonDown",zf,B);continue}Y.lastInputDevice="gamepad",g2&&Y.buttonsByGamepad.get(zf)?.forEach((Y2)=>{Y.buttonState.press(Y2),Y.events.trigger("buttonPress",Y2)}),Y.mergedGamepadState.buttonState.press(zf),g.buttonState.press(zf),Y.events.trigger("gamepadButtonPress",zf,B)}else g.buttonState.down.has(zf)&&(g2&&Y.buttonsByGamepad.get(zf)?.forEach((Y2)=>{Y.buttonState.release(Y2),Y.events.trigger("buttonRelease",Y2)}),Y.mergedGamepadState.buttonState.release(zf),g.buttonState.release(zf),Y.events.trigger("gamepadButtonRelease",zf,B))}for(let e in x.sticks){let zf=x.sticks[e];if(!zf)continue;let uf=new E(F.axes[zf.x],F.axes[zf.y]);g.stickState.set(e,uf),Y.mergedGamepadState.stickState.set(e,uf),Y.events.trigger("gamepadStick",e,uf,B)}}}}let xf={},V1={},G0={},w5=f.pixelDensity||1;xf.mousemove=(B)=>{let F=i8(new E(B.offsetX,B.offsetY)),x=new E(B.movementX,B.movementY);if(j()){let g=Y.canvas.width/w5,e=Y.canvas.height/w5,zf=window.innerWidth,uf=window.innerHeight,g2=zf/uf,Y2=g/e;if(g2>Y2){let _2=uf/e,W1=(zf-g*_2)/2;F.x=df(B.offsetX-W1,0,g*_2,0,g),F.y=df(B.offsetY,0,e*_2,0,e)}else{let _2=zf/g,W1=(uf-e*_2)/2;F.x=df(B.offsetX,0,g*_2,0,g),F.y=df(B.offsetY-W1,0,e*_2,0,e)}}Y.events.onOnce("input",()=>{Y.isMouseMoved=!0,Y.mousePos=F,Y.mouseDeltaPos=x,Y.events.trigger("mouseMove")})};let o5=["left","middle","right","back","forward"];xf.mousedown=(B)=>{Y.events.onOnce("input",()=>{let F=o5[B.button];F&&(Y.lastInputDevice="mouse",Y.buttonsByMouse.has(F)&&Y.buttonsByMouse.get(F)?.forEach((x)=>{Y.buttonState.press(x),Y.events.trigger("buttonPress",x)}),Y.mouseState.press(F),Y.events.trigger("mousePress",F))})},xf.mouseup=(B)=>{Y.events.onOnce("input",()=>{let F=o5[B.button];F&&(Y.buttonsByMouse.has(F)&&Y.buttonsByMouse.get(F)?.forEach((x)=>{Y.buttonState.release(x),Y.events.trigger("buttonRelease",x)}),Y.mouseState.release(F),Y.events.trigger("mouseRelease",F))})};let _3=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),i5={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};xf.keydown=(B)=>{_3.has(B.key)&&B.preventDefault(),Y.events.onOnce("input",()=>{let F=i5[B.key]||B.key.toLowerCase(),x=B.code;if(F===void 0)throw new Error(`Unknown key: ${B.key}`);F.length===1?(Y.events.trigger("charInput",F),Y.charInputted.push(F)):F==="space"&&(Y.events.trigger("charInput"," "),Y.charInputted.push(" ")),B.repeat?(Y.keyState.pressRepeat(F),Y.events.trigger("keyPressRepeat",F)):(Y.lastInputDevice="keyboard",Y.buttonsByKey.has(F)&&Y.buttonsByKey.get(F)?.forEach((g)=>{Y.buttonState.press(g),Y.events.trigger("buttonPress",g)}),Y.buttonsByKeyCode.has(x)&&Y.buttonsByKeyCode.get(x)?.forEach((g)=>{Y.buttonState.press(g),Y.events.trigger("buttonPress",g)}),Y.keyState.press(F),Y.events.trigger("keyPressRepeat",F),Y.events.trigger("keyPress",F))})},xf.keyup=(B)=>{Y.events.onOnce("input",()=>{let F=i5[B.key]||B.key.toLowerCase(),x=B.code;Y.buttonsByKey.has(F)&&Y.buttonsByKey.get(F)?.forEach((g)=>{Y.buttonState.release(g),Y.events.trigger("buttonRelease",g)}),Y.buttonsByKeyCode.has(x)&&Y.buttonsByKeyCode.get(x)?.forEach((g)=>{Y.buttonState.release(g),Y.events.trigger("buttonRelease",g)}),Y.keyState.release(F),Y.events.trigger("keyRelease",F)})},xf.touchstart=(B)=>{B.preventDefault(),Y.events.onOnce("input",()=>{let F=[...B.changedTouches],x=Y.canvas.getBoundingClientRect();f.touchToMouse!==!1&&(Y.mousePos=new E(F[0].clientX-x.x,F[0].clientY-x.y),Y.lastInputDevice="mouse",Y.buttonsByMouse.has("left")&&Y.buttonsByMouse.get("left")?.forEach((g)=>{Y.buttonState.press(g),Y.events.trigger("buttonPress",g)}),Y.mouseState.press("left"),Y.events.trigger("mousePress","left")),F.forEach((g)=>{Y.events.trigger("touchStart",new E(g.clientX-x.x,g.clientY-x.y),g)})})},xf.touchmove=(B)=>{B.preventDefault(),Y.events.onOnce("input",()=>{let F=[...B.changedTouches],x=Y.canvas.getBoundingClientRect();if(f.touchToMouse!==!1){let g=Y.mousePos;Y.mousePos=new E(F[0].clientX-x.x,F[0].clientY-x.y),Y.mouseDeltaPos=Y.mousePos.sub(g),Y.events.trigger("mouseMove")}F.forEach((g)=>{Y.events.trigger("touchMove",new E(g.clientX-x.x,g.clientY-x.y),g)})})},xf.touchend=(B)=>{Y.events.onOnce("input",()=>{let F=[...B.changedTouches],x=Y.canvas.getBoundingClientRect();f.touchToMouse!==!1&&(Y.mousePos=new E(F[0].clientX-x.x,F[0].clientY-x.y),Y.mouseDeltaPos=new E(0,0),Y.buttonsByMouse.has("left")&&Y.buttonsByMouse.get("left")?.forEach((g)=>{Y.buttonState.release(g),Y.events.trigger("buttonRelease",g)}),Y.mouseState.release("left"),Y.events.trigger("mouseRelease","left")),F.forEach((g)=>{Y.events.trigger("touchEnd",new E(g.clientX-x.x,g.clientY-x.y),g)})})},xf.touchcancel=(B)=>{Y.events.onOnce("input",()=>{let F=[...B.changedTouches],x=Y.canvas.getBoundingClientRect();f.touchToMouse!==!1&&(Y.mousePos=new E(F[0].clientX-x.x,F[0].clientY-x.y),Y.mouseState.release("left"),Y.events.trigger("mouseRelease","left")),F.forEach((g)=>{Y.events.trigger("touchEnd",new E(g.clientX-x.x,g.clientY-x.y),g)})})},xf.wheel=(B)=>{B.preventDefault(),Y.events.onOnce("input",()=>{Y.events.trigger("scroll",new E(B.deltaX,B.deltaY))})},xf.contextmenu=(B)=>B.preventDefault(),V1.visibilitychange=()=>{document.visibilityState==="visible"?(Y.skipTime=!0,Y.isHidden=!1,Y.events.trigger("show")):(Y.isHidden=!0,Y.events.trigger("hide"))},G0.gamepadconnected=(B)=>{let F=a5(B.gamepad);Y.events.onOnce("input",()=>{Y.events.trigger("gamepadConnect",F)})},G0.gamepaddisconnected=(B)=>{let F=Of().filter((x)=>x.index===B.gamepad.index)[0];W3(B.gamepad),Y.events.onOnce("input",()=>{Y.events.trigger("gamepadDisconnect",F)})};for(let[B,F]of Object.entries(xf))Y.canvas.addEventListener(B,F);for(let[B,F]of Object.entries(V1))document.addEventListener(B,F);for(let[B,F]of Object.entries(G0))window.addEventListener(B,F);let n5=new ResizeObserver((B)=>{for(let F of B)if(F.target===Y.canvas){if(Y.lastWidth===Y.canvas.offsetWidth&&Y.lastHeight===Y.canvas.offsetHeight)return;Y.lastWidth=Y.canvas.offsetWidth,Y.lastHeight=Y.canvas.offsetHeight,Y.events.onOnce("input",()=>{Y.events.trigger("resize")})}});return n5.observe(Y.canvas),{state:Y,dt:K,fixedDt:A,restDt:L,time:X,run:U,canvas:Y.canvas,fps:I,numFrames:J,quit:M,isHidden:z,setFullscreen:_,isFullscreen:j,setCursor:Z,screenshot:H,getGamepads:Of,getCursor:Q,setCursorLocked:q,isCursorLocked:V,isTouchscreen:D,mousePos:C,mouseDeltaPos:R,isKeyDown:s,isKeyPressed:u,isKeyPressedRepeat:p,isKeyReleased:d,isMouseDown:O,isMousePressed:G,isMouseReleased:P,isMouseMoved:T,isGamepadButtonPressed:w,isGamepadButtonDown:b,isGamepadButtonReleased:l,getGamepadStick:X2,isButtonPressed:Kf,isButtonDown:o,isButtonReleased:t,setButton:k,getButton:Vf,pressButton:ef,releaseButton:L2,charInputted:R0,onResize:B2,onKeyDown:P2,onKeyPress:T2,onKeyPressRepeat:c2,onKeyRelease:r2,onMouseDown:z2,onMousePress:gf,onMouseRelease:D2,onMouseMove:S,onCharInput:m,onTouchStart:r,onTouchMove:Yf,onTouchEnd:Zf,onScroll:i,onHide:Wf,onShow:cf,onGamepadButtonDown:qf,onGamepadButtonPress:c,onGamepadButtonRelease:s2,onGamepadStick:Q1,onGamepadConnect:j0,onGamepadDisconnect:rf,onButtonPress:d2,onButtonDown:f2,onButtonRelease:N0,getLastInputDeviceType:n8,events:Y.events}};function _f(){return $.app.dt()}function C1(){return $.app.fixedDt()}function M1(){return $.app.restDt()}var A4=new E(-1,-1),L4=new E(0,-1),z4=new E(1,-1),X4=new E(-1,0),H4=new E(0,0),J4=new E(1,0),I4=new E(-1,1),Z4=new E(0,1),q4=new E(1,1);function p2(f){switch(f){case"topleft":return A4;case"top":return L4;case"topright":return z4;case"left":return X4;case"center":return H4;case"right":return J4;case"botleft":return I4;case"bot":return Z4;case"botright":return q4;default:return f}}function $4(f){switch(f){case"left":return 0;case"center":return 0.5;case"right":return 1;default:return 0}}function Q4(f){return f.createBuffer(1,1,44100)}var E0=2.5949095,zY=2.70158,XY=2*Math.PI/3,HY=2*Math.PI/4.5,C0={linear:(f)=>f,easeInSine:(f)=>1-Math.cos(f*Math.PI/2),easeOutSine:(f)=>Math.sin(f*Math.PI/2),easeInOutSine:(f)=>-(Math.cos(Math.PI*f)-1)/2,easeInQuad:(f)=>f*f,easeOutQuad:(f)=>1-(1-f)*(1-f),easeInOutQuad:(f)=>f<0.5?2*f*f:1-Math.pow(-2*f+2,2)/2,easeInCubic:(f)=>f*f*f,easeOutCubic:(f)=>1-Math.pow(1-f,3),easeInOutCubic:(f)=>f<0.5?4*f*f*f:1-Math.pow(-2*f+2,3)/2,easeInQuart:(f)=>f*f*f*f,easeOutQuart:(f)=>1-Math.pow(1-f,4),easeInOutQuart:(f)=>f<0.5?8*f*f*f*f:1-Math.pow(-2*f+2,4)/2,easeInQuint:(f)=>f*f*f*f*f,easeOutQuint:(f)=>1-Math.pow(1-f,5),easeInOutQuint:(f)=>f<0.5?16*f*f*f*f*f:1-Math.pow(-2*f+2,5)/2,easeInExpo:(f)=>f===0?0:Math.pow(2,10*f-10),easeOutExpo:(f)=>f===1?1:1-Math.pow(2,-10*f),easeInOutExpo:(f)=>f===0?0:f===1?1:f<0.5?Math.pow(2,20*f-10)/2:(2-Math.pow(2,-20*f+10))/2,easeInCirc:(f)=>1-Math.sqrt(1-Math.pow(f,2)),easeOutCirc:(f)=>Math.sqrt(1-Math.pow(f-1,2)),easeInOutCirc:(f)=>f<0.5?(1-Math.sqrt(1-Math.pow(2*f,2)))/2:(Math.sqrt(1-Math.pow(-2*f+2,2))+1)/2,easeInBack:(f)=>zY*f*f*f-1.70158*f*f,easeOutBack:(f)=>1+zY*Math.pow(f-1,3)+1.70158*Math.pow(f-1,2),easeInOutBack:(f)=>f<0.5?Math.pow(2*f,2)*((E0+1)*2*f-E0)/2:(Math.pow(2*f-2,2)*((E0+1)*(f*2-2)+E0)+2)/2,easeInElastic:(f)=>f===0?0:f===1?1:-Math.pow(2,10*f-10)*Math.sin((f*10-10.75)*XY),easeOutElastic:(f)=>f===0?0:f===1?1:Math.pow(2,-10*f)*Math.sin((f*10-0.75)*XY)+1,easeInOutElastic:(f)=>f===0?0:f===1?1:f<0.5?-(Math.pow(2,20*f-10)*Math.sin((20*f-11.125)*HY))/2:Math.pow(2,-20*f+10)*Math.sin((20*f-11.125)*HY)/2+1,easeInBounce:(f)=>1-C0.easeOutBounce(1-f),easeOutBounce:(f)=>f<0.36363636363636365?7.5625*f*f:f<0.7272727272727273?7.5625*(f-=0.5454545454545454)*f+0.75:f<0.9090909090909091?7.5625*(f-=0.8181818181818182)*f+0.9375:7.5625*(f-=0.9545454545454546)*f+0.984375,easeInOutBounce:(f)=>f<0.5?(1-C0.easeOutBounce(1-2*f))/2:(1+C0.easeOutBounce(2*f-1))/2},A0=C0;function V4(f,Y,K){let A=[],L=Y;for(A.push(L);L!==f;){if(L=K.get(L),L==null)return null;A.push(L)}return A.reverse()}function W4(f,Y,K){let A=new gY((X,I)=>X.cost<I.cost);A.insert({cost:0,node:Y});let L=new Map;L.set(Y,Y);let z=new Map;for(z.set(Y,0);A.length!==0;){let X=A.remove()?.node;if(X===K)break;let I=f.getNeighbours(X);for(let J of I){let H=(z.get(X)||0)+f.getCost(X,J)+f.getHeuristic(J,K);(!z.has(J)||H<z.get(J))&&(z.set(J,H),A.insert({cost:H,node:J}),L.set(J,X))}}return V4(Y,K,L)}var B4=class{a;b;polygon;constructor(f,Y,K){this.a=f,this.b=Y,this.polygon=new WeakRef(K)}isLeft(f,Y){return(this.b.x-this.a.x)*(Y-this.a.y)-(f-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(0.5)}},_4=class{_edges;_centroid;_id;constructor(f){this._id=f}get id(){return this._id}set edges(f){this._edges=f;let Y=0,K=0,A=0;for(let L of this._edges){L.polygon=new WeakRef(this);let z=L.a.x*L.b.y-L.a.y*L.b.x;Y+=(L.a.x+L.b.x)*z,K+=(L.a.y+L.b.y)*z,A+=z}A/=2,this._centroid=y(Y/(6*A),K/(6*A))}get edges(){return this._edges}get centroid(){return this._centroid}contains(f){let Y=!1;for(let K of this.edges)K.b.y>f.y!=K.a.y>f.y&&f.x<(K.a.x-K.b.x)*(f.y-K.b.y)/(K.a.y-K.b.y)+K.b.x&&(Y=!Y);return Y}},j4=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(f){let Y=this._pointCache[`${f.x}_${f.y}`];return Y||(Y=f.clone(),this._pointCache[`${f.x}_${f.y}`]=Y,Y)}_addEdge(f){let Y=`${f.a.x}_${f.a.y}-${f.b.x}_${f.b.y}`;return this._edgeCache[Y]=f,f}_findEdge(f,Y){let K=`${f.x}_${f.y}-${Y.x}_${Y.y}`;return this._edgeCache[K]}_findCommonEdge(f,Y){for(let K of f.edges){let A=this._findEdge(K.b,K.a);if(A&&A.polygon.deref().id===Y.id)return A}return null}addPolygon(f){let Y=new _4(this._polygons.length),K=f.map((A,L)=>new B4(A,f[(L+1)%f.length],Y));Y.edges=K,this._polygons.push(Y);for(let A of Y.edges)this._addEdge(A);return Y}addRect(f,Y){let K=this._addPoint(f),A=this._addPoint(f.add(Y.x,0)),L=this._addPoint(f.add(Y)),z=this._addPoint(f.add(0,Y.y));return this.addPolygon([K,A,L,z])}_getLocation(f){for(let Y of this._polygons)if(Y.contains(f))return Y;return null}getNeighbours(f){let Y=[];for(let K of this._polygons[f].edges){let A=this._findEdge(K.b,K.a);if(A){let L=A.polygon.deref();L&&Y.push(L.id)}}return Y}getCost(f,Y){return 1}getHeuristic(f,Y){let K=this._polygons[f],A=this._polygons[Y],L=K.centroid.x-A.centroid.x,z=K.centroid.y-A.centroid.y;return Math.sqrt(L*L+z*z)}getPath(f,Y){return f===void 0||Y===void 0?[]:f===Y?[f,Y]:W4(this,f,Y)}getWaypointPath(f,Y,K){let A=K?.type||"centroids",L=this._getLocation(f),z=this._getLocation(Y);if(L===void 0||z===void 0)return[];let X=this.getPath(L.id,z.id);if(!X)return[];if(A==="edges"){let I=[];for(let J=1;J<X.length;J++){let H=this._polygons[X[J-1]],Z=this._polygons[X[J]],Q=this._findCommonEdge(H,Z);I.push(Q.middle.add(Z.centroid.sub(Q.middle).unit().scale(4)))}return[f,...I,Y]}else return[f,...X.slice(1,-1).map((I)=>this._polygons[I].centroid),Y]}};function e2(f){let Y=new wf;return f.pos&&Y.translate(f.pos),f.scale&&Y.scale(f.scale),f.angle&&Y.rotate(f.angle),f.parent?Y.mult(f.parent.transform):Y}function R4(f){return new E(f.x/jf()*2-1,-f.y/Gf()*2+1)}function i2(f,Y,K,A,L,z=1){A=Qf(A%360),L=Qf(L%360),L<=A&&(L+=Math.PI*2);let X=[],I=Math.ceil((L-A)/Qf(8)*z),J=(L-A)/I,H=y(Math.cos(A),Math.sin(A)),Z=y(Math.cos(J),Math.sin(J));for(let Q=0;Q<=I;Q++)X.push(f.add(Y*H.x,K*H.y)),H=y(H.x*Z.x-H.y*Z.y,H.x*Z.y+H.y*Z.x);return X}function N4(...f){let Y=ff(...f),K=f[3]??1;$.gfx.bgColor=Y,$.gfx.bgAlpha=K,$.gfx.ggl.gl.clearColor(Y.r/255,Y.g/255,Y.b/255,K)}function G4(){return $.gfx.bgColor?.clone?.()??null}function Hf(...f){if(f[0]===void 0)return;let Y=y(...f);Y.x===0&&Y.y===0||$.gfx.transform.translate(Y)}function Sf(){$.gfx.transformStack.push($.gfx.transform.clone())}function y4(f){$.gfx.transform=f.clone()}function L0(...f){if(f[0]===void 0)return;let Y=y(...f);Y.x===1&&Y.y===1||$.gfx.transform.scale(Y)}function v2(f){f&&$.gfx.transform.rotate(f)}function Uf(){$.gfx.transformStack.length>0&&($.gfx.transform=$.gfx.transformStack.pop())}function pf(){$.gfx.renderer.flush()}function jf(){return $.gfx.width}function Gf(){return $.gfx.height}function pY(){return($.gfx.viewport.width+$.gfx.viewport.height)/($.gfx.width+$.gfx.height)}function T0(){return y(jf()/2,Gf()/2)}var F4=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(f,Y,K,A){this.gfx=f,this.canvas=document.createElement("canvas"),this.canvas.width=Y,this.canvas.height=K,this.textures=[I2.fromImage(f,this.canvas)],this.bigTextures=[],this.padding=A;let L=this.canvas.getContext("2d");if(!L)throw new Error("Failed to get 2d context");this.c2d=L}addSingle(f){let Y=I2.fromImage(this.gfx,f);return this.bigTextures.push(Y),[Y,new Xf(0,0,1,1),0]}add(f){let Y=f.width+this.padding*2,K=f.height+this.padding*2;if(Y>this.canvas.width||K>this.canvas.height)return this.addSingle(f);this.x+Y>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+K>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(I2.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let A=this.textures[this.textures.length-1],L=new E(this.x+this.padding,this.y+this.padding);return this.x+=Y,K>this.curHeight&&(this.curHeight=K),f instanceof ImageData?this.c2d.putImageData(f,L.x,L.y):this.c2d.drawImage(f,L.x,L.y),A.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:L,size:new E(f.width,f.height),texture:A}),this.lastTextureId++,[A,new Xf(L.x/this.canvas.width,L.y/this.canvas.height,f.width/this.canvas.width,f.height/this.canvas.height),this.lastTextureId-1]}free(){for(let f of this.textures)f.free();for(let f of this.bigTextures)f.free()}};function kf(f){return typeof f!="string"||vY(f)?f:$.assets.urlPrefix+f}var bf=class f{loaded=!1;data=null;error=null;onLoadEvents=new Ff;onErrorEvents=new Ff;onFinishEvents=new Ff;constructor(Y){Y.then((K)=>{this.loaded=!0,this.data=K,this.onLoadEvents.trigger(K)}).catch((K)=>{if(this.error=K,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(K);else throw K}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(Y){let K=new f(Promise.resolve(Y));return K.data=Y,K.loaded=!0,K}onLoad(Y){return this.loaded&&this.data?Y(this.data):this.onLoadEvents.add(Y),this}onError(Y){return this.loaded&&this.error?Y(this.error):this.onErrorEvents.add(Y),this}onFinish(Y){return this.loaded?Y():this.onFinishEvents.add(Y),this}then(Y){return this.onLoad(Y)}catch(Y){return this.onError(Y)}finally(Y){return this.onFinish(Y)}},u2=class{assets=new Map;lastUID=0;add(f,Y){let K=f??this.lastUID+++"",A=new bf(Y);return this.assets.set(K,A),A}addLoaded(f,Y){let K=f??this.lastUID+++"",A=bf.loaded(Y);return this.assets.set(K,A),A}get(f){return this.assets.get(f)}progress(){if(this.assets.size===0)return 1;let f=0;return this.assets.forEach((Y)=>{Y.loaded&&f++}),f/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter((f)=>this.assets.get(f).error!==null).map((f)=>[f,this.assets.get(f)])}};function d1(f){return fetch(f).then((Y)=>{if(!Y.ok)throw new Error(`Failed to fetch "${f}"`);return Y})}function b0(f){return d1(f).then((Y)=>Y.json())}function E4(f){return d1(f).then((Y)=>Y.text())}function C4(f){return d1(f).then((Y)=>Y.arrayBuffer())}function M4(f){return f!==void 0&&($.assets.urlPrefix=f),$.assets.urlPrefix}function O4(f,Y){return $.assets.custom.add(f,b0(kf(Y)))}function m0(f){let Y=new Image;return Y.crossOrigin="anonymous",Y.src=f,new Promise((K,A)=>{Y.onload=()=>K(Y),Y.onerror=()=>A(new Error(`Failed to load image from "${f}"`))})}function y2(){let f=[$.assets.sprites,$.assets.sounds,$.assets.shaders,$.assets.fonts,$.assets.bitmapFonts,$.assets.custom];return f.reduce((Y,K)=>Y+K.progress(),0)/f.length}function lY(){return[$.assets.sprites,$.assets.sounds,$.assets.shaders,$.assets.fonts,$.assets.bitmapFonts,$.assets.custom].reduce((f,Y)=>f.concat(Y.getFailedAssets()),[])}function x4(f){return $.assets.custom.get(f)??null}function O1(f){return $.assets.custom.add(null,f)}var U4=(f,Y)=>({urlPrefix:"",sprites:new u2,fonts:new u2,bitmapFonts:new u2,sounds:new u2,shaders:new u2,custom:new u2,music:{},packer:new F4(f,2048,2048,Y),loaded:!1}),h4="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",q2=class f{tex;frames=[new Xf(0,0,1,1)];anims={};slice9=null;constructor(Y,K,A={},L=null){this.tex=Y,K&&(this.frames=K),this.anims=A,this.slice9=L}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(Y,K={}){return typeof Y=="string"?f.fromURL(Y,K):Promise.resolve(f.fromImage(Y,K))}static fromImage(Y,K={}){let[A,L]=K.singular?$.assets.packer.addSingle(Y):$.assets.packer.add(Y),z=K.frames?K.frames.map((X)=>new Xf(L.x+X.x*L.w,L.y+X.y*L.h,X.w*L.w,X.h*L.h)):bY(K.sliceX||1,K.sliceY||1,L.x,L.y,L.w,L.h);return new f(A,z,K.anims,K.slice9)}static fromURL(Y,K={}){return m0(Y).then((A)=>f.fromImage(A,K))}};function M0(f){if(typeof f=="string"){let Y=kY(f);if(Y)return Y;if(y2()<1)return null;throw new Error(`Sprite not found: ${f}`)}else{if(f instanceof q2)return bf.loaded(f);if(f instanceof bf)return f;throw new Error(`Invalid sprite: ${f}`)}}function kY(f){return $.assets.sprites.get(f)??null}function f0(f,Y,K={sliceX:1,sliceY:1,anims:{}}){return Y=kf(Y),Array.isArray(Y)?Y.some((A)=>typeof A=="string")?$.assets.sprites.add(f,Promise.all(Y.map((A)=>typeof A=="string"?m0(A):Promise.resolve(A))).then((A)=>JY(A,K))):$.assets.sprites.addLoaded(f,JY(Y,K)):typeof Y=="string"?$.assets.sprites.add(f,q2.from(Y,K)):$.assets.sprites.addLoaded(f,q2.fromImage(Y,K))}function bY(f=1,Y=1,K=0,A=0,L=1,z=1){let X=[],I=L/f,J=z/Y;for(let H=0;H<Y;H++)for(let Z=0;Z<f;Z++)X.push(new Xf(K+Z*I,A+H*J,I,J));return X}function JY(f,Y={}){let K=document.createElement("canvas"),A=f[0].width,L=f[0].height;K.width=A*f.length,K.height=L;let z=K.getContext("2d");if(!z)throw new Error("Failed to create canvas context");f.forEach((I,J)=>{I instanceof ImageData?z.putImageData(I,J*A,0):z.drawImage(I,J*A,0)});let X=z.getImageData(0,0,f.length*A,L);return q2.fromImage(X,{...Y,sliceX:f.length,sliceY:1})}function P4(f="bean"){return f0(f,h4)}function T4(f,Y,K){Y=kf(Y),K=kf(K),typeof Y=="string"&&!K&&(K=D8(Y)+".json");let A=typeof K=="string"?b0(K):Promise.resolve(K);return $.assets.sprites.add(f,A.then((L)=>{let z=L.meta.size,X=L.frames.map((J)=>new Xf(J.frame.x/z.w,J.frame.y/z.h,J.frame.w/z.w,J.frame.h/z.h)),I={};for(let J of L.meta.frameTags)J.from===J.to?I[J.name]=J.from:I[J.name]={from:J.from,to:J.to,speed:10,loop:!0,pingpong:J.direction==="pingpong"};return q2.from(Y,{frames:X,anims:I})}))}var O0=class{fontface;filter=G1;outline=null;size=64;constructor(f,Y={}){if(this.fontface=f,this.filter=Y.filter??G1,this.size=Y.size??64,this.size>256)throw new Error("Max font size: 256");Y.outline&&(this.outline={width:1,color:ff(0,0,0)},typeof Y.outline=="number"?this.outline.width=Y.outline:typeof Y.outline=="object"&&(Y.outline.width&&(this.outline.width=Y.outline.width),Y.outline.color&&(this.outline.color=Y.outline.color)))}};function mY(f){if(!f)return mY($.globalOpt.font??_8);if(typeof f=="string"){let Y=rY(f),K=cY(f);if(Y)return Y.data??Y;if(K)return K.data??K;if(document.fonts.check(`64px ${f}`))return f;if(y2()<1)return null;throw new Error(`Font not found: ${f}`)}else if(f instanceof bf)return f.data?f.data:f;return f}function cY(f){return $.assets.fonts.get(f)??null}function D4(f,Y,K={}){let A=kf(Y),L=new FontFace(f,typeof Y=="string"?`url(${A})`:A);return document.fonts.add(L),$.assets.fonts.add(f,L.load().catch((z)=>{throw new Error(`Failed to load font from "${A}": ${z}`)}).then((z)=>new O0(z,K)))}function g4(f,Y,K,A){let L=f.width/Y,z={},X=A.split("").entries();for(let[I,J]of X)z[J]=new Xf(I%L*Y,Math.floor(I/L)*K,Y,K);return{tex:f,map:z,size:K}}function rY(f){return $.assets.bitmapFonts.get(f)??null}function u4(f,Y,K,A,L={}){let z=kf(Y);return $.assets.bitmapFonts.add(f,m0(z).then((X)=>g4(I2.fromImage($.gfx.ggl,X,L),K,A,L.chars??hY)))}function v4(f,Y){return Y=kf(Y),$.assets.sprites.add(f,new Promise(async(K)=>{let A=typeof Y=="string"?await b0(Y):Y,L=await Promise.all(A.frames.map(m0)),z=document.createElement("canvas");z.width=A.width,z.height=A.height*A.frames.length;let X=z.getContext("2d");if(!X)throw new Error("Failed to create canvas context");L.forEach((J,H)=>{X.drawImage(J,0,H*A.height)});let I=await f0(null,z,{sliceY:A.frames.length,anims:A.anims});K(I)}))}var S4=class{ctx;glProgram;constructor(f,Y,K,A){this.ctx=f,f.onDestroy(()=>this.free());let L=f.gl,z=L.createShader(L.VERTEX_SHADER),X=L.createShader(L.FRAGMENT_SHADER);if(!z||!X)throw new Error("Failed to create shader");L.shaderSource(z,Y),L.shaderSource(X,K),L.compileShader(z),L.compileShader(X);let I=L.createProgram();if(this.glProgram=I,L.attachShader(I,z),L.attachShader(I,X),A.forEach((J,H)=>L.bindAttribLocation(I,H,J)),L.linkProgram(I),!L.getProgramParameter(I,L.LINK_STATUS)){let J=L.getShaderInfoLog(z);if(J)throw new Error("VERTEX SHADER "+J);let H=L.getShaderInfoLog(X);if(H)throw new Error("FRAGMENT SHADER "+H)}L.deleteShader(z),L.deleteShader(X)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(f){let Y=this.ctx.gl;for(let K in f){let A=f[K],L=Y.getUniformLocation(this.glProgram,K);if(typeof A=="number")Y.uniform1f(L,A);else if(A instanceof wf)Y.uniformMatrix4fv(L,!1,new Float32Array(A.m));else if(A instanceof a)Y.uniform3f(L,A.r,A.g,A.b);else if(A instanceof E)Y.uniform2f(L,A.x,A.y);else if(Array.isArray(A)){let z=A[0];U8(A)?Y.uniform1fv(L,A):x8(A)?Y.uniform2fv(L,A.map((X)=>[X.x,X.y]).flat()):O8(A)&&Y.uniform3fv(L,A.map((X)=>[X.r,X.g,X.b]).flat())}else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function a1(f,Y=y1,K=F1){let A=G8.replace("{{user}}",Y??y1),L=y8.replace("{{user}}",K??F1);try{return new S4(f,A,L,m1.map((z)=>z.name))}catch(z){let X=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,I=g8(z).match(X);if(!I?.groups)throw z;let J=Number(I.groups.line)-14,H=I.groups.msg.trim(),Z=I.groups.type.toLowerCase();throw new Error(`${Z} shader line ${J}: ${H}`)}}function p4(f){if(!f)return $.gfx.defShader;if(typeof f=="string"){let Y=sY(f);if(Y)return Y.data??Y;if(y2()<1)return null;throw new Error(`Shader not found: ${f}`)}else if(f instanceof bf)return f.data?f.data:f;return f}function sY(f){return $.assets.shaders.get(f)??null}function l4(f,Y,K){return $.assets.shaders.addLoaded(f,a1($.gfx.ggl,Y,K))}function k4(f,Y,K){Y=kf(Y),K=kf(K);let A=(z)=>z?E4(z):Promise.resolve(null),L=Promise.all([A(Y),A(K)]).then(([z,X])=>a1($.gfx.ggl,z,X));return $.assets.shaders.add(f,L)}var z0=class f{buf;constructor(Y){this.buf=Y}static fromArrayBuffer(Y){return new Promise((K,A)=>$.audio.ctx.decodeAudioData(Y,K,A)).then((K)=>new f(K))}static fromURL(Y){return vY(Y)?f.fromArrayBuffer(P8(Y)):C4(Y).then((K)=>f.fromArrayBuffer(K))}};function b4(f){if(typeof f=="string"){let Y=dY(f);if(Y)return Y;if(y2()<1)return null;throw new Error(`Sound not found: ${f}`)}else{if(f instanceof z0)return bf.loaded(f);if(f instanceof bf)return f;throw new Error(`Invalid sound: ${f}`)}}function dY(f){return $.assets.sounds.get(f)??null}function m4(f,Y){return Y=kf(Y),$.assets.sounds.add(f,typeof Y=="string"?z0.fromURL(Y):z0.fromArrayBuffer(Y))}function c4(f,Y){let K=kf(Y),A=new Audio(K);return A.preload="auto",$.assets.music[f]=K}function aY(f,Y){return f=kf(f),typeof Y=="string"?O1(new Promise((K,A)=>{b0(Y).then((L)=>{aY(f,L).then(K).catch(A)})})):O1(q2.from(f).then((K)=>{let A={};for(let L in Y){let z=Y[L],X=K.frames[0],I=2048*X.w,J=2048*X.h,H=z.frames?z.frames.map((Q)=>new Xf(X.x+(z.x+Q.x)/I*X.w,X.y+(z.y+Q.y)/J*X.h,Q.w/I*X.w,Q.h/J*X.h)):bY(z.sliceX||1,z.sliceY||1,X.x+z.x/I*X.w,X.y+z.y/J*X.h,z.width/I*X.w,z.height/J*X.h),Z=new q2(K.tex,H,z.anims);$.assets.sprites.addLoaded(L,Z),A[L]=Z}return A}))}function $2(f,Y,K=!1,A,L,z={}){let X=A??$.gfx.defTex,I=L??$.gfx.defShader,J=p4(I);if(!J||J instanceof bf)return;let H=$.gfx.fixed||K?$.gfx.transform:$.game.cam.transform.mult($.gfx.transform),Z=[];for(let Q of f){let q=R4(H.multVec2(Q.pos));Z.push(q.x,q.y,Q.uv.x,Q.uv.y,Q.color.r/255,Q.color.g/255,Q.color.b/255,Q.opacity)}$.gfx.renderer.push($.gfx.ggl.gl.TRIANGLES,Z,Y,J,X,z)}function J2(f){if(!f.pts)throw new Error('drawPolygon() requires property "pts".');let Y=f.pts.length;if(!(Y<3)){if(Sf(),Hf(f.pos),L0(f.scale),v2(f.angle),Hf(f.offset),f.fill!==!1){let K=f.color??a.WHITE,A=f.pts.map((z,X)=>({pos:new E(z.x,z.y),uv:f.uv?f.uv[X]:new E(0,0),color:f.colors&&f.colors[X]?f.colors[X].mult(K):K,opacity:f.opacity??1})),L;f.triangulate?L=UY(f.pts).map((z)=>z.map((X)=>f.pts.indexOf(X))).flat():L=[...Array(Y-2).keys()].map((z)=>[0,z+1,z+2]).flat(),$2(A,f.indices??L,f.fixed,f.uv?f.tex:$.gfx.defTex,f.shader,f.uniform??void 0)}f.outline&&w1({pts:[...f.pts,f.pts[0]],radius:f.radius,width:f.outline.width,color:f.outline.color,join:f.outline.join,uniform:f.uniform,fixed:f.fixed,opacity:f.opacity??f.outline.opacity}),Uf()}}function wY(f){if(f.radiusX===void 0||f.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(f.radiusX===0||f.radiusY===0)return;let Y=f.start??0,K=f.end??360,A=p2(f.anchor??"center").scale(new E(-f.radiusX,-f.radiusY)),L=i2(A,f.radiusX,f.radiusY,Y,K,f.resolution);L.unshift(A);let z=Object.assign({},f,{pts:L,radius:0,...f.gradient?{colors:[f.gradient[0],...Array(L.length-1).fill(f.gradient[1])]}:{}});if(K-Y>=360&&f.outline){f.fill!==!1&&J2(Object.assign({},z,{outline:null})),J2(Object.assign({},z,{pts:L.slice(1),fill:!1}));return}J2(z)}function l2(f){if(typeof f.radius!="number")throw new Error('drawCircle() requires property "radius".');f.radius!==0&&wY(Object.assign({},f,{radiusX:f.radius,radiusY:f.radius,angle:0}))}function n2(f){let{p1:Y,p2:K}=f;if(!Y||!K)throw new Error('drawLine() requires properties "p1" and "p2".');let A=f.width||1,L=K.sub(Y).unit().normal().scale(A*0.5),z=[Y.sub(L),Y.add(L),K.add(L),K.sub(L)].map((X)=>({pos:new E(X.x,X.y),uv:new E(0),color:f.color??a.WHITE,opacity:f.opacity??1}));$2(z,[0,1,3,1,2,3],f.fixed,$.gfx.defTex,f.shader,f.uniform??void 0)}function r4(f){let Y=f.pts,K=[],A=(f.width||1)*0.5,L=Y[0]===Y[Y.length-1]||Y[0].eq(Y[Y.length-1]),z=f.pos||y(0,0),X;L?X=Y[0].sub(Y[Y.length-2]):X=Y[1].sub(Y[0]);let I=X.len(),J=X.normal().scale(-A/I),H,Z=Y[0];if(!L)switch(f.cap){case"square":{let W=X.scale(-A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(-1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)K.push(Z),K.push(Z.sub(_)),_=y(_.x*j-_.y*M,_.x*M+_.y*j)}}for(let W=1;W<Y.length;W++){if(Z===Y[W]||Z.eq(Y[W]))continue;H=Z,Z=Y[W];let N=Z.sub(H),_=N.len(),j=N.normal().scale(-A/_),M=X.cross(N);if(Math.abs(M)/(I*_)<0.05){K.push(H.add(J)),K.push(H.sub(J)),X.dot(N)<0&&(K.push(H.sub(J)),K.push(H.add(J))),X=N,I=_,J=j;continue}let U=j.sub(J).cross(N)/M,D=J.add(X.scale(U));M>0?(K.push(H.add(D)),K.push(H.sub(J)),K.push(H.add(D)),K.push(H.sub(j))):(K.push(H.add(J)),K.push(H.sub(D)),K.push(H.add(j)),K.push(H.sub(D))),X=N,I=_,J=j}if(!L)switch(K.push(Z.add(J)),K.push(Z.sub(J)),f.cap){case"square":{let W=X.scale(A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)_=y(_.x*j-_.y*M,_.x*M+_.y*j),K.push(Z),K.push(Z.sub(_))}}if(K.length<4)return;let Q=K.map((W)=>({pos:z.add(W),uv:y(),color:f.color||a.WHITE,opacity:f.opacity??1})),q=[],V=0;for(let W=0;W<K.length-2;W+=2)q[V++]=W+1,q[V++]=W,q[V++]=W+2,q[V++]=W+2,q[V++]=W+3,q[V++]=W+1;L&&(q[V++]=K.length-1,q[V++]=K.length-2,q[V++]=0,q[V++]=0,q[V++]=1,q[V++]=K.length-1),$2(Q,q,f.fixed,$.gfx.defTex,f.shader,f.uniform??void 0)}function s4(f){let Y=f.pts,K=[],A=(f.width||1)*0.5,L=Y[0]===Y[Y.length-1]||Y[0].eq(Y[Y.length-1]),z=f.pos||y(0,0),X;L?X=Y[0].sub(Y[Y.length-2]):X=Y[1].sub(Y[0]);let I=X.len(),J=X.normal().scale(-A/I),H,Z=Y[0];if(!L)switch(f.cap){case"square":{let W=X.scale(-A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(-1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)K.push(Z),K.push(Z.sub(_)),_=y(_.x*j-_.y*M,_.x*M+_.y*j)}}for(let W=1;W<Y.length;W++){if(Z===Y[W]||Z.eq(Y[W]))continue;H=Z,Z=Y[W];let N=Z.sub(H),_=N.len(),j=N.normal().scale(-A/_),M=X.cross(N);if(Math.abs(M)/(I*_)<0.05){K.push(H.add(J)),K.push(H.sub(J)),X.dot(N)<0&&(K.push(H.sub(J)),K.push(H.add(J))),X=N,I=_,J=j;continue}let U=j.sub(J).cross(N)/M,D=J.add(X.scale(U));if(M>0){let C=H.add(D),R=Math.max(A,10),G=Qf(J.angleBetween(j)/R),O=J,P=Math.cos(G),T=Math.sin(G);for(let u=0;u<R;u++)K.push(C),K.push(H.sub(O)),O=y(O.x*P-O.y*T,O.x*T+O.y*P)}else{let C=H.sub(D),R=Math.max(A,10),G=Qf(J.angleBetween(j)/R),O=J,P=Math.cos(G),T=Math.sin(G);for(let u=0;u<R;u++)K.push(H.add(O)),K.push(C),O=y(O.x*P-O.y*T,O.x*T+O.y*P)}X=N,I=_,J=j}if(!L)switch(K.push(Z.add(J)),K.push(Z.sub(J)),f.cap){case"square":{let W=X.scale(A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)_=y(_.x*j-_.y*M,_.x*M+_.y*j),K.push(Z),K.push(Z.sub(_))}}if(K.length<4)return;let Q=K.map((W)=>({pos:z.add(W),uv:y(),color:f.color||a.WHITE,opacity:f.opacity??1})),q=[],V=0;for(let W=0;W<K.length-2;W+=2)q[V++]=W+1,q[V++]=W,q[V++]=W+2,q[V++]=W+2,q[V++]=W+3,q[V++]=W+1;L&&(q[V++]=K.length-1,q[V++]=K.length-2,q[V++]=0,q[V++]=0,q[V++]=1,q[V++]=K.length-1),$2(Q,q,f.fixed,$.gfx.defTex,f.shader,f.uniform??void 0)}function d4(f){let Y=f.pts,K=[],A=(f.width||1)*0.5,L=Y[0]===Y[Y.length-1]||Y[0].eq(Y[Y.length-1]),z=f.pos||y(0,0),X;L?X=Y[0].sub(Y[Y.length-2]):X=Y[1].sub(Y[0]);let I=X.len(),J=X.normal().scale(-A/I),H,Z=Y[0];if(!L)switch(f.cap){case"square":{let W=X.scale(-A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(-1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)K.push(Z),K.push(Z.sub(_)),_=y(_.x*j-_.y*M,_.x*M+_.y*j)}}for(let W=1;W<Y.length;W++){if(Z===Y[W]||Z.eq(Y[W]))continue;H=Z,Z=Y[W];let N=Z.sub(H),_=N.len(),j=N.normal().scale(-A/_),M=X.cross(N);if(Math.abs(M)/(I*_)<0.05){K.push(H.add(J)),K.push(H.sub(J)),X.dot(N)<0&&(K.push(H.sub(J)),K.push(H.add(J))),X=N,I=_,J=j;continue}let U=j.sub(J).cross(N)/M,D=J.add(X.scale(U));K.push(H.add(D)),K.push(H.sub(D)),X=N,I=_,J=j}if(!L)switch(K.push(Z.add(J)),K.push(Z.sub(J)),f.cap){case"square":{let W=X.scale(A/I);K.push(Z.add(W).add(J)),K.push(Z.add(W).sub(J));break}case"round":{let W=Math.max(A,10),N=Math.PI/W,_=J.scale(1),j=Math.cos(N),M=Math.sin(N);for(let U=0;U<W;U++)_=y(_.x*j-_.y*M,_.x*M+_.y*j),K.push(Z),K.push(Z.sub(_))}}if(K.length<4)return;let Q=K.map((W)=>({pos:z.add(W),uv:y(),color:f.color||a.WHITE,opacity:f.opacity??1})),q=[],V=0;for(let W=0;W<K.length-2;W+=2)q[V++]=W+1,q[V++]=W,q[V++]=W+2,q[V++]=W+2,q[V++]=W+3,q[V++]=W+1;L&&(q[V++]=K.length-1,q[V++]=K.length-2,q[V++]=0,q[V++]=0,q[V++]=1,q[V++]=K.length-1),$2(Q,q,f.fixed,$.gfx.defTex,f.shader,f.uniform??void 0)}function w1(f){let Y=f.pts,K=f.width??1;if(!Y)throw new Error('drawLines() requires property "pts".');if(!(Y.length<2)){if(Y.length>2)switch(f.join){case"bevel":return r4(f);case"round":return s4(f);case"miter":return d4(f)}if(f.radius&&Y.length>=3){n2(Object.assign({},f,{p1:Y[0],p2:Y[1]}));for(let A=1;A<Y.length-2;A++){let L=Y[A],z=Y[A+1];n2(Object.assign({},f,{p1:L,p2:z}))}n2(Object.assign({},f,{p1:Y[Y.length-2],p2:Y[Y.length-1]}))}else for(let A=0;A<Y.length-1;A++)n2(Object.assign({},f,{p1:Y[A],p2:Y[A+1]})),f.join!=="none"&&l2(Object.assign({},f,{pos:Y[A],radius:K/2}))}}function oY(f,Y){let K=Y.segments??16,A=[];for(let L=0;L<=K;L++)A.push(f(L/K));w1({pts:A,width:Y.width||1,pos:Y.pos,color:Y.color,opacity:Y.opacity})}function a4(f){oY((Y)=>b1(f.pt1,f.pt2,f.pt3,f.pt4,Y),f)}var I2=class f{ctx;src=null;glTex;width;height;constructor(Y,K,A,L={}){this.ctx=Y;let z=Y.gl,X=Y.gl.createTexture();if(!X)throw new Error("Failed to create texture");this.glTex=X,Y.onDestroy(()=>this.free()),this.width=K,this.height=A;let I={linear:z.LINEAR,nearest:z.NEAREST}[L.filter??Y.opts.texFilter??"nearest"],J={repeat:z.REPEAT,clampToEdge:z.CLAMP_TO_EDGE}[L.wrap??"clampToEdge"];this.bind(),K&&A&&z.texImage2D(z.TEXTURE_2D,0,z.RGBA,K,A,0,z.RGBA,z.UNSIGNED_BYTE,null),z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,I),z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,I),z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_S,J),z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_T,J),z.pixelStorei(z.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(Y,K,A={}){let L=new f(Y,K.width,K.height,A);return L.update(K),L.src=K,L}update(Y,K=0,A=0){let L=this.ctx.gl;this.bind(),L.texSubImage2D(L.TEXTURE_2D,0,K,A,L.RGBA,L.UNSIGNED_BYTE,Y),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},D0=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(f,Y,K,A={}){this.ctx=f;let L=f.gl;f.onDestroy(()=>this.free()),this.tex=new I2(f,Y,K,A);let z=L.createFramebuffer(),X=L.createRenderbuffer();if(!z||!X)throw new Error("Failed to create framebuffer");this.glFramebuffer=z,this.glRenderbuffer=X,this.bind(),L.renderbufferStorage(L.RENDERBUFFER,L.DEPTH_STENCIL,Y,K),L.framebufferTexture2D(L.FRAMEBUFFER,L.COLOR_ATTACHMENT0,L.TEXTURE_2D,this.tex.glTex,0),L.framebufferRenderbuffer(L.FRAMEBUFFER,L.DEPTH_STENCIL_ATTACHMENT,L.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let f=this.ctx.gl,Y=new Uint8ClampedArray(this.width*this.height*4);this.bind(),f.readPixels(0,0,this.width,this.height,f.RGBA,f.UNSIGNED_BYTE,Y),this.unbind();let K=this.width*4,A=new Uint8Array(K);for(let L=0;L<(this.height/2|0);L++){let z=L*K,X=(this.height-L-1)*K;A.set(Y.subarray(z,z+K)),Y.copyWithin(z,X,X+K),Y.set(A,X)}return new ImageData(Y,this.width,this.height)}toDataURL(){let f=document.createElement("canvas"),Y=f.getContext("2d");if(f.width=this.width,f.height=this.height,!Y)throw new Error("Failed to get 2d context");return Y.putImageData(this.toImageData(),0,0),f.toDataURL()}clear(){let f=this.ctx.gl;f.clear(f.COLOR_BUFFER_BIT)}draw(f){this.bind(),f(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let f=this.ctx.gl;f.deleteFramebuffer(this.glFramebuffer),f.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},w4=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(f,Y,K,A){let L=f.gl;this.vertexFormat=Y,this.ctx=f,this.stride=Y.reduce((X,I)=>X+I.size,0),this.maxVertices=K,this.maxIndices=A;let z=L.createBuffer();if(!z)throw new Error("Failed to create vertex buffer");this.glVBuf=z,f.pushArrayBuffer(this.glVBuf),L.bufferData(L.ARRAY_BUFFER,K*4,L.DYNAMIC_DRAW),f.popArrayBuffer(),this.glIBuf=L.createBuffer(),f.pushElementArrayBuffer(this.glIBuf),L.bufferData(L.ELEMENT_ARRAY_BUFFER,A*4,L.DYNAMIC_DRAW),f.popElementArrayBuffer()}push(f,Y,K,A,L=null,z={}){(f!==this.curPrimitive||L!==this.curTex||A!==this.curShader||!r1(this.curUniform,z)||this.vqueue.length+Y.length*this.stride>this.maxVertices||this.iqueue.length+K.length>this.maxIndices)&&this.flush();let X=this.vqueue.length/this.stride;for(let I of Y)this.vqueue.push(I);for(let I of K)this.iqueue.push(I+X);this.curPrimitive=f,this.curShader=A,this.curTex=L,this.curUniform=z}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let f=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),f.bufferSubData(f.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),f.bufferSubData(f.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),f.drawElements(this.curPrimitive,this.iqueue.length,f.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let f=this.ctx.gl;f.deleteBuffer(this.glVBuf),f.deleteBuffer(this.glIBuf)}};function j2(f){let Y=[],K=(z)=>{Y.push(z),f(z)},A=()=>{Y.pop(),f(L()??null)},L=()=>Y[Y.length-1];return[K,A,L]}function o4(f,Y={}){let K=[];function A(C){K.push(C)}function L(){K.forEach((R)=>R());let C=f.getExtension("WEBGL_lose_context");C&&C.loseContext()}let z=null;function X(C){if(r1(C,z))return;z=C;let R=C.reduce((G,O)=>G+O.size,0);C.reduce((G,O,P)=>(f.vertexAttribPointer(P,O.size,f.FLOAT,!1,R*4,G),f.enableVertexAttribArray(P),G+O.size*4),0)}let[I,J]=j2((C)=>f.bindTexture(f.TEXTURE_2D,C)),[H,Z]=j2((C)=>f.bindBuffer(f.ARRAY_BUFFER,C)),[Q,q]=j2((C)=>f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,C)),[V,W]=j2((C)=>f.bindFramebuffer(f.FRAMEBUFFER,C)),[N,_]=j2((C)=>f.bindRenderbuffer(f.RENDERBUFFER,C)),[j,M]=j2((C)=>{if(!C)return;let{x:R,y:G,w:O,h:P}=C;f.viewport(R,G,O,P)}),[U,D]=j2((C)=>f.useProgram(C));return j({x:0,y:0,w:f.drawingBufferWidth,h:f.drawingBufferHeight}),{gl:f,opts:Y,onDestroy:A,destroy:L,pushTexture2D:I,popTexture2D:J,pushArrayBuffer:H,popArrayBuffer:Z,pushElementArrayBuffer:Q,popElementArrayBuffer:q,pushFramebuffer:V,popFramebuffer:W,pushRenderbuffer:N,popRenderbuffer:_,pushViewport:j,popViewport:M,pushProgram:U,popProgram:D,setVertexFormat:X}}var R1={};function IY(f,Y){if(Y.override){Object.assign(f,Y);return}Y.pos&&(f.pos=f.pos.add(Y.pos)),Y.scale&&(f.scale=f.scale.scale(y(Y.scale))),Y.angle&&(f.angle+=Y.angle),Y.color&&f.ch.length===1&&(f.color=f.color.mult(Y.color)),Y.opacity!=null&&(f.opacity*=Y.opacity)}function x1(f){let Y={},K="",A=[],L=String(f),z=(X)=>{A.length>0&&(Y[K.length]=A.slice()),K+=X};for(;L!=="";){if(L[0]==="\\"){if(L.length===1)throw new Error("Styled text error: \\ at end of string");z(L[1]),L=L.slice(2);continue}if(L[0]==="["){let X=/^\[(\/)?(\w+?)\]/.exec(L);if(!X){z(L[0]),L=L.slice(1);continue}let[I,J,H]=X;if(J!==void 0){let Z=A.pop();if(Z!==H)throw Z!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${Z}], got [/${H}]`):new Error(`Styled text error: stray end tag [/${H}]`)}else A.push(H);L=L.slice(I.length);continue}z(L[0]),L=L.slice(1)}if(A.length>0)throw new Error(`Styled text error: unclosed tags ${A}`);return{charStyleMap:Y,text:K}}function F2(f){if(f.text===void 0)throw new Error('formatText() requires property "text".');let Y=mY(f.font);if(!f.text||f.text===""||Y instanceof bf||!Y)return{width:0,height:0,chars:[],opt:f,renderedText:""};let{charStyleMap:K,text:A}=x1(f.text+""),L=S8(A);if(Y instanceof O0||typeof Y=="string"){let U=Y instanceof O0?Y.fontface.family:Y,D=Y instanceof O0?{outline:Y.outline,filter:Y.filter}:{outline:null,filter:G1},C=R1[U]??{font:{tex:new I2($.gfx.ggl,2048,2048,{filter:D.filter}),map:{},size:64},cursor:new E(0),maxHeight:0,outline:D.outline};R1[U]||(R1[U]=C),Y=C.font;for(let R of L)if(!C.font.map[R]){let G=$.fontCacheC2d;if(!G)throw new Error("fontCacheC2d is not defined.");if(!$.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");G.clearRect(0,0,$.fontCacheCanvas.width,$.fontCacheCanvas.height),G.font=`${Y.size}px ${U}`,G.textBaseline="top",G.textAlign="left",G.fillStyle="#ffffff";let O=G.measureText(R),P=Math.ceil(O.width);if(!P)continue;let T=Math.ceil(Math.abs(O.actualBoundingBoxAscent))+Math.ceil(Math.abs(O.actualBoundingBoxDescent));C.outline&&C.outline.width&&C.outline.color&&(G.lineJoin="round",G.lineWidth=C.outline.width*2,G.strokeStyle=C.outline.color.toHex(),G.strokeText(R,C.outline.width,C.outline.width),P+=C.outline.width*2,T+=C.outline.width*3),G.fillText(R,C.outline?.width??0,C.outline?.width??0);let u=G.getImageData(0,0,P,T);if(C.cursor.x+P>2048&&(C.cursor.x=0,C.cursor.y+=C.maxHeight,C.maxHeight=0,C.cursor.y>2048))throw new Error("Font atlas exceeds character limit");Y.tex.update(u,C.cursor.x,C.cursor.y),Y.map[R]=new Xf(C.cursor.x,C.cursor.y,P,T),C.cursor.x+=P+1,C.maxHeight=Math.max(C.maxHeight,T)}}let z=f.size||Y.size,X=y(f.scale??1).scale(z/Y.size),I=f.lineSpacing??0,J=f.letterSpacing??0,H=0,Z=0,Q=0,q=[],V=[],W=0,N=null,_=0,j;for(;W<L.length;){let U=L[W];if(U===`
`)Q+=z+I,q.push({width:H-J,chars:V}),N=null,_=0,H=0,V=[],j=void 0;else{let D=Y.map[U];if(D){let C=D.w*X.x;f.width&&H+C>f.width&&(Q+=z+I,N!=null&&(W-=V.length-N,U=L[W],D=Y.map[U],C=D.w*X.x,V=V.slice(0,N-1),H=_),N=null,_=0,q.push({width:H-J,chars:V}),H=j??0,V=[]),V.push({tex:Y.tex,width:D.w,height:D.h,quad:new Xf(D.x/Y.tex.width,D.y/Y.tex.height,D.w/Y.tex.width,D.h/Y.tex.height),ch:U,pos:new E(H,Q),opacity:f.opacity??1,color:f.color??a.WHITE,scale:y(X),angle:0}),U===" "&&(N=V.length,_=H),f.indentAll&&j===void 0&&/\S/.test(U)&&(j=H),H+=C,Z=Math.max(Z,H),H+=J}}W++}q.push({width:H-J,chars:V}),Q+=z,f.width&&(Z=f.width);let M=[];for(let U=0;U<q.length;U++){let D=(Z-q[U].width)*$4(f.align??"left");for(let C of q[U].chars){let R=Y.map[C.ch],G=M.length+U;if(C.pos=C.pos.add(D,0).add(R.w*X.x*0.5,R.h*X.y*0.5),f.transform){let O=typeof f.transform=="function"?f.transform(G,C.ch):f.transform;O&&IY(C,O)}if(K[G]){let O=K[G];for(let P of O){let T=f.styles?.[P],u=typeof T=="function"?T(G,C.ch):T;u&&IY(C,u)}}M.push(C)}}return{width:Z,height:Q,chars:M,opt:f,renderedText:A}}function X0(f){if(f.width===void 0||f.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(f.width<=0||f.height<=0)return;let{width:Y,height:K}=f,A=p2(f.anchor||k0).scale(new E(Y,K).scale(-0.5)),L=f.quad||new Xf(0,0,1,1),z=f.color||ff(255,255,255),X=f.opacity??1,I=f.tex?0.1/f.tex.width:0,J=f.tex?0.1/f.tex.height:0,H=L.x+I,Z=L.y+J,Q=L.w-I*2,q=L.h-J*2;Sf(),Hf(f.pos),v2(f.angle),L0(f.scale),Hf(A),$2([{pos:new E(-Y/2,K/2),uv:new E(f.flipX?H+Q:H,f.flipY?Z:Z+q),color:z,opacity:X},{pos:new E(-Y/2,-K/2),uv:new E(f.flipX?H+Q:H,f.flipY?Z+q:Z),color:z,opacity:X},{pos:new E(Y/2,-K/2),uv:new E(f.flipX?H:H+Q,f.flipY?Z+q:Z),color:z,opacity:X},{pos:new E(Y/2,K/2),uv:new E(f.flipX?H:H+Q,f.flipY?Z:Z+q),color:z,opacity:X}],[0,1,3,1,2,3],f.fixed,f.tex,f.shader,f.uniform??void 0),Uf()}function E2(f){Sf(),Hf(f.opt.pos),v2(f.opt.angle),Hf(p2(f.opt.anchor??"topleft").add(1,1).scale(f.width,f.height).scale(-0.5)),f.chars.forEach((Y)=>{X0({tex:Y.tex,width:Y.width,height:Y.height,pos:Y.pos,scale:Y.scale,angle:Y.angle,color:Y.color,opacity:Y.opacity,quad:Y.quad,anchor:"center",uniform:f.opt.uniform,shader:f.opt.shader,fixed:f.opt.fixed})}),Uf()}function lf(f){if(f.width===void 0||f.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(f.width<=0||f.height<=0)return;let{width:Y,height:K}=f,A=p2(f.anchor||k0).add(1,1).scale(new E(Y,K).scale(-0.5)),L=[new E(0,0),new E(Y,0),new E(Y,K),new E(0,K)];if(f.radius){let z=Math.min(Y,K)/2,X=Array.isArray(f.radius)?f.radius.map((I)=>Math.min(z,I)):new Array(4).fill(Math.min(z,f.radius));L=[new E(X[0],0),...X[1]?i2(new E(Y-X[1],X[1]),X[1],X[1],270,360):[y(Y,0)],...X[2]?i2(new E(Y-X[2],K-X[2]),X[2],X[2],0,90):[y(Y,K)],...X[3]?i2(new E(X[3],K-X[3]),X[3],X[3],90,180):[y(0,K)],...X[0]?i2(new E(X[0],X[0]),X[0],X[0],180,270):[]]}J2(Object.assign({},f,{offset:A,pts:L,...f.gradient?{colors:f.horizontal?[f.gradient[0],f.gradient[1],f.gradient[1],f.gradient[0]]:[f.gradient[0],f.gradient[0],f.gradient[1],f.gradient[1]]}:{}}))}function H2(f){pf();let Y=$.gfx.width,K=$.gfx.height;$.gfx.width=$.gfx.viewport.width,$.gfx.height=$.gfx.viewport.height,f(),pf(),$.gfx.width=Y,$.gfx.height=K}function ZY(f,Y){H2(()=>{let K=y(8);Sf(),Hf(f);let A=F2({text:Y,font:P0,size:16,pos:K,color:ff(255,255,255),fixed:!0}),L=A.width+K.x*2,z=A.height+K.x*2;f.x+L>=jf()&&Hf(y(-L,0)),f.y+z>=Gf()&&Hf(y(0,-z)),lf({width:L,height:z,color:ff(0,0,0),radius:4,opacity:0.8,fixed:!0}),E2(A),Uf()})}function iY(f){if(!f.p1||!f.p2||!f.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return J2(Object.assign({},f,{pts:[f.p1,f.p2,f.p3]}))}function i4(){if($.debug.inspect){let f=null;for(let Y of $.game.root.get("*",{recursive:!0}))if(Y.has("area")&&Y.isHovering()){f=Y;break}if($.game.root.drawInspect(),f){let Y=[],K=f.inspect();for(let A in K)K[A]?Y.push(`${K[A]}`):Y.push(`${A}`);ZY(o8($.k.mousePos()),Y.join(`
`))}ZY(y(8),`FPS: ${$.debug.fps()}`)}$.debug.paused&&H2(()=>{Sf(),Hf(jf(),0),Hf(-8,8);let f=32;lf({width:f,height:f,anchor:"topright",color:ff(0,0,0),opacity:0.8,radius:4,fixed:!0});for(let Y=1;Y<=2;Y++)lf({width:4,height:f*0.6,anchor:"center",pos:y(-f/3*Y,f*0.5),color:ff(255,255,255),radius:2,fixed:!0});Uf()}),$.debug.timeScale!==1&&H2(()=>{Sf(),Hf(jf(),Gf()),Hf(-8,-8);let f=8,Y=F2({text:$.debug.timeScale.toFixed(1),font:P0,size:16,color:ff(255,255,255),pos:y(-f),anchor:"botright",fixed:!0});lf({width:Y.width+f*2+f*4,height:Y.height+f*2,anchor:"botright",color:ff(0,0,0),opacity:0.8,radius:4,fixed:!0});for(let K=0;K<2;K++){let A=$.debug.timeScale<1;iY({p1:y(-Y.width-f*(A?2:3.5),-f),p2:y(-Y.width-f*(A?2:3.5),-f-Y.height),p3:y(-Y.width-f*(A?3.5:2),-f-Y.height/2),pos:y(-K*f*1+(A?-f*0.5:0),0),color:ff(255,255,255),fixed:!0})}E2(Y),Uf()}),$.debug.curRecording&&H2(()=>{Sf(),Hf(0,Gf()),Hf(24,-24),l2({radius:12,color:ff(255,0,0),opacity:VY(0,1,$.app.time()*4),fixed:!0}),Uf()}),$.debug.showLog&&$.game.logs.length>0&&H2(()=>{Sf(),Hf(0,Gf()),Hf(8,-8);let f=8,Y=[];for(let A of $.game.logs){let L="",z=A.msg instanceof Error?"error":"info";L+=`[time]${A.time.toFixed(2)}[/time]`,L+=" ",L+=`[${z}]${U1(A.msg)}[/${z}]`,Y.push(L)}$.game.logs=$.game.logs.filter((A)=>$.app.time()-A.time<($.globalOpt.logTime||4));let K=F2({text:Y.join(`
`),font:P0,pos:y(f,-f),anchor:"botleft",size:16,width:jf()*0.6,lineSpacing:f/2,fixed:!0,styles:{time:{color:ff(127,127,127)},info:{color:ff(255,255,255)},error:{color:ff(255,0,127)}}});lf({width:K.width+f*2,height:K.height+f*2,anchor:"botleft",color:ff(0,0,0),radius:4,opacity:0.8,fixed:!0}),E2(K),Uf()})}function U1(f,Y=!1,K=new Set){if(K.has(f))return"<recursive>";var A="",L;return Y&&typeof f=="string"&&(f=JSON.stringify(f)),Array.isArray(f)&&(A=["[",f.map((z)=>U1(z,!0,K.union(new Set([f])))).join(", "),"]"].join(""),f=A),f===null?"null":(typeof f=="object"&&f.toString===Object.prototype.toString&&(f.constructor!==Object&&(A+=f.constructor.name+" "),A+=["{",(L=Object.getOwnPropertyNames(f).map((z)=>`${/^\w+$/.test(z)?z:JSON.stringify(z)}: ${U1(f[z],!0,K.union(new Set([f])))}`).join(", "))?` ${L} `:"","}"].join(""),f=A),String(f).replaceAll(/(?<!\\)\[/g,"\\["))}function n4(){let f=$.game.cam,Y=E.fromAngle(Bf(0,360)).scale(f.shake);f.shake=hf(f.shake,0,5*_f()),f.transform=new wf().translate(T0()).scale(f.scale).rotate(f.angle).translate((f.pos??T0()).scale(-1).add(Y)),$.game.root.draw(),pf()}function t4(){let f=y2();$.game.events.numListeners("loading")>0?$.game.events.trigger("loading",f):H2(()=>{let Y=jf()/2,K=24,A=y(jf()/2,Gf()/2).sub(y(Y/2,K/2));lf({pos:y(0),width:jf(),height:Gf(),color:ff(0,0,0)}),lf({pos:A,width:Y,height:K,fill:!1,outline:{width:4}}),lf({pos:A,width:Y*f,height:K})})}function nY(f,Y,K){let A=$.gfx.ggl.gl;pf(),A.clear(A.STENCIL_BUFFER_BIT),A.enable(A.STENCIL_TEST),A.stencilFunc(A.NEVER,1,255),A.stencilOp(A.REPLACE,A.REPLACE,A.REPLACE),Y(),pf(),A.stencilFunc(K,1,255),A.stencilOp(A.KEEP,A.KEEP,A.KEEP),f(),pf(),A.disable(A.STENCIL_TEST)}function e4(f,Y){let K=$.gfx.ggl.gl;nY(f,Y,K.EQUAL)}function g0(f){if(!f.tex)throw new Error('drawTexture() requires property "tex".');let Y=f.quad??new Xf(0,0,1,1),K=f.tex.width*Y.w,A=f.tex.height*Y.h,L=new E(1);if(f.tiled){let z=p2(f.anchor||k0),X=(f.pos?.x||0)-(z.x+1)*0.5*(f.width||K),I=(f.pos?.y||0)-(z.y+1)*0.5*(f.height||A),J=(f.width||K)/K,H=(f.height||A)/A,Z=Math.floor(J),Q=Math.floor(H),q=J-Z,V=H-Q,W=(Z+q?1:0)*(Q+V?1:0),N=new Array(W*6),_=new Array(W*4),j=0,M=(U,D,C,R,G)=>{N[j*6+0]=j*4+0,N[j*6+1]=j*4+1,N[j*6+2]=j*4+3,N[j*6+3]=j*4+1,N[j*6+4]=j*4+2,N[j*6+5]=j*4+3,_[j*4+0]={pos:new E(U-z.x,D-z.y),uv:new E(G.x,G.y),color:f.color||a.WHITE,opacity:f.opacity||1},_[j*4+1]={pos:new E(U+C-z.x,D-z.y),uv:new E(G.x+G.w,G.y),color:f.color||a.WHITE,opacity:f.opacity||1},_[j*4+2]={pos:new E(U+C-z.x,D+R-z.y),uv:new E(G.x+G.w,G.y+G.h),color:f.color||a.WHITE,opacity:f.opacity||1},_[j*4+3]={pos:new E(U-z.x,D+R-z.y),uv:new E(G.x,G.y+G.h),color:f.color||a.WHITE,opacity:f.opacity||1},j++};for(let U=0;U<Q;U++){for(let D=0;D<Z;D++)M(D*K,U*A,K,A,Y);q&&M(Z*K,U*A,K*q,A,new Xf(Y.x,Y.y,Y.w*q,Y.h))}if(V){for(let U=0;U<Z;U++)M(U*K,Q*A,K,A*V,new Xf(Y.x,Y.y,Y.w,Y.h*V));q&&M(Z*K,Q*A,K*q,A*V,new Xf(Y.x,Y.y,Y.w*q,Y.h*V))}$2(_,N,f.fixed,f.tex,f.shader,f.uniform??void 0)}else f.width&&f.height?(L.x=f.width/K,L.y=f.height/A):f.width?(L.x=f.width/K,L.y=L.x):f.height&&(L.y=f.height/A,L.x=L.y),X0(Object.assign({},f,{scale:L.scale(f.scale||new E(1)),tex:f.tex,quad:Y,width:K,height:A}))}function f7(f){if(!f.sprite)throw new Error('drawSprite() requires property "sprite"');let Y=M0(f.sprite);if(!Y||!Y.data)return;let K=Y.data.frames[f.frame??0];if(!K)throw new Error(`Frame not found: ${f.frame??0}`);g0(Object.assign({},f,{tex:Y.data.tex,quad:K.scale(f.quad??new Xf(0,0,1,1))}))}function Y7(f,Y){let K=$.gfx.ggl.gl;nY(f,Y,K.NOTEQUAL)}function qY(f){E2(F2(f))}var K7=(f,Y)=>{let K=a1(Y,y1,F1),A=f.pixelDensity??1,L=f.scale??1,{gl:z}=Y,X=I2.fromImage(Y,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),I=f.width&&f.height?new D0(Y,f.width*A*L,f.height*A*L):new D0(Y,z.drawingBufferWidth,z.drawingBufferHeight),J=null,H=1;f.background&&(typeof f.background=="string"?J=ff(f.background):(J=ff(...f.background),H=f.background[3]??1),z.clearColor(J.r/255,J.g/255,J.b/255,H??1)),z.enable(z.BLEND),z.blendFuncSeparate(z.ONE,z.ONE_MINUS_SRC_ALPHA,z.ONE,z.ONE_MINUS_SRC_ALPHA);let Z=new w4(Y,m1,R8,N8),Q=I2.fromImage(Y,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:Y,defShader:K,defTex:X,frameBuffer:I,postShader:null,postShaderUniform:null,renderer:Z,transform:new wf,transformStack:[],bgTex:Q,bgColor:J,bgAlpha:H,width:f.width??z.drawingBufferWidth/A/L,height:f.height??z.drawingBufferHeight/A/L,viewport:{x:0,y:0,width:z.drawingBufferWidth,height:z.drawingBufferHeight,scale:1},fixed:!1}};function N2(f){return f.fixed?!0:f.parent?N2(f.parent):!1}function C2(f){return{color:f.color,opacity:f.opacity,anchor:f.anchor,outline:f.outline,shader:f.shader,uniform:f.uniform}}function A7(f,Y={}){return{id:"circle",radius:f,draw(){l2(Object.assign(C2(this),{radius:this.radius,fill:Y.fill}))},renderArea(){return new Af(new E(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function tY(...f){return{id:"color",color:ff(...f),inspect(){return`color: ${this.color.toString()}`}}}function L7(f){return{add(){this.canvas=f}}}function z7(f=1){let Y,K=0,A=!1;return{require:["opacity"],add(){Y=this.opacity,this.opacity=0},update(){A||(K+=_f(),this.opacity=df(K,0,f,0,Y),K>=f&&(this.opacity=Y,A=!0))}}}function X7(f="intersect"){return{id:"mask",mask:f}}function eY(f){return{id:"opacity",opacity:f??1,fadeIn(Y=1,K=$.k.easings.linear){return $.game.root.tween(0,this.opacity,Y,(A)=>this.opacity=A,K)},fadeOut(Y=1,K=$.k.easings.linear){return $.game.root.tween(this.opacity,0,Y,(A)=>this.opacity=A,K)},inspect(){return`opacity: ${E1(this.opacity,1)}`}}}function H7(f=1,Y=ff(0,0,0),K=1,A="miter",L=10,z="butt"){return{id:"outline",outline:{width:f,color:Y,opacity:K,join:A,miterLimit:L,cap:z},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var J7=class{pos=y(0);vel=y(0);acc=y(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function I7(f,Y){let K=Y.lifetime,A=[],L=f.colors||[a.WHITE],z=f.opacities||[1],X=f.quads||[new Xf(0,0,1,1)],I=f.scales||[1],J=f.lifeTime,H=Y.direction,Z=Y.spread,Q=f.speed||[0,0],q=f.angle||[0,0],V=f.angularVelocity||[0,0],W=f.acceleration||[y(0),y(0)],N=f.damping||[0,0],_=[],j=new Array(f.max),M=0,U=0;for(let R=0;R<f.max;R++){_[R*6+0]=R*4+0,_[R*6+1]=R*4+1,_[R*6+2]=R*4+3,_[R*6+3]=R*4+1,_[R*6+4]=R*4+2,_[R*6+5]=R*4+3;for(let G=0;G<4;G++)j[R*4+G]={pos:new E(0,0),uv:new E(0,0),color:ff(255,255,255),opacity:1};A[R]=new J7}let D=new Ff;function C(R=0){for(;R<f.max;){if(A[R].gc)return R;R++}return null}return{id:"particles",emit(R){let G=0;for(let O=0;O<R;O++){if(G=C(G),G==null)return;let P=Bf(H-Z,H+Z),T=E.fromAngle(P).scale(Bf(Q[0],Q[1])),u=Bf(q[0],q[1]),p=Bf(V[0],V[1]),s=y(Bf(W[0].x,W[1].x),Bf(W[0].y,W[1].y)),d=Bf(N[0],N[1]),w=J?Bf(J[0],J[1]):null,b=Y.shape?Y.shape.random():y(),l=A[G];l.lt=w,l.pos=b,l.vel=T,l.acc=s,l.angle=u,l.angularVelocity=p,l.damping=d,l.angularVelocity=p,l.gc=!1}M+=R},update(){if(K!==void 0&&K<=0)return;let R=_f();for(let G of A)if(!G.gc){if(G.t+=R,G.lt&&G.t>=G.lt){G.gc=!0,M--;continue}G.vel=G.vel.add(G.acc.scale(R)).scale(1-G.damping*R),G.pos=G.pos.add(G.vel.scale(R)),G.angle+=G.angularVelocity*R}for(K!==void 0&&(K-=R,K<=0&&D.trigger()),U+=R;M<f.max&&Y.rate&&U>Y.rate;)this.emit(1),M++,U-=Y.rate},draw(){if(!(K!==void 0&&K<=0)){for(let R=0;R<A.length;R++){let G=A[R];if(G.gc)continue;let O=G.progress,P=Math.floor(G.progress*L.length),T=P<L.length-1?hf(L[P],L[P+1],df(O,P/L.length,(P+1)/L.length,0,1)):L[P],u=Math.floor(G.progress*z.length),p=u<z.length-1?hf(z[u],z[u+1],df(O,u/z.length,(u+1)/z.length,0,1)):z[u],s=Math.floor(G.progress*X.length),d=X[s],w=Math.floor(G.progress*I.length),b=I[w],l=Math.cos(G.angle*Math.PI/180),Kf=Math.sin(G.angle*Math.PI/180),o=(f.texture?f.texture.width:10)*d.w/2,t=(f.texture?f.texture.height:10)*d.h/2,Vf=R*4,k=j[Vf];k.pos.x=G.pos.x+-o*b*l- -t*b*Kf,k.pos.y=G.pos.y+-o*b*Kf+-t*b*l,k.uv.x=d.x,k.uv.y=d.y,k.color.r=T.r,k.color.g=T.g,k.color.b=T.b,k.opacity=p,k=j[Vf+1],k.pos.x=G.pos.x+o*b*l- -t*b*Kf,k.pos.y=G.pos.y+o*b*Kf+-t*b*l,k.uv.x=d.x+d.w,k.uv.y=d.y,k.color.r=T.r,k.color.g=T.g,k.color.b=T.b,k.opacity=p,k=j[Vf+2],k.pos.x=G.pos.x+o*b*l-t*b*Kf,k.pos.y=G.pos.y+o*b*Kf+t*b*l,k.uv.x=d.x+d.w,k.uv.y=d.y+d.h,k.color.r=T.r,k.color.g=T.g,k.color.b=T.b,k.opacity=p,k=j[Vf+3],k.pos.x=G.pos.x+-o*b*l-t*b*Kf,k.pos.y=G.pos.y+-o*b*Kf+t*b*l,k.uv.x=d.x,k.uv.y=d.y+d.h,k.color.r=T.r,k.color.g=T.g,k.color.b=T.b,k.opacity=p}$2(j,_,this.fixed,f.texture,this.shader,this.uniform)}},onEnd(R){return D.add(R)},inspect(){return`count: ${M}/${f.max}`}}}function Z7(f,Y={}){if(f.length<3)throw new Error(`Polygon's need more than two points, ${f.length} points provided`);return{id:"polygon",pts:f,colors:Y.colors,uv:Y.uv,tex:Y.tex,radius:Y.radius,draw(){J2(Object.assign(C2(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:Y.fill,triangulate:Y.triangulate}))},renderArea(){return new Ef(this.pts)},inspect(){return`polygon: ${this.pts.map((K)=>`[${K.x},${K.y}]`).join(",")}`}}}function f6(f,Y,K){let A;return $.game.root.get("area").forEach((L)=>{if(K&&K.some((X)=>L.is(X)))return;let z=L.worldArea().raycast(f,Y);z&&(A?z.fraction<A.fraction&&(A=z,A.object=L):(A=z,A.object=L))}),A}function Y6(f,Y,K={}){return{id:"rect",width:f,height:Y,radius:K.radius||0,draw(){lf(Object.assign(C2(this),{width:this.width,height:this.height,radius:this.radius,fill:K.fill}))},renderArea(){return new Af(y(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function q7(f,Y){return{id:"shader",shader:f,...typeof Y=="function"?{uniform:Y(),update(){this.uniform=Y()}}:{uniform:Y},inspect(){return`shader: ${f}`}}}function $7(f,Y){if(!Y.tileWidth||!Y.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let K=$.game.root.add([u0(Y.pos??y(0))]),A=f.length,L=0,z=null,X=null,I=null,J=null,H=(R)=>R.x+R.y*L,Z=(R)=>y(Math.floor(R%L),Math.floor(R/L)),Q=()=>{z=[];for(let R of K.children)q(R)},q=(R)=>{let G=H(R.tilePos);z[G]?z[G].push(R):z[G]=[R]},V=(R)=>{let G=H(R.tilePos);if(z[G]){let O=z[G].indexOf(R);O>=0&&z[G].splice(O,1)}},W=()=>{let R=!1;for(let G of K.children){let O=K.pos2Tile(G.pos);(G.tilePos.x!=O.x||G.tilePos.y!=O.y)&&(R=!0,V(G),G.tilePos.x=O.x,G.tilePos.y=O.y,q(G))}R&&K.trigger("spatialMapChanged")},N=()=>{let R=K.getSpatialMap(),G=K.numRows()*K.numColumns();X?X.length=G:X=new Array(G),X.fill(1,0,G);for(let O=0;O<R.length;O++){let P=R[O];if(P){let T=0;for(let u of P)if(u.isObstacle){T=1/0;break}else T+=u.cost;X[O]=T||1}}},_=()=>{let R=K.getSpatialMap(),G=K.numRows()*K.numColumns();I?I.length=G:I=new Array(G),I.fill(15,0,G);for(let O=0;O<R.length;O++){let P=R[O];if(P){let T=P.length,u=15;for(let p=0;p<T;p++)u|=P[p].edgeMask;I[O]=u}}},j=()=>{let R=K.numRows()*K.numColumns(),G=(P,T)=>{let u=[];for(u.push(P);u.length>0;){let p=u.pop();D(p).forEach((s)=>{J[s]<0&&(J[s]=T,u.push(s))})}};J?J.length=R:J=new Array(R),J.fill(-1,0,R);let O=0;for(let P=0;P<X.length;P++){if(J[P]>=0){O++;continue}G(P,O),O++}},M=(R,G)=>X[G],U=(R,G)=>{let O=Z(R),P=Z(G);return O.dist(P)},D=(R,G)=>{let O=[],P=Math.floor(R%L),T=P>0&&I[R]&1&&X[R-1]!==1/0,u=R>=L&&I[R]&2&&X[R-L]!==1/0,p=P<L-1&&I[R]&4&&X[R+1]!==1/0,s=R<L*A-L-1&&I[R]&8&&X[R+L]!==1/0;return G?(T&&(u&&O.push(R-L-1),O.push(R-1),s&&O.push(R+L-1)),u&&O.push(R-L),p&&(u&&O.push(R-L+1),O.push(R+1),s&&O.push(R+L+1)),s&&O.push(R+L)):(T&&O.push(R-1),u&&O.push(R-L),p&&O.push(R+1),s&&O.push(R+L)),O},C={id:"level",tileWidth(){return Y.tileWidth},tileHeight(){return Y.tileHeight},spawn(R,...G){let O=y(...G),P=(()=>{if(typeof R=="string"){if(Y.tiles[R]){if(typeof Y.tiles[R]!="function")throw new Error("Level symbol def must be a function returning a component list");return Y.tiles[R](O)}else if(Y.wildcardTile)return Y.wildcardTile(R,O)}else{if(Array.isArray(R))return R;throw new Error("Expected a symbol or a component list")}})();if(!P)return null;let T=!1,u=!1;for(let s of P)s.id==="tile"&&(u=!0),s.id==="pos"&&(T=!0);T||P.push(u0(this.tile2Pos(O))),u||P.push(R6());let p=K.add(P);return T&&(p.tilePosOffset=p.pos.clone()),p.tilePos=O,p.transform=e2(p),z&&(q(p),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),p},numColumns(){return L},numRows(){return A},levelWidth(){return L*this.tileWidth()},levelHeight(){return A*this.tileHeight()},tile2Pos(...R){return y(...R).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...R){let G=y(...R);return y(Math.floor(G.x/this.tileWidth()),Math.floor(G.y/this.tileHeight()))},getSpatialMap(){return z||Q(),z},removeFromSpatialMap:V,insertIntoSpatialMap:q,onSpatialMapChanged(R){return this.on("spatialMapChanged",R)},onNavigationMapInvalid(R){return this.on("navigationMapInvalid",R)},getAt(R){z||Q();let G=H(R);return z[G]||[]},raycast(R,G){let O=this.toWorld(R),P=this.toWorld(R.add(G)).sub(O),T=1/this.tileWidth(),u=R.scale(T),p=d3(u,G,(s)=>{let d=this.getAt(s);if(d.some((b)=>b.isObstacle))return!0;let w=null;for(let b of d)if(b.has("area")){let l=b.worldArea().raycast(O,P);l&&(w?l.fraction<w.fraction&&(w=l,w.object=b):(w=l,w.object=b))}return w&&(w.point=this.fromWorld(w.point).scale(T)),w||!1},64);return p&&(p.point=p.point.scale(this.tileWidth())),p},update(){z&&W()},invalidateNavigationMap(){X=null,I=null,J=null},onNavigationMapChanged(R){return this.on("navigationMapChanged",R)},getTilePath(R,G,O={}){if(X||N(),I||_(),J||j(),R.x<0||R.x>=L||R.y<0||R.y>=A||G.x<0||G.x>=L||G.y<0||G.y>=A)return null;let P=H(R),T=H(G);if(X[T]===1/0)return null;if(P===T)return[];if(J[P]!=-1&&J[P]!==J[T])return null;let u=new gY((l,Kf)=>l.cost<Kf.cost);u.insert({cost:0,node:P});let p=new Map;p.set(P,P);let s=new Map;for(s.set(P,0);u.length!==0;){let l=u.remove()?.node;if(l===T)break;let Kf=D(l,O.allowDiagonals);for(let o of Kf){let t=(s.get(l)||0)+M(l,o)+U(o,T);(!s.has(o)||t<s.get(o))&&(s.set(o,t),u.insert({cost:t,node:o}),p.set(o,l))}}let d=[],w=T,b=Z(w);for(d.push(b);w!==P;){let l=p.get(w);if(l===void 0)throw new Error("Bug in pathfinding algorithm");w=l;let Kf=Z(w);d.push(Kf)}return d.reverse()},getPath(R,G,O={}){let P=this.tileWidth(),T=this.tileHeight(),u=this.getTilePath(this.pos2Tile(R),this.pos2Tile(G),O);return u?[R,...u.slice(1,-1).map((p)=>p.scale(P,T).add(P/2,T/2)),G]:null}};return K.use(C),K.onNavigationMapInvalid(()=>{K.invalidateNavigationMap(),K.trigger("navigationMapChanged")}),f.forEach((R,G)=>{let O=R.split("");L=Math.max(O.length,L),O.forEach((P,T)=>{K.spawn(P,y(T,G))})}),K}function Df(f,Y,K){return $.game.objEvents.registers[f]||($.game.objEvents.registers[f]=new DY),$.game.objEvents.on(f,(A,...L)=>{A.is(Y)&&K(A,...L)})}var Q7=(f,Y,...K)=>{for(let A of $.game.root.children)A.is(Y)&&A.trigger(f,K)},V7=Lf((f)=>{let Y=$.game.root.add([{fixedUpdate:f}]);return{get paused(){return Y.paused},set paused(K){Y.paused=K},cancel:()=>Y.destroy()}},(f,Y)=>Df("fixedUpdate",f,Y)),K6=Lf((f)=>{let Y=$.game.root.add([{update:f}]);return{get paused(){return Y.paused},set paused(K){Y.paused=K},cancel:()=>Y.destroy()}},(f,Y)=>Df("update",f,Y)),W7=Lf((f)=>{let Y=$.game.root.add([{draw:f}]);return{get paused(){return Y.hidden},set paused(K){Y.hidden=K},cancel:()=>Y.destroy()}},(f,Y)=>Df("draw",f,Y)),A6=Lf((f)=>$.game.events.on("add",f),(f,Y)=>Df("add",f,Y)),B7=Lf((f)=>$.game.events.on("destroy",f),(f,Y)=>Df("destroy",f,Y)),_7=Lf((f)=>$.game.events.on("use",f),(f,Y)=>Df("use",f,Y)),j7=Lf((f)=>$.game.events.on("unuse",f),(f,Y)=>Df("unuse",f,Y)),L6=Lf((f)=>$.game.events.on("tag",f),(f,Y)=>Df("tag",f,Y)),R7=Lf((f)=>$.game.events.on("untag",f),(f,Y)=>Df("untag",f,Y));function N7(f,Y,K){return Df("collide",f,(A,L,z)=>L.is(Y)&&K(A,L,z))}function G7(f,Y,K){return Df("collideUpdate",f,(A,L,z)=>L.is(Y)&&K(A,L,z))}function y7(f,Y,K){return Df("collideEnd",f,(A,L,z)=>L.is(Y)&&K(A,L,z))}function c0(f,Y){$.game.root.get(f,{recursive:!0}).forEach(Y),A6(f,Y),L6((K,A)=>{A===f&&Y(K)})}var F7=Lf((f)=>$.app.onMousePress(f),(f,Y)=>{let K=[];return c0(f,(A)=>{if(!A.area)throw new Error("onClick() requires the object to have area() component");K.push(A.onClick(()=>Y(A)))}),M2.join(K)});function E7(f,Y){let K=[];return c0(f,(A)=>{if(!A.area)throw new Error("onHover() requires the object to have area() component");K.push(A.onHover(()=>Y(A)))}),M2.join(K)}function C7(f,Y){let K=[];return c0(f,(A)=>{if(!A.area)throw new Error("onHoverUpdate() requires the object to have area() component");K.push(A.onHoverUpdate(()=>Y(A)))}),M2.join(K)}function M7(f,Y){let K=[];return c0(f,(A)=>{if(!A.area)throw new Error("onHoverEnd() requires the object to have area() component");K.push(A.onHoverEnd(()=>Y(A)))}),M2.join(K)}function O7(f){$.game.events.on("loading",f)}function x7(f){$.app.onResize(f)}function U7(f){$.game.events.on("error",f)}function o1(f){$.assets.loaded?f():$.game.events.on("load",f)}function h7(f){if($.assets.loaded)lY().forEach((Y)=>f(...Y));else return $.game.events.on("loadError",f)}function z6(...f){$.game.cam.pos=y(...f)}function X6(){return $.game.cam.pos?$.game.cam.pos.clone():T0()}function H6(...f){$.game.cam.scale=y(...f)}function J6(){return $.game.cam.scale.clone()}function I6(f){$.game.cam.angle=f}function Z6(){return $.game.cam.angle}function P7(){return $.game.cam.transform.clone()}function q6(f=ff(255,255,255),Y=1){let K=$.game.root.add([Y6(jf(),Gf()),tY(f),eY(1),y6()]),A=K.fadeOut(Y);return A.onEnd(()=>j6(K)),A}function T7(){return $.game.cam.transform.clone()}function D7(f=12){$.game.cam.shake+=f}function h1(f){return $.game.cam.transform.multVec2(f)}function $6(f){return $.game.cam.transform.invert().multVec2(f)}function g7(...f){return S2("camPos","setCamPos / getCamPos"),f.length>0&&z6(...f),X6()}function u7(...f){return S2("camScale","setCamScale / getCamScale"),f.length>0&&H6(...f),J6()}function v7(f){return S2("camRot","setCamRot / getCamRot"),f!==void 0&&I6(f),Z6()}function S7(f=ff(255,255,255),Y=1){return S2("camFlash","flash"),q6(f,Y)}function i1(f=[]){let Y=new Map,K=[],A={},L=new K0,z=[],X=new Set("*"),I=$.globalOpt.tagsAsComponents,J=null,H=!1,Z={id:a8(),hidden:!1,transform:new wf,children:[],parent:null,set paused(q){if(q!==H){H=q;for(let V of z)V.paused=q}},get paused(){return H},get tags(){return Array.from(X)},add(q){let V=Array.isArray(q)?i1(q):q;if(V.parent)throw new Error("Cannot add a game obj that already has a parent.");return V.parent=this,V.transform=e2(V),this.children.push(V),V.trigger("add",V),$.game.events.trigger("add",V),V},readd(q){let V=this.children.indexOf(q);return V!==-1&&(this.children.splice(V,1),this.children.push(q)),q},remove(q){let V=this.children.indexOf(q);if(V!==-1){q.parent=null,this.children.splice(V,1);let W=(N)=>{N.trigger("destroy"),$.game.events.trigger("destroy",N),N.children.forEach((_)=>W(_))};W(q)}},removeAll(q){if(q)this.get(q).forEach((V)=>this.remove(V));else for(let V of[...this.children])this.remove(V)},fixedUpdate(){this.paused||(this.children.forEach((q)=>q.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach((q)=>q.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(pf(),this.canvas.bind());let q=$.gfx.fixed;this.fixed&&($.gfx.fixed=!0),Sf(),Hf(this.pos),L0(this.scale),v2(this.angle);let V=this.children.sort((W,N)=>{let _=W.layerIndex??$.game.defaultLayerIndex,j=N.layerIndex??$.game.defaultLayerIndex;return _-j||(W.z??0)-(N.z??0)});if(this.mask){let W={intersect:$.k.drawMasked,subtract:$.k.drawSubtracted}[this.mask];if(!W)throw new Error(`Invalid mask func: "${this.mask}"`);W(()=>{V.forEach((N)=>N.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),V.forEach((W)=>W.draw());Uf(),$.gfx.fixed=q,this.canvas&&(pf(),this.canvas.unbind())},drawInspect(){this.hidden||(Sf(),Hf(this.pos),L0(this.scale),v2(this.angle),this.children.forEach((q)=>q.drawInspect()),this.trigger("drawInspect"),Uf())},use(q){if(typeof q=="string")return X.add(q);if(!q||typeof q!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof q}"`);let V=[];q.id?(this.unuse(q.id),A[q.id]=[],V=A[q.id],Y.set(q.id,q),I&&X.add(q.id)):K.push(q);for(let N in q){if(F8.has(N))continue;let _=Object.getOwnPropertyDescriptor(q,N);if(_)if(typeof _.value=="function"&&(q[N]=q[N].bind(this)),_.set&&Object.defineProperty(q,N,{set:_.set.bind(this)}),_.get&&Object.defineProperty(q,N,{get:_.get.bind(this)}),E8.has(N)){let j=N==="add"?()=>{J=(M)=>V.push(M),q[N]?.(),J=null}:q[N];V.push(this.on(N,j).cancel)}else if(this[N]===void 0)Object.defineProperty(this,N,{get:()=>q[N],set:(j)=>q[N]=j,configurable:!0,enumerable:!0}),V.push(()=>delete this[N]);else{let j=Y.values().find((M)=>M[N]!==void 0)?.id;throw new Error(`Duplicate component property: "${N}" while adding component "${q.id}"`+(j?` (originally added by "${j}")`:""))}}let W=()=>{if(q.require){for(let N of q.require)if(!this.c(N))throw new Error(`Component "${q.id}" requires component "${N}"`)}};q.destroy&&V.push(q.destroy.bind(this)),this.exists()?(W(),q.add&&(J=(N)=>V.push(N),q.add.call(this),J=null),q.id&&(this.trigger("use",q.id),$.game.events.trigger("use",this,q.id))):q.require&&V.push(this.on("add",W).cancel)},unuse(q){if(Y.has(q)){for(let V of Y.values())if(V.require&&V.require.includes(q))throw new Error(`Can't unuse. Component "${V.id}" requires component "${q}"`);Y.delete(q),this.trigger("unuse",q),$.game.events.trigger("unuse",this,q)}else I&&X.has(q)&&X.delete(q);A[q]&&(A[q].forEach((V)=>V()),delete A[q])},c(q){return Y.get(q)??null},get(q,V={}){let W=(_,j)=>V.only==="comps"?_.has(j):V.only==="tags"?_.is(j):_.is(j)||_.has(j),N=V.recursive?this.children.flatMap(function _(j){return[j,...j.children.flatMap(_)]}):this.children;if(N=N.filter((_)=>q?W(_,q):!0),V.liveUpdate){let _=(M)=>V.recursive?this.isAncestorOf(M):M.parent===this,j=[];j.push($.k.onAdd((M)=>{_(M)&&W(M,q)&&N.push(M)})),j.push($.k.onDestroy((M)=>{if(_(M)&&W(M,q)){let U=N.findIndex((D)=>D.id===M.id);U!==-1&&N.splice(U,1)}})),this.onDestroy(()=>{for(let M of j)M.cancel()})}return N},query(q){let V=q.hierarchy||"children",W=q.include,N=q.exclude,_=[];switch(V){case"children":_=this.children;break;case"siblings":_=this.parent?this.parent.children.filter((M)=>M!==this):[];break;case"ancestors":let j=this.parent;for(;j;)_.push(j),j=j.parent;break;case"descendants":_=this.children.flatMap(function M(U){return[U,...U.children.flatMap(M)]});break}if(W&&((q.includeOp||"and")==="and"||!Array.isArray(q.include)?_=_.filter((j)=>j.is(W)):_=_.filter((j)=>q.include.some((M)=>j.is(M)))),N&&((q.includeOp||"and")==="and"||!Array.isArray(q.include)?_=_.filter((j)=>!j.is(N)):_=_.filter((j)=>!q.exclude.some((M)=>j.is(M)))),q.visible===!0&&(_=_.filter((j)=>j.visible)),q.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let j=q.distanceOp||"near",M=q.distance*q.distance;j==="near"?_=_.filter((U)=>U.pos&&this.pos.sdist(U.pos)<=M):_=_.filter((U)=>U.pos&&this.pos.sdist(U.pos)>M)}return q.name&&(_=_.filter((j)=>j.name===q.name)),_},isAncestorOf(q){return q.parent?q.parent===this||this.isAncestorOf(q.parent):!1},exists(){return $.game.root.isAncestorOf(this)},is(q,V="and"){return Array.isArray(q)?V==="and"?q.every((W)=>X.has(W)):q.some((W)=>X.has(W)):X.has(q)},tag(q){if(Array.isArray(q))for(let V of q)X.add(V),this.trigger("tag",V),$.game.events.trigger("tag",this,V);else X.add(q),this.trigger("tag",q),$.game.events.trigger("tag",this,q)},untag(q){if(Array.isArray(q))for(let V of q)X.delete(V),this.trigger("untag",V),$.game.events.trigger("untag",this,V);else X.delete(q),this.trigger("untag",q),$.game.events.trigger("untag",this,q)},has(q,V="and"){return Array.isArray(q)?V==="and"?q.every((W)=>Y.has(W)):q.some((W)=>Y.has(W)):Y.has(q)},on(q,V){let W=L.on(q,V.bind(this));return J&&J(()=>W.cancel()),W},trigger(q,...V){L.trigger(q,...V),$.game.objEvents.trigger(q,this,...V)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let q={};for(let[V,W]of Y)q[V]=W.inspect?.()??null;for(let[V,W]of K.entries()){if(W.inspect){q[V]=W.inspect();continue}for(let[N,_]of Object.entries(W))typeof _!="function"&&(q[N]=`${N}: ${_}`)}return q},onAdd(q){return this.on("add",q)},onFixedUpdate(q){return this.on("fixedUpdate",q)},onUpdate(q){return this.on("update",q)},onDraw(q){return this.on("draw",q)},onDestroy(q){return this.on("destroy",q)},onUse(q){return this.on("use",q)},onUnuse(q){return this.on("unuse",q)},clearEvents(){L.clear()}},Q=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let q of Q)Z[q]=(...V)=>{let W=$.app[q]?.(...V);return z.push(W),Z.onDestroy(()=>W.cancel()),Z.on("sceneEnter",()=>{z.splice(z.indexOf(W),1);let N=$.app[q]?.(...V);M2.replace(W,N),z.push(W)}),W};for(let q of f)Z.use(q);return Z}var p7=()=>({events:new K0,objEvents:new K0,root:i1([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new E(1),angle:0,shake:0,transform:new wf}});function l7(f){$.game.gravity=f?($.game.gravity||y(0,1)).unit().scale(f):null}function k7(){return $.game.gravity?$.game.gravity.len():0}function b7(f){$.game.gravity=f.unit().scale($.game.gravity?$.game.gravity.len():1)}function Y0(){return $.game.gravity?$.game.gravity.unit():y(0,1)}var m7=F3("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"),c7=()=>(()=>{let f=new(window.AudioContext||window.webkitAudioContext),Y=f.createGain();Y.connect(f.destination);let K=new z0(Q4(f));return f.decodeAudioData(m7.buffer.slice(0)).then((A)=>{K.buf=A}).catch((A)=>{console.error("Failed to load burp: ",A)}),{ctx:f,masterNode:Y,burpSnd:K}})();function r7(f,Y={}){let K=new Ff,A=new Audio(f);A.crossOrigin="anonymous",A.loop=!!Y.loop,$.audio.ctx.createMediaElementSource(A).connect($.audio.masterNode);function L(){$.debug.paused||$.app.isHidden()&&!$.globalOpt.backgroundAudio||$.audio.ctx.resume()}function z(){L(),A.play()}return Y.paused||z(),A.onended=()=>K.trigger(),{play(){z()},seek(X){A.currentTime=X},stop(){A.pause(),this.seek(0)},set loop(X){A.loop=X},get loop(){return A.loop},set paused(X){X?A.pause():z()},get paused(){return A.paused},time(){return A.currentTime},duration(){return A.duration},set volume(X){A.volume=af(X,0,1)},get volume(){return A.volume},set speed(X){A.playbackRate=Math.max(X,0)},get speed(){return A.playbackRate},set detune(X){},get detune(){return 0},onEnd(X){return K.add(X)},then(X){return this.onEnd(X)}}}function s7(f,Y={}){if(typeof f=="string"&&$.assets.music[f])return r7($.assets.music[f],Y);let K=$.audio.ctx,A=Y.paused??!1,L=K.createBufferSource(),z=new Ff,X=K.createGain(),I=K.createStereoPanner(),J=Y.seek??0,H=0,Z=0,Q=!1;L.loop=!!Y.loop,L.detune.value=Y.detune??0,L.playbackRate.value=Y.speed??1,L.connect(I),L.onended=()=>{W()>=(L.buffer?.duration??Number.POSITIVE_INFINITY)&&z.trigger()},I.pan.value=Y.pan??0,I.connect(X),X.connect($.audio.masterNode),X.gain.value=Y.volume??1;let q=(_)=>{L.buffer=_.buf,A||(H=K.currentTime,L.start(0,J),Q=!0)},V=b4(f);V instanceof bf&&V.onLoad(q);let W=()=>{if(!L.buffer)return 0;let _=A?Z-H:K.currentTime-H,j=L.buffer.duration;return L.loop?_%j:Math.min(_,j)},N=(_)=>{let j=K.createBufferSource();return j.buffer=_.buffer,j.loop=_.loop,j.playbackRate.value=_.playbackRate.value,j.detune.value=_.detune.value,j.onended=_.onended,j.connect(I),j};return{stop(){this.paused=!0,this.seek(0)},set paused(_){if(A!==_)if(A=_,_)Q&&(L.stop(),Q=!1),Z=K.currentTime;else{L=N(L);let j=Z-H;L.start(0,j),Q=!0,H=K.currentTime-j,Z=0}},get paused(){return A},play(_=0){this.seek(_),this.paused=!1},seek(_){L.buffer?.duration&&(_>L.buffer.duration||(A?(L=N(L),H=Z-_):(L.stop(),L=N(L),H=K.currentTime-_,L.start(0,_),Q=!0,Z=0)))},set speed(_){L.playbackRate.value=_},get speed(){return L.playbackRate.value},set detune(_){L.detune.value=_},get detune(){return L.detune.value},set volume(_){X.gain.value=Math.max(_,0)},get volume(){return X.gain.value},set pan(_){I.pan.value=_},get pan(){return I.pan.value},set loop(_){L.loop=_},get loop(){return L.loop},duration(){return L.buffer?.duration??0},time(){return W()%this.duration()},onEnd(_){return z.add(_)},then(_){return this.onEnd(_)}}}function Q6(f){return $.k.play($.audio.burpSnd,f)}function V6(f){$.audio.masterNode.gain.value=f}function W6(){return $.audio.masterNode.gain.value}function d7(f){return S2("volume","setVolume / getVolume"),f!==void 0&&V6(f),W6()}function B6(){$.app.onHide(()=>{$.globalOpt.backgroundAudio||$.audio.ctx.suspend()}),$.app.onShow(()=>{!$.globalOpt.backgroundAudio&&!$.debug.paused&&$.audio.ctx.resume()}),$.app.onResize(()=>{if($.app.isFullscreen())return;let f=$.globalOpt.width&&$.globalOpt.height;f&&!$.globalOpt.stretch&&!$.globalOpt.letterbox||($.canvas.width=$.canvas.offsetWidth*$.pixelDensity,$.canvas.height=$.canvas.offsetHeight*$.pixelDensity,SY(),f||($.gfx.frameBuffer.free(),$.gfx.frameBuffer=new D0($.gfx.ggl,$.gfx.ggl.gl.drawingBufferWidth,$.gfx.ggl.gl.drawingBufferHeight),$.gfx.width=$.gfx.ggl.gl.drawingBufferWidth/$.pixelDensity/$.gscale,$.gfx.height=$.gfx.ggl.gl.drawingBufferHeight/$.pixelDensity/$.gscale))}),$.globalOpt.debug!==!1&&($.app.onKeyPress($.globalOpt.debugKey??"f1",()=>$.debug.inspect=!$.debug.inspect),$.app.onKeyPress("f2",()=>$.debug.clearLog()),$.app.onKeyPress("f8",()=>$.debug.paused=!$.debug.paused),$.app.onKeyPress("f7",()=>{$.debug.timeScale=E1(af($.debug.timeScale-0.2,0,2),1)}),$.app.onKeyPress("f9",()=>{$.debug.timeScale=E1(af($.debug.timeScale+0.2,0,2),1)}),$.app.onKeyPress("f10",()=>$.debug.stepFrame())),$.globalOpt.burp&&$.app.onKeyPress("b",()=>Q6())}function a7(f,Y={}){let K=$.game.root.add([u0(f),G6()]),A=(Y.speed||1)*5,L=Y.scale||1;K.add([P1($.boomSprite),v0(0),g1("center"),QY(A,L),...Y.comps??[]]);let z=K.add([P1($.kaSprite),v0(0),g1("center"),T1(),...Y.comps??[]]);return z.wait(0.4/A,()=>z.use(QY(A,L))),z.onDestroy(()=>K.destroy()),K}function _6(f,Y){if($.game.layers)throw Error("Layers can only be assigned once.");let K=f.indexOf(Y);if(K==-1)throw Error("The default layer name should be present in the layers list.");$.game.layers=f,$.game.defaultLayerIndex=K}function w7(){return $.game.layers}function o7(){return $.game.layers?.[$.game.defaultLayerIndex]??null}function i7(f,Y){S2("layers","setLayers"),_6(f,Y)}function j6(f){f.destroy()}function n7(){return $.game.root}function t7(f,Y){$.game.scenes[f]=Y}function e7(f,...Y){if(!$.game.scenes[f])throw new Error(`Scene not found: ${f}`);$.game.events.onOnce("frameEnd",()=>{$.game.events.trigger("sceneLeave",f),$.app.events.clear(),$.game.events.clear(),$.game.objEvents.clear(),[...$.game.root.children].forEach((K)=>{!K.stay||K.scenesToStay&&!K.scenesToStay.includes(f)?$.game.root.remove(K):K.trigger("sceneEnter",f)}),$.game.root.clearEvents(),B6(),$.game.cam={pos:null,scale:y(1),angle:0,shake:0,transform:new wf},$.game.scenes[f](...Y)}),$.game.currentScene=f}function fK(f){return $.game.events.on("sceneLeave",f)}function YK(){return $.game.currentScene}function P1(f,Y={}){let K=null,A=null,L=null,z=new Ff;if(!f)throw new Error("Please pass the resource name or data to sprite()");let X=(H,Z,Q,q)=>{let V=y(1,1);return Q&&q?(V.x=Q/(H.width*Z.w),V.y=q/(H.height*Z.h)):Q?(V.x=Q/(H.width*Z.w),V.y=V.x):q&&(V.y=q/(H.height*Z.h),V.x=V.y),V},I=(H,Z)=>{if(!Z)return;let Q=Z.frames[0].clone();Y.quad&&(Q=Q.scale(Y.quad));let q=X(Z.tex,Q,Y.width,Y.height);if(H.width=Z.tex.width*Q.w*q.x,H.height=Z.tex.height*Q.h*q.y,Z.anims)for(let V in Z.anims){let W=Z.anims[V];typeof W!="number"&&(W.frames=J(W))}K=Z,z.trigger(K),Y.anim&&H.play(Y.anim)},J=(H)=>{if(H.frames)return H.frames;let Z=[];if(H.from===void 0||H.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let Q=Math.abs(H.to-H.from)+1;for(let q=0;q<Q;q++)Z.push(H.from+q*Math.sign(H.to-H.from));if(H.pingpong)for(let q=Q-2;q>0;q--)Z.push(Z[q]);return Z};return{id:"sprite",width:0,height:0,frame:Y.frame||0,quad:Y.quad||new Xf(0,0,1,1),animSpeed:Y.animSpeed??1,flipX:Y.flipX??!1,flipY:Y.flipY??!1,get sprite(){return f.toString()},set sprite(H){let Z=M0(H);Z&&Z.onLoad((Q)=>I(this,Q))},get animFrame(){if(!K||!A||L===null)return this.frame;let H=K.anims[A.name];return typeof H=="number"?H:H.from===void 0||H.to===void 0?A.frameIndex:this.frame-Math.min(H.from,H.to)},draw(){if(!K)return;let H=K.frames[this.frame??0];if(!H)throw new Error(`Frame not found: ${this.frame??0}`);if(K.slice9){let{left:Z,right:Q,top:q,bottom:V}=K.slice9,W=K.tex.width*H.w,N=K.tex.height*H.h,_=this.width-Z-Q,j=this.height-q-V,M=Z/W,U=Q/W,D=1-M-U,C=q/N,R=V/N,G=1-C-R,O=[$f(0,0,M,C),$f(M,0,D,C),$f(M+D,0,U,C),$f(0,C,M,G),$f(M,C,D,G),$f(M+D,C,U,G),$f(0,C+G,M,R),$f(M,C+G,D,R),$f(M+D,C+G,U,R),$f(0,0,Z,q),$f(Z,0,_,q),$f(Z+_,0,Q,q),$f(0,q,Z,j),$f(Z,q,_,j),$f(Z+_,q,Q,j),$f(0,q+j,Z,V),$f(Z,q+j,_,V),$f(Z+_,q+j,Q,V)];for(let P=0;P<9;P++){let T=O[P],u=O[P+9];g0(Object.assign(C2(this),{pos:u.pos(),tex:K.tex,quad:H.scale(T),flipX:this.flipX,flipY:this.flipY,tiled:Y.tiled,width:u.w,height:u.h}))}}else g0(Object.assign(C2(this),{tex:K.tex,quad:H.scale(this.quad??new Xf(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:Y.tiled,width:this.width,height:this.height}))},add(){let H=M0(f);H?H.onLoad((Z)=>I(this,Z)):o1(()=>I(this,M0(f).data))},update(){if(!K||!A||L===null)return;let H=K.anims[A.name];if(typeof H=="number"){this.frame=H;return}if(H.speed===0)throw new Error("Sprite anim speed cannot be 0");if(A.timer+=_f()*this.animSpeed,A.timer>=1/A.speed){A.timer=0,A.frameIndex+=L;let Z=H.frames;if(A.frameIndex>=Z.length)if(A.pingpong&&!H.pingpong)L=-1,A.frameIndex=Z.length-2;else if(A.loop)A.frameIndex=0;else{this.frame=Z.at(-1),A.onEnd(),this.stop();return}else if(A.frameIndex<0)if(A.pingpong&&A.loop)L=1,A.frameIndex=1;else if(A.loop)A.frameIndex=Z.length-1;else{this.frame=Z[0],A.onEnd(),this.stop();return}this.frame=Z[A.frameIndex]}},play(H,Z={}){if(!K){z.add(()=>this.play(H,Z));return}let Q=K.anims[H];if(Q===void 0)throw new Error(`Anim not found: ${H}`);A&&this.stop(),A=typeof Q=="number"?{name:H,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:H,timer:0,loop:Z.loop??Q.loop??!1,pingpong:Z.pingpong??Q.pingpong??!1,speed:Z.speed??Q.speed??10,frameIndex:0,onEnd:Z.onEnd??(()=>{})},L=typeof Q=="number"?null:1,this.frame=typeof Q=="number"?Q:Q.frames[0],this.trigger("animStart",H)},stop(){if(!A)return;let H=A.name;A=null,this.trigger("animEnd",H)},numFrames(){return K?.frames.length??0},getCurAnim(){return A},curAnim(){return A?.name},getAnim(H){return K?.anims[H]??null},hasAnim(H){return!!this.getAnim(H)},onAnimEnd(H){return this.on("animEnd",H)},onAnimStart(H){return this.on("animStart",H)},renderArea(){return new Af(y(0),this.width,this.height)},inspect(){return typeof f=="string"?`sprite: "${f}"`:null}}}function KK(f,Y={}){function K(L){let z=F2(Object.assign(C2(L),{text:L.text+"",size:L.textSize,font:L.font,width:Y.width&&L.width,align:L.align,letterSpacing:L.letterSpacing,lineSpacing:L.lineSpacing,transform:L.textTransform,styles:L.textStyles,indentAll:Y.indentAll}));return Y.width||(L.width=z.width/(L.scale?.x||1)),L.height=z.height/(L.scale?.y||1),z}let A={id:"text",set text(L){f=L,K(this),this.renderedText=x1(f).text},get text(){return f},textSize:Y.size??36,font:Y.font,width:Y.width??0,height:0,align:Y.align,lineSpacing:Y.lineSpacing,letterSpacing:Y.letterSpacing,textTransform:Y.transform,textStyles:Y.styles,renderedText:f?x1(f).text:"",add(){o1(()=>K(this))},draw(){E2(K(this))},renderArea(){return new Af(y(0),this.width,this.height)}};return K(A),A}function AK(f,Y){return{id:"rect",width:f,height:Y,draw(){X0(Object.assign(C2(this),{width:this.width,height:this.height}))},renderArea(){return new Af(y(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function LK(f={}){let Y=null,K=null,A=null,L=null;return{id:"agent",require:["pos","tile"],agentSpeed:f.speed??100,allowDiagonals:f.allowDiagonals??!0,getDistanceToTarget(){return Y?this.pos.dist(Y):0},getNextLocation(){return K&&A?K[A]:null},getPath(){return K?K.slice():null},getTarget(){return Y},isNavigationFinished(){return K?A===null:!0},isTargetReachable(){return K!==null},isTargetReached(){return Y?this.pos.eq(Y):!0},setTarget(z){Y=z,K=this.getLevel().getPath(this.pos,Y,{allowDiagonals:this.allowDiagonals}),A=K?0:null,K&&A!==null?(L||(L=this.getLevel().onNavigationMapChanged(()=>{Y&&K&&A!==null&&(K=this.getLevel().getPath(this.pos,Y,{allowDiagonals:this.allowDiagonals}),K?(A=0,this.trigger("navigationNext",this,K[A])):(A=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>L?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,K[A])):this.trigger("navigationEnded",this)},update(){if(Y&&K&&A!==null){if(this.pos.sdist(K[A])<2)if(A===K.length-1){this.pos=Y.clone(),A=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else A++,this.trigger("navigationNext",this,K[A]);this.moveTo(K[A],this.agentSpeed)}},onNavigationStarted(z){return this.on("navigationStarted",z)},onNavigationNext(z){return this.on("navigationNext",z)},onNavigationEnded(z){return this.on("navigationEnded",z)},onTargetReached(z){return this.on("targetReached",z)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(Y),path:JSON.stringify(K)})}}}function zK(f){let Y=f.graph;return{id:"pathfinder",require:["pos"],navigateTo(K){return this.graph?.getWaypointPath(this.pos,K,f.navigationOpt)},get graph(){if(Y)return Y;let K=this.parent;for(;K;){if(K.has("pathfinderMap"))return K.graph;K=K.parent}},set graph(K){Y=K}}}function XK(f={}){let Y=f.waypoints,K=f.speed||100,A=f.endBehavior||"stop",L=0,z=Y!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return K},set patrolSpeed(X){K=X},get waypoints(){return Y},set waypoints(X){Y=X,L=0,z=!1},get nextLocation(){return Y?Y[L]:void 0},update(){let X=this.nextLocation;if(!(!Y||!X||z)&&(this.moveTo(X,K),this.pos.sdist(X)<9))switch(A){case"loop":L=(L+1)%Y.length;break;case"ping-pong":L=L+1,L==Y.length&&(Y.reverse(),L=0);break;case"stop":L<Y.length-1?L+=1:z||(z=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(X){return this.on("patrolFinished",X)}}}function HK(f,Y={}){let K=typeof f=="function"?f:()=>$.game.root.query(f),A=Y.checkFrequency||1,L=typeof Y.direction=="number"?E.fromAngle(Y.direction):Y.direction,z=0;return{id:"sentry",require:["pos"],direction:typeof Y.direction=="number"?E.fromAngle(Y.direction):Y.direction,spotted:[],set directionAngle(X){this.direction=X!==void 0?E.fromAngle(X):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:Y.fieldOfView||200,isWithinFieldOfView(X,I,J){let H=(typeof I=="number"?E.fromAngle(I):I)||L,Z=J||Y.fieldOfView;if(!H||!Z||Z>=360)return!0;let Q=Z/2;return X.pos&&H.angleBetween(X.pos.sub(this.pos))<=Q},hasLineOfSight(X){let I=f6(this.pos,X.pos.sub(this.pos),Y.raycastExclude);return I!=null&&I.object===X},update(){if(z+=_f(),z>A){z-=A;let X=K();if(X.length&&L&&this.fieldOfView&&this.fieldOfView<360){let I=this.fieldOfView/2;X=X.filter((J)=>J.pos&&L.angleBetween(J.pos.sub(this.pos))<=I)}X.length&&Y.lineOfSight&&(X=X.filter((I)=>I.pos&&this.hasLineOfSight(I))),X.length>0&&(this.spotted=X,this.trigger("objectSpotted",X))}},onObjectsSpotted(X){return this.on("objectSpotted",X)}}}function R6(f={}){let Y=y(0),K=f.isObstacle??!1,A=f.cost??0,L=f.edges??[],z=()=>{let I={left:1,top:2,right:4,bottom:8};return L.map((J)=>I[J]||0).reduce((J,H)=>J|H,0)},X=z();return{id:"tile",tilePosOffset:f.offset??y(0),set tilePos(I){let J=this.getLevel();Y=I.clone(),this.pos=y(this.tilePos.x*J.tileWidth(),this.tilePos.y*J.tileHeight()).add(this.tilePosOffset)},get tilePos(){return Y},set isObstacle(I){K!==I&&(K=I,this.getLevel().invalidateNavigationMap())},get isObstacle(){return K},set cost(I){A!==I&&(A=I,this.getLevel().invalidateNavigationMap())},get cost(){return A},set edges(I){L=I,X=z(),this.getLevel().invalidateNavigationMap()},get edges(){return L},get edgeMask(){return X},getLevel(){return this.parent},tileMove(I){let J=this.getLevel();J.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(I),J.insertIntoSpatialMap(this),J.trigger("spatialMapChanged")},moveLeft(){this.tileMove(y(-1,0))},moveRight(){this.tileMove(y(1,0))},moveUp(){this.tileMove(y(0,-1))},moveDown(){this.tileMove(y(0,1))}}}var n1=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(f,Y,K){this.name=f,this.duration=Y.duration,this.loops=Y.loops||0,this.direction=Y.direction||"forward",this.easing=Y.easing||A0.linear,this.interpolation=Y.interpolation||"linear",this.isFinished=!1,this.timing=Y.timing,this.easings=Y.easings,this.relative=K}update(f,Y){return!0}getLowerKeyIndexAndRelativeTime(f,Y,K){let A=Y-1,L=f/this.duration;if(this.loops!==0&&L>=this.loops)return[A,0,!0];let z=Math.trunc(L);if(L-=z,(this.direction=="reverse"||this.direction=="ping-pong"&&z&1)&&(L=1-L),K){let X=0;for(;K[X+1]!==void 0&&K[X+1]<L;)X++;return X>=A?[A,0,!0]:[X,(L-K[X])/(K[X+1]-K[X]),!1]}else{let X=Math.floor((Y-1)*L);return[X,(L-X/A)*A,!1]}}setValue(f,Y,K){if(this.relative)switch(Y){case"pos":f.pos=f.base.pos.add(K);break;case"angle":f.angle=f.base.angle+K;break;case"scale":f.scale=f.base.scale.scale(K);break;case"opacity":f.opacity=f.base.opacity*K;break;default:f[Y]=K}else f[Y]=K}serialize(){let f={duration:this.duration,keys:[]};return this.loops&&(f.loops=this.loops),this.direction!=="forward"&&(f.direction=this.direction),this.easing!=A0.linear&&(f.easing=this.easing.name),this.interpolation!=="linear"&&(f.interpolation=this.interpolation),this.timing&&(f.timing=this.timing),this.easings&&(f.easings=this.easings.map((Y)=>this.easing.name)),f}};function $Y(f,Y){return Y.add(Y.sub(f))}var JK=class extends n1{keys;constructor(f,Y,K,A){super(f,K,A),this.keys=Y}update(f,Y){let[K,A,L]=this.getLowerKeyIndexAndRelativeTime(Y,this.keys.length,this.timing);if(A==0||this.interpolation==="none")this.setValue(f,this.name,this.keys[K]);else{let z=this.easings?this.easings[K]:this.easing;this.setValue(f,this.name,hf(this.keys[K],this.keys[K+1],z(A)))}return L}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},IK=class extends n1{keys;curves;dcurves;constructor(f,Y,K,A,L){if(super(f,K,A),this.keys=Y,this.interpolation==="spline"){this.curves=[],L&&(this.dcurves=[]);for(let z=0;z<this.keys.length-1;z++){let X=this.keys[z],I=z+1,J=this.keys[I],H=z>0?this.keys[z-1]:$Y(J,X),Z=I<this.keys.length-1?this.keys[I+1]:$Y(X,J);this.curves.push(h0(H,X,J,Z)),L&&this.dcurves?.push(h0(H,X,J,Z,z8))}}}update(f,Y){let[K,A,L]=this.getLowerKeyIndexAndRelativeTime(Y,this.keys.length,this.timing);if(A==0||this.interpolation==="none")this.setValue(f,this.name,this.keys[K]);else{let z=this.easings?this.easings[K]:this.easing;switch(this.interpolation){case"linear":this.setValue(f,this.name,this.keys[K].lerp(this.keys[K+1],z(A)));break;case"slerp":this.setValue(f,this.name,this.keys[K].slerp(this.keys[K+1],z(A)));break;case"spline":if(this.curves){this.setValue(f,this.name,this.curves[K](z(A))),this.dcurves&&this.setValue(f,"angle",this.dcurves[K](z(A)).angle());break}}}return L}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map((f)=>[f.x,f.y])})}},ZK=class extends n1{keys;constructor(f,Y,K,A){super(f,K,A),this.keys=Y}update(f,Y){let[K,A,L]=this.getLowerKeyIndexAndRelativeTime(Y,this.keys.length,this.timing);if(A==0||this.interpolation=="none")this.setValue(f,this.name,this.keys[K]);else{let z=this.easings?this.easings[K]:this.easing;this.setValue(f,this.name,this.keys[K].lerp(this.keys[K+1],z(A)))}return L}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function qK(f={}){let Y=[],K=0,A=!1;return{id:"animate",require:f.followMotion?["rotate"]:void 0,base:{pos:y(0,0),angle:0,scale:y(1,1),opacity:1},animation:{paused:!1,seek(L){K=af(L,0,this.duration),Y.forEach((z)=>{z.isFinished=!1}),A=!1},get duration(){return Y.reduce((L,z)=>Math.max(z.duration,L),0)}},add(){f.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let L=!0,z;K+=_f();for(let X of Y)z=X.update(this,K),z&&!X.isFinished&&(X.isFinished=!0,this.trigger("animateChannelFinished",X.name)),L&&=z;L&&!A&&(A=!0,this.trigger("animateFinished"))},animate(L,z,X){A=!1,this.unanimate(L),typeof z[0]=="number"?Y.push(new JK(L,z,X,f.relative||!1)):z[0]instanceof E?Y.push(new IK(L,z,X,f.relative||!1,L==="pos"&&(f.followMotion||!1))):z[0]instanceof a&&Y.push(new ZK(L,z,X,f.relative||!1))},unanimate(L){let z=Y.findIndex((X)=>X.name===L);z>=0&&Y.splice(z,1)},unanimateAll(){Y.splice(0,Y.length)},onAnimateFinished(L){return this.on("animateFinished",L)},onAnimateChannelFinished(L){return this.on("animateChannelFinished",L)},serializeAnimationChannels(){return Y.reduce((L,z)=>(L[z.name]=z.serialize(),L),{})},serializeAnimationOptions(){let L={};return f.followMotion&&(L.followMotion=!0),f.relative&&(L.relative=!0),L}}}function N6(f,Y){let K={name:f.name};return f.has("animate")&&(K.channels=f.serializeAnimationChannels(),Object.assign(K,f.serializeAnimationOptions())),f.children.length>0&&(K.children=f.children.filter((A)=>A.has("named")).map((A)=>N6(A,A.name))),K}function QY(f=2,Y=1){let K=0;return{require:["scale"],update(){let A=Math.sin(K*f)*Y;A<0&&this.destroy(),this.scale=y(A),K+=_f()}}}function $K(f,Y){if(f==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(K=1){this.setHP(f-K),this.trigger("hurt",K)},heal(K=1){let A=f;this.setHP(f+K),this.trigger("heal",f-A)},hp(){return f},maxHP(){return Y??null},setMaxHP(K){Y=K},setHP(K){f=Y?Math.min(Y,K):K,f<=0&&this.trigger("death")},onHurt(K){return this.on("hurt",K)},onHeal(K){return this.on("heal",K)},onDeath(K){return this.on("death",K)},inspect(){return`health: ${f}`}}}function QK(f,Y={}){if(f==null)throw new Error("lifespan() requires time");let K=Y.fade??0;return{id:"lifespan",require:["opacity"],add(){$.game.root.wait(f,()=>{this.opacity=this.opacity??1,K>0?$.game.root.tween(this.opacity,0,K,(A)=>this.opacity=A,A0.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function VK(f){return{id:"named",name:f}}function WK(f,Y,K){if(!f)throw new Error("state() requires an initial state");let A={};function L(J){A[J]||(A[J]={enter:new Ff,end:new Ff,update:new Ff,draw:new Ff})}function z(J,H,Z){return L(H),A[H][J].add(Z)}function X(J,H,...Z){L(H),A[H][J].trigger(...Z)}let I=!1;return{id:"state",state:f,enterState(J,...H){if(I=!0,Y&&!Y.includes(J))throw new Error(`State not found: ${J}`);let Z=this.state;if(K){if(!K?.[Z])return;let Q=typeof K[Z]=="string"?[K[Z]]:K[Z];if(!Q.includes(J))throw new Error(`Cannot transition state from "${Z}" to "${J}". Available transitions: ${Q.map((q)=>`"${q}"`).join(", ")}`)}X("end",Z,...H),this.state=J,X("enter",J,...H),X("enter",`${Z} -> ${J}`,...H)},onStateTransition(J,H,Z){return z("enter",`${J} -> ${H}`,Z)},onStateEnter(J,H){return z("enter",J,H)},onStateUpdate(J,H){return z("update",J,H)},onStateDraw(J,H){return z("draw",J,H)},onStateEnd(J,H){return z("end",J,H)},update(){I||(X("enter",f),I=!0),X("update",this.state)},draw(){X("draw",this.state)},inspect(){return`state: ${this.state}`}}}function G6(f){return{id:"stay",stay:!0,scenesToStay:f}}function BK(f=!0,Y){let K,A;return{id:"textInput",hasFocus:f,require:["text"],typedText:"",add(){let L=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};K=$.k.onCharInput((z)=>{this.hasFocus&&(!Y||this.typedText.length<Y)&&($.k.isKeyDown("shift")?this.typedText+=z.toUpperCase():this.typedText+=z,L())}),A=$.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1)),L()})},destroy(){K.cancel(),A.cancel()}}}function T1(f=1000){return{id:"timer",maxLoopsPerFrame:f,loop(Y,K,A=1/0,L=!1){let z=L?0:Y,X=new Ff,I=this.onUpdate(()=>{z+=$.app.state.dt;for(let J=0;z>=Y&&J<this.maxLoopsPerFrame;J++)if(A--,K(),z-=Y,A<=0){I.cancel(),X.trigger();return}});return{get paused(){return I.paused},set paused(J){I.paused=J},cancel:I.cancel,onEnd(J){X.add(J)},then(J){return X.add(J),this}}},wait(Y,K){return this.loop(Y,K??(()=>{}),1,!0)},tween(Y,K,A,L,z=A0.linear){let X=0,I=[],J=this.onUpdate(()=>{X+=$.app.state.dt;let H=Math.min(X/A,1);L(hf(Y,K,z(H))),H===1&&(J.cancel(),L(K),I.forEach((Z)=>Z()))});return{get paused(){return J.paused},set paused(H){J.paused=H},onEnd(H){I.push(H)},then(H){return this.onEnd(H),this},cancel(){J.cancel()},finish(){J.cancel(),L(K),I.forEach((H)=>H())}}}}}var D1=0;function _K(){return D1>0}function jK(f={}){let Y={},K=new Set,A=[];return{id:"area",collisionIgnore:f.collisionIgnore??[],add(){D1++,this.area.cursor&&A.push(this.onHover(()=>$.app.setCursor(this.area.cursor))),A.push(this.onCollideUpdate((L,z)=>{if(!L.id)throw new Error("area() requires the object to have an id");Y[L.id]||this.trigger("collide",L,z),z&&(Y[L.id]=z,K.add(L.id))}))},destroy(){D1--;for(let L of A)L.cancel()},fixedUpdate(){for(let L in Y)K.has(Number(L))||(this.trigger("collideEnd",Y[L].target),delete Y[L]);K.clear()},drawInspect(){let L=this.localArea();Sf(),Hf(this.area.offset);let z={outline:{width:4/pY(),color:ff(0,0,255)},anchor:this.anchor,fill:!1,fixed:N2(this)};L instanceof Af?lf({...z,pos:L.pos,width:L.width*this.area.scale.x,height:L.height*this.area.scale.y}):L instanceof Ef?J2({...z,pts:L.pts,scale:this.area.scale}):L instanceof Pf&&l2({...z,pos:L.center,radius:L.radius}),Uf()},area:{shape:f.shape??null,scale:f.scale?y(f.scale):y(1),offset:f.offset??y(0),cursor:f.cursor??null},isClicked(){return $.app.isMousePressed()&&this.isHovering()},isHovering(){let L=N2(this)?$.k.mousePos():$.k.toWorld($.k.mousePos());return this.hasPoint(L)},checkCollision(L){if(!L.id)throw new Error("checkCollision() requires the object to have an id");return Y[L.id]??null},getCollisions(){return Object.values(Y)},isColliding(L){if(!L.id)throw new Error("isColliding() requires the object to have an id");return!!Y[L.id]},isOverlapping(L){if(!L.id)throw new Error("isOverlapping() requires the object to have an id");let z=Y[L.id];return z&&z.hasOverlap()},onClick(L,z="left"){let X=$.app.onMousePress(z,()=>{this.isHovering()&&L()});return A.push(X),X},onHover(L){let z=!1;return this.onUpdate(()=>{z?z=this.isHovering():this.isHovering()&&(z=!0,L())})},onHoverUpdate(L){return this.onUpdate(()=>{this.isHovering()&&L()})},onHoverEnd(L){let z=!1;return this.onUpdate(()=>{z?this.isHovering()||(z=!1,L()):z=this.isHovering()})},onCollide(L,z){if(typeof L=="function"&&z===void 0)return this.on("collide",L);if(typeof L=="string")return this.onCollide((X,I)=>{X.is(L)&&z?.(X,I)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(L,z){if(typeof L=="function"&&z===void 0)return this.on("collideUpdate",L);if(typeof L=="string")return this.on("collideUpdate",(X,I)=>X.is(L)&&z?.(X,I));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(L,z){if(typeof L=="function"&&z===void 0)return this.on("collideEnd",L);if(typeof L=="string")return this.on("collideEnd",(X)=>X.is(L)&&z?.(X));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(L){return Z2(this.worldArea(),L)},resolveCollision(L){let z=this.checkCollision(L);z&&!z.resolved&&(this.pos=this.pos.add(z.displacement),z.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let L=this.localArea();if(!(L instanceof Ef||L instanceof Af))throw new Error("Only support polygon and rect shapes for now");let z=this.transform.clone().translate(this.area.offset).scale(y(this.area.scale??1));if(L instanceof Af){let X=p2(this.anchor||k0).add(1,1).scale(-0.5).scale(L.width,L.height);z.translate(X)}return L.transform(z)},screenArea(){let L=this.worldArea();return N2(this)?L:L.transform($.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function RK(f={}){let Y=null,K=null,A=!1,L=y(0),z=null,X=null,I;return{id:"body",require:["pos"],vel:y(0),drag:f.drag??0,jumpForce:f.jumpForce??C8,gravityScale:f.gravityScale??1,isStatic:f.isStatic??!1,mass:f.mass??1,add(){if(z=this.pos.clone(),X=this.pos.clone(),I=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((J,H)=>{if(!H||!J.has("body")||H.resolved)return;this.trigger("beforePhysicsResolve",H);let Z=H.reverse();if(J.trigger("beforePhysicsResolve",Z),!(H.resolved||Z.resolved)&&!(this.isStatic&&J.isStatic)){if(!this.isStatic&&!J.isStatic){let Q=this.mass+J.mass;this.pos=this.pos.add(H.displacement.scale(J.mass/Q)),J.pos=J.pos.add(H.displacement.scale(-this.mass/Q)),this.transform=e2(this),J.transform=e2(J)}else{let Q=!this.isStatic&&J.isStatic?H:H.reverse();Q.source.pos=Q.source.pos.add(Q.displacement),Q.source.transform=e2(Q.source)}H.resolved=!0,this.trigger("physicsResolve",H),J.trigger("physicsResolve",H.reverse())}}),this.onPhysicsResolve((J)=>{if($.game.gravity)if(J.isBottom()&&this.isFalling()){this.vel=this.vel.reject($.game.gravity.unit());let H=Y;Y=J.target,H!=Y&&(K=J.target.pos),A?A=!1:H||(this.trigger("ground",Y),J.target.trigger("land",this))}else J.isTop()&&this.isJumping()&&(this.vel=this.vel.reject($.game.gravity.unit()),this.trigger("headbutt",J.target),J.target.trigger("headbutted",this))}))},update(){Y&&this.isColliding(Y)&&Y.exists()&&Y.has("body")&&(K&&!Y.pos.eq(K)&&f.stickToPlatform!==!1&&this.moveBy(Y.pos.sub(K)),K=Y.pos);let J=M1();J&&(this.pos.x==I.x&&(this.pos.x=hf(z.x,X.x,J/C1()),I.x=this.pos.x),this.pos.y==I.y&&(this.pos.y=hf(z.y,X.y,J/C1()),I.y=this.pos.y))},fixedUpdate(){if(z&&(this.pos.x==I.x&&(this.pos.x=z.x),this.pos.y==I.y&&(this.pos.y=z.y),z=null),$.game.gravity&&!this.isStatic){A&&(Y=null,K=null,this.trigger("fallOff"),A=!1),Y&&(!this.isColliding(Y)||!Y.exists()||!Y.has("body"))&&(A=!0);let J=this.vel.clone();this.vel=this.vel.add($.game.gravity.scale(this.gravityScale*_f()));let H=f.maxVelocity??M8;this.vel.slen()>H*H&&(this.vel=this.vel.unit().scale(H)),J.dot($.game.gravity)<0&&this.vel.dot($.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=L.x*_f(),this.vel.y+=L.y*_f(),this.vel.x*=1-this.drag*_f(),this.vel.y*=1-this.drag*_f(),this.move(this.vel),M1()){z=this.pos.clone();let J=this.vel.add(L.scale(_f()));X=this.pos.add(J.scale(_f())),I=this.pos.clone()}L.x=0,L.y=0},onPhysicsResolve(J){return this.on("physicsResolve",J)},onBeforePhysicsResolve(J){return this.on("beforePhysicsResolve",J)},curPlatform(){return Y},isGrounded(){return Y!==null},isFalling(){return this.vel.dot(Y0())>0},isJumping(){return this.vel.dot(Y0())<0},applyImpulse(J){this.isStatic||(this.vel=this.vel.add(J))},addForce(J){this.isStatic||(L.x+=J.x/this.mass,L.y+=J.y/this.mass)},jump(J){this.isStatic||(Y=null,K=null,this.vel=Y0().scale(-J||-this.jumpForce))},onGround(J){return this.on("ground",J)},onFall(J){return this.on("fall",J)},onFallOff(J){return this.on("fallOff",J)},onHeadbutt(J){return this.on("headbutt",J)},onLand(J){return this.on("land",J)},onHeadbutted(J){return this.on("headbutted",J)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function NK(f=2){let Y=f;return{id:"doubleJump",require:["body"],numJumps:f,add(){this.onGround(()=>{Y=this.numJumps})},doubleJump(K){Y<=0||(Y<this.numJumps&&this.trigger("doubleJump"),Y--,this.jump(K))},onDoubleJump(K){return this.on("doubleJump",K)},inspect(){return`jumpsLeft: ${Y}`}}}function GK(f){return{id:"surfaceEffector",require:["area"],speed:f.speed,speedVariation:f.speedVariation??0,forceScale:f.speedVariation??0.9,add(){this.onCollideUpdate("body",(Y,K)=>{let A=K?.normal.normal(),L=Y.vel.project(A),z=A?.scale(this.speed)?.sub(L);Y.addForce(z?.scale(Y.mass*this.forceScale))})}}}function yK(f){return{id:"areaEffector",require:["area"],useGlobalAngle:f.useGlobalAngle||!1,forceAngle:f.forceAngle,forceMagnitude:f.forceMagnitude,forceVariation:f.forceVariation??0,linearDrag:f.linearDrag??0,add(){this.onCollideUpdate("body",(Y,K)=>{if(!Y.has("body"))return;let A=E.fromAngle(this.forceAngle).scale(this.forceMagnitude);Y.addForce(A),this.linearDrag&&Y.addForce(Y.vel.scale(-this.linearDrag))})}}}function FK(f){return{id:"pointEffector",require:["area","pos"],forceMagnitude:f.forceMagnitude,forceVariation:f.forceVariation??0,distanceScale:f.distanceScale??1,forceMode:f.forceMode||"inverseLinear",linearDrag:f.linearDrag??0,add(){this.onCollideUpdate("body",(Y,K)=>{let A=this.pos.sub(Y.pos),L=A.len(),z=L*this.distanceScale/10,X=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/z:1/z**2,I=A.scale(this.forceMagnitude*X/L);Y.addForce(I),this.linearDrag&&Y.addForce(Y.vel.scale(-this.linearDrag))})}}}function EK(f){return{id:"constantForce",require:["body"],force:f.force,update(){this.force&&this.addForce(this.force)}}}function CK(f){return{id:"platformEffector",require:["area","body"],surfaceArc:f.surfaceArc??180,useOneWay:f.useOneWay??!1,add(){this.onBeforePhysicsResolve((Y)=>{let K=Y.target.vel,A=Y0().scale(-1).angleBetween(K);Math.abs(A)>this.surfaceArc/2&&Y.preventResolution()})}}}function MK(f){return{id:"buoyancyEffector",require:["area"],surfaceLevel:f.surfaceLevel,density:f.density??1,linearDrag:f.linearDrag??1,angularDrag:f.angularDrag??0.2,flowAngle:f.flowAngle??0,flowMagnitude:f.flowMagnitude??0,flowVariation:f.flowVariation??0,add(){this.onCollideUpdate("body",(Y,K)=>{let A=Y,L=A.worldArea(),[z,X]=L.cut(y(-100,this.surfaceLevel),y(100,this.surfaceLevel));z&&(this.applyBuoyancy(A,z),this.applyDrag(A,z)),this.flowMagnitude&&A.addForce(E.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(Y,K){let A=this.density*K.area(),L=y(0,1).scale(-A);Y.addForce(L)},applyDrag(Y,K){let A=Y.vel,L=this.density*this.linearDrag,z=A.scale(-L);Y.addForce(z)}}}function g1(f){if(!f)throw new Error("Please define an anchor");return{id:"anchor",anchor:f,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function y6(){return{id:"fixed",fixed:!0}}function OK(f,Y){return{id:"follow",require:["pos"],follow:{obj:f,offset:Y??y(0)},add(){f.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){f.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function xK(f){let Y=$.game.layers?.indexOf(f);return{id:"layer",get layerIndex(){return Y??null},get layer(){return Y?$.game.layers?.[Y]??null:null},set layer(K){if(Y=$.game.layers?.indexOf(K),Y==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function UK(f,Y){let K=typeof f=="number"?E.fromAngle(f):f.unit();return{id:"move",require:["pos"],update(){this.move(K.scale(Y))}}}function hK(f={}){let Y=!1,K=new Af(y(0),jf(),Gf()),A=new Af(y(0),0,0),L=(z)=>{z.isOffScreen()?(Y||(z.trigger("exitView"),Y=!0),f.hide&&(z.hidden=!0),f.pause&&(z.paused=!0),f.destroy&&z.destroy()):(Y&&(z.trigger("enterView"),Y=!1),f.hide&&(z.hidden=!1),f.pause&&(z.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:f.distance??fY,isOffScreen(){let z=this.screenPos();if(!z)return!1;if(K.width=jf(),K.height=Gf(),!this.offscreenDistance&&this.width&&this.height)return A.width=this.width,A.height=this.height,A.pos=this.pos,A.collides(K);let X=this.offscreenDistance?this.offscreenDistance:fY;return!S0(K,z)&&K.sdistToPoint(z)>X*X},onExitScreen(z){return this.on("exitView",z)},onEnterScreen(z){return this.on("enterView",z)},add(){f.pause&&f.unpause?K6(()=>L(this)):this.onUpdate(()=>L(this))}}}function u0(...f){return{id:"pos",pos:y(...f),moveBy(...Y){this.pos=this.pos.add(y(...Y))},move(...Y){this.moveBy(y(...Y).scale(_f()))},moveTo(...Y){if(typeof Y[0]=="number"&&typeof Y[1]=="number")return this.moveTo(y(Y[0],Y[1]),Y[2]);let K=Y[0],A=Y[1];if(A===void 0){this.pos=y(K);return}let L=K.sub(this.pos);if(L.len()<=A*_f()){this.pos=y(K);return}this.move(L.unit().scale(A))},worldPos(Y=null){return Y?(this.pos=this.pos.add(this.fromWorld(Y)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(Y){return this.parent?this.parent.transform.multVec2(this.pos.add(Y)):this.pos.add(Y)},fromWorld(Y){return this.parent?this.parent.transform.invert().multVec2(Y).sub(this.pos):Y.sub(this.pos)},screenPos(Y=null){if(Y)return this.pos=this.pos.add(this.fromScreen(Y)),null;{let K=this.worldPos();return K?N2(this)?K:h1(K):null}},toScreen(Y){let K=this.toWorld(Y);return N2(this)?K:h1(K)},fromScreen(Y){return N2(this)?this.fromWorld(Y):this.fromWorld($6(Y))},toOther(Y,K){return Y.fromWorld(this.toWorld(K))},fromOther(Y,K){return Y.toOther(this,K)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){l2({color:ff(255,0,0),radius:4/pY()})}}}function PK(f){return{id:"rotate",angle:f??0,rotateBy(Y){this.angle+=Y},rotateTo(Y){this.angle=Y},inspect(){return`angle: ${Math.round(this.angle)}`}}}function v0(...f){if(f.length===0)return v0(1);let Y=y(...f);return{id:"scale",set scale(K){if(!(K instanceof E))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");Y=y(K)},get scale(){return Y},scaleTo(...K){Y=y(...K)},scaleBy(...K){Y=Y.scale(y(...K))},inspect(){return Y.x==Y.y?`scale: ${Y.x.toFixed(1)}x`:`scale: (${Y.x.toFixed(1)}x, ${Y.y.toFixed(1)}y)`}}}function TK(f){return{id:"z",z:f,inspect(){return`z: ${this.z}`}}}var DK="data:image/png;base64,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",gK="data:image/png;base64,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",uK=E3.version,$={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},vK=(f={tagsAsComponents:!0})=>{$.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),$.k.quit()),$.globalOpt=f;let Y=f.root??document.body;Y===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let K=f.canvas??Y.appendChild(document.createElement("canvas"));$.canvas=K;let A=f.scale??1;$.gscale=A;let L=f.width&&f.height&&!f.stretch&&!f.letterbox;L?(K.width=f.width*A,K.height=f.height*A):(K.width=K.parentElement.offsetWidth,K.height=K.parentElement.offsetHeight);let z=["outline: none","cursor: default"];if(L){let{width:S,height:m}=K;z.push(`width: ${S}px`),z.push(`height: ${m}px`)}else z.push("width: 100%"),z.push("height: 100%");f.crisp&&(z.push("image-rendering: pixelated"),z.push("image-rendering: crisp-edges")),K.style.cssText=z.join(";");let X=f.pixelDensity||1;$.pixelDensity=X,K.width*=X,K.height*=X,K.tabIndex=0;let I=document.createElement("canvas");I.width=256,I.height=256,$.fontCacheCanvas=I;let J=I.getContext("2d",{willReadFrequently:!0});$.fontCacheC2d=J;let H=K4({canvas:K,touchToMouse:f.touchToMouse,gamepads:f.gamepads,pixelDensity:f.pixelDensity,maxFPS:f.maxFPS,buttons:f.buttons});$.app=H;let Z=[],Q=H.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!Q)throw new Error("WebGL not supported");let q=Q,V=o4(q,{texFilter:f.texFilter}),W=K7(f,V);$.gfx=W;let N=c7();$.audio=N;let _=U4(V,f.spriteAtlasPadding??0);$.assets=_;let j=p7();$.game=j,j.root.use(T1());function M(S,m){let r=new D0(V,S,m);return{clear:()=>r.clear(),free:()=>r.free(),toDataURL:()=>r.toDataURL(),toImageData:()=>r.toImageData(),width:r.width,height:r.height,draw:(Yf)=>{pf(),r.bind(),Yf(),pf(),r.unbind()},get fb(){return r}}}function U(){q.clear(q.COLOR_BUFFER_BIT),W.frameBuffer.bind(),q.clear(q.COLOR_BUFFER_BIT),W.bgColor||H2(()=>{X0({width:jf(),height:Gf(),quad:new Xf(0,0,jf()/64,Gf()/64),tex:W.bgTex,fixed:!0})}),W.renderer.numDraws=0,W.fixed=!1,W.transformStack.length=0,W.transform=new wf}function D(S,m){W.postShader=S,W.postShaderUniform=m??null}function C(){pf(),W.lastDrawCalls=W.renderer.numDraws,W.frameBuffer.unbind(),q.viewport(0,0,q.drawingBufferWidth,q.drawingBufferHeight);let{width:S,height:m}=W;W.width=q.drawingBufferWidth/X,W.height=q.drawingBufferHeight/X,g0({flipY:!0,tex:W.frameBuffer.tex,pos:new E(W.viewport.x,W.viewport.y),width:W.viewport.width,height:W.viewport.height,shader:W.postShader,uniform:typeof W.postShaderUniform=="function"?W.postShaderUniform():W.postShaderUniform,fixed:!0}),pf(),W.width=S,W.height=m}let R=!1,G={inspect:!1,set timeScale(S){$.app.state.timeScale=S},get timeScale(){return $.app.state.timeScale},showLog:!0,fps:()=>H.fps(),numFrames:()=>H.numFrames(),stepFrame:L2,drawCalls:()=>W.lastDrawCalls,clearLog:()=>j.logs=[],log:(...S)=>{let m=f.logMax??8,r=S.length>1?S.concat(" ").join(" "):S[0];j.logs.unshift({msg:r,time:H.time()}),j.logs.length>m&&(j.logs=j.logs.slice(0,m))},error:(S)=>G.log(new Error(S.toString?S.toString():S)),curRecording:null,numObjects:()=>b("*",{recursive:!0}).length,get paused(){return R},set paused(S){R=S,S?N.ctx.suspend():N.ctx.resume()}};$.debug=G;function O(S,m){try{return JSON.parse(window.localStorage[S])}catch{return m?(P(S,m),m):null}}function P(S,m){window.localStorage[S]=JSON.stringify(m)}function T(S,...m){let r=S(gf),Yf;typeof r=="function"?Yf=r(...m)(gf):Yf=r;for(let Zf in Yf)gf[Zf]=Yf[Zf],f.global!==!1&&(window[Zf]=Yf[Zf]);return gf}function u(S){let m=H.canvas.captureStream(S),r=N.ctx.createMediaStreamDestination();N.masterNode.connect(r);let Yf=new MediaRecorder(m),Zf=[];return Yf.ondataavailable=(i)=>{i.data.size>0&&Zf.push(i.data)},Yf.onerror=()=>{N.masterNode.disconnect(r),m.getTracks().forEach((i)=>i.stop())},Yf.start(),{resume(){Yf.resume()},pause(){Yf.pause()},stop(){return Yf.stop(),N.masterNode.disconnect(r),m.getTracks().forEach((i)=>i.stop()),new Promise((i)=>{Yf.onstop=()=>{i(new Blob(Zf,{type:"video/mp4"}))}})},download(i="kaboom.mp4"){this.stop().then((Wf)=>YY(i,Wf))}}}function p(){return document.activeElement===H.canvas}let s=j.root.add.bind(j.root),d=j.root.readd.bind(j.root),w=j.root.removeAll.bind(j.root),b=j.root.get.bind(j.root),l=j.root.wait.bind(j.root),Kf=j.root.loop.bind(j.root),o=j.root.query.bind(j.root),t=j.root.tween.bind(j.root),Vf=f0(null,gK),k=f0(null,DK);$.kaSprite=Vf,$.boomSprite=k;function ef(){j.root.fixedUpdate()}function L2(){j.root.update()}class B2{source;target;normal;distance;resolved=!1;constructor(S,m,r,Yf,Zf=!1){this.source=S,this.target=m,this.normal=r,this.distance=Yf,this.resolved=Zf}get displacement(){return this.normal.scale(this.distance)}reverse(){return new B2(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(j.gravity||y(0,1))>0}isRight(){return this.displacement.cross(j.gravity||y(0,1))<0}isTop(){return this.displacement.dot(j.gravity||y(0,1))>0}isBottom(){return this.displacement.dot(j.gravity||y(0,1))<0}preventResolution(){this.resolved=!0}}function P2(){if(!_K())return;let S={},m=f.hashGridSize||64,r=new wf,Yf=[];function Zf(i){if(Yf.push(r.clone()),i.pos&&r.translate(i.pos),i.scale&&r.scale(i.scale),i.angle&&r.rotate(i.angle),i.transform=r.clone(),i.c("area")&&!i.paused){let Wf=i,cf=Wf.worldArea().bbox(),c=Math.floor(cf.pos.x/m),qf=Math.floor(cf.pos.y/m),s2=Math.ceil((cf.pos.x+cf.width)/m),Q1=Math.ceil((cf.pos.y+cf.height)/m),j0=new Set;for(let rf=c;rf<=s2;rf++)for(let X2=qf;X2<=Q1;X2++)if(!S[rf])S[rf]={},S[rf][X2]=[Wf];else if(!S[rf][X2])S[rf][X2]=[Wf];else{let R0=S[rf][X2];f:for(let Of of R0){if(Of.paused||!Of.exists()||j0.has(Of.id))continue;for(let f2 of Wf.collisionIgnore)if(Of.is(f2))continue f;for(let f2 of Of.collisionIgnore)if(Wf.is(f2))continue f;let d2=q8(Wf.worldArea(),Of.worldArea());if(d2){let f2=new B2(Wf,Of,d2.normal,d2.distance);Wf.trigger("collideUpdate",Of,f2);let N0=f2.reverse();N0.resolved=f2.resolved,Of.trigger("collideUpdate",Wf,N0)}j0.add(Of.id)}R0.push(Wf)}}i.children.forEach(Zf),r=Yf.pop()}Zf(j.root)}function T2(S){console.error(S),N.ctx.suspend();let m=S.message??String(S)??"Unknown error, check console for more info";H.run(()=>{},()=>{U(),H2(()=>{let r=jf(),Yf=Gf(),Zf={size:36,width:r-64,letterSpacing:4,lineSpacing:4,font:P0,fixed:!0};lf({width:r,height:Yf,color:ff(0,0,255),fixed:!0});let i=F2({...Zf,text:"Error",pos:y(32),color:ff(255,128,0),fixed:!0});E2(i),qY({...Zf,text:m,pos:y(32,32+i.height+16),fixed:!0}),Uf(),j.events.trigger("error",S)}),C()})}function c2(S){Z.push(S)}function r2(){j.events.onOnce("frameEnd",()=>{H.quit(),q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT|q.STENCIL_BUFFER_BIT);let S=q.getParameter(q.MAX_TEXTURE_IMAGE_UNITS);for(let m=0;m<S;m++)q.activeTexture(q.TEXTURE0+m),q.bindTexture(q.TEXTURE_2D,null),q.bindTexture(q.TEXTURE_CUBE_MAP,null);q.bindBuffer(q.ARRAY_BUFFER,null),q.bindBuffer(q.ELEMENT_ARRAY_BUFFER,null),q.bindRenderbuffer(q.RENDERBUFFER,null),q.bindFramebuffer(q.FRAMEBUFFER,null),V.destroy(),Z.forEach((m)=>m())})}let z2=!0;H.run(()=>{try{_.loaded&&(G.paused||ef(),P2())}catch(S){T2(S)}},(S,m)=>{try{S(),_.loaded||y2()===1&&!z2&&(_.loaded=!0,lY().forEach((r)=>j.events.trigger("loadError",...r)),j.events.trigger("load")),!_.loaded&&f.loadingScreen!==!1||z2?(U(),t4(),C()):(G.paused||L2(),P2(),U(),n4(),f.debug!==!1&&i4(),C()),z2&&(z2=!1),j.events.trigger("frameEnd"),m()}catch(r){T2(r)}}),SY(),B6();let gf={_k:$,VERSION:uK,loadRoot:M4,loadProgress:y2,loadSprite:f0,loadSpriteAtlas:aY,loadSound:m4,loadMusic:c4,loadBitmapFont:u4,loadFont:D4,loadShader:l4,loadShaderURL:k4,loadAseprite:T4,loadPedit:v4,loadBean:P4,loadJSON:O4,load:O1,getSound:dY,getFont:cY,getBitmapFont:rY,getSprite:kY,getShader:sY,getAsset:x4,Asset:bf,SpriteData:q2,SoundData:z0,width:jf,height:Gf,center:T0,dt:_f,fixedDt:C1,restDt:M1,time:H.time,screenshot:H.screenshot,record:u,isFocused:p,setCursor:H.setCursor,getCursor:H.getCursor,setCursorLocked:H.setCursorLocked,isCursorLocked:H.isCursorLocked,setFullscreen:H.setFullscreen,isFullscreen:H.isFullscreen,isTouchscreen:H.isTouchscreen,onLoad:o1,onLoadError:h7,onLoading:O7,onResize:x7,onGamepadConnect:H.onGamepadConnect,onGamepadDisconnect:H.onGamepadDisconnect,onError:U7,onCleanup:c2,flash:q6,setCamPos:z6,getCamPos:X6,setCamRot:I6,getCamRot:Z6,setCamScale:H6,getCamScale:J6,getCamTransform:P7,camPos:g7,camScale:u7,camFlash:S7,camRot:v7,camTransform:T7,shake:D7,toScreen:h1,toWorld:$6,setGravity:l7,getGravity:k7,setGravityDirection:b7,getGravityDirection:Y0,setBackground:N4,getBackground:G4,getGamepads:H.getGamepads,getTreeRoot:n7,add:s,make:i1,destroy:j6,destroyAll:w,get:b,query:o,readd:d,pos:u0,scale:v0,rotate:PK,color:tY,opacity:eY,anchor:g1,area:jK,sprite:P1,text:KK,polygon:Z7,rect:Y6,circle:A7,uvquad:AK,outline:H7,particles:I7,body:RK,platformEffector:CK,surfaceEffector:GK,areaEffector:yK,pointEffector:FK,buoyancyEffector:MK,constantForce:EK,doubleJump:NK,shader:q7,textInput:BK,timer:T1,fixed:y6,stay:G6,health:$K,lifespan:QK,named:VK,state:WK,z:TK,layer:xK,move:UK,offscreen:hK,follow:OK,fadeIn:z7,mask:X7,drawon:L7,raycast:f6,tile:R6,animate:qK,serializeAnimation:N6,agent:LK,sentry:HK,patrol:XK,pathfinder:zK,trigger:Q7,on:Df,onFixedUpdate:V7,onUpdate:K6,onDraw:W7,onAdd:A6,onDestroy:B7,onTag:L6,onUntag:R7,onUse:_7,onUnuse:j7,onClick:F7,onCollide:N7,onCollideUpdate:G7,onCollideEnd:y7,onHover:E7,onHoverUpdate:C7,onHoverEnd:M7,onKeyDown:H.onKeyDown,onKeyPress:H.onKeyPress,onKeyPressRepeat:H.onKeyPressRepeat,onKeyRelease:H.onKeyRelease,onMouseDown:H.onMouseDown,onMousePress:H.onMousePress,onMouseRelease:H.onMouseRelease,onMouseMove:H.onMouseMove,onCharInput:H.onCharInput,onTouchStart:H.onTouchStart,onTouchMove:H.onTouchMove,onTouchEnd:H.onTouchEnd,onScroll:H.onScroll,onHide:H.onHide,onShow:H.onShow,onGamepadButtonDown:H.onGamepadButtonDown,onGamepadButtonPress:H.onGamepadButtonPress,onGamepadButtonRelease:H.onGamepadButtonRelease,onGamepadStick:H.onGamepadStick,onButtonPress:H.onButtonPress,onButtonDown:H.onButtonDown,onButtonRelease:H.onButtonRelease,mousePos:H.mousePos,mouseDeltaPos:H.mouseDeltaPos,isKeyDown:H.isKeyDown,isKeyPressed:H.isKeyPressed,isKeyPressedRepeat:H.isKeyPressedRepeat,isKeyReleased:H.isKeyReleased,isMouseDown:H.isMouseDown,isMousePressed:H.isMousePressed,isMouseReleased:H.isMouseReleased,isMouseMoved:H.isMouseMoved,isGamepadButtonPressed:H.isGamepadButtonPressed,isGamepadButtonDown:H.isGamepadButtonDown,isGamepadButtonReleased:H.isGamepadButtonReleased,getGamepadStick:H.getGamepadStick,isButtonPressed:H.isButtonPressed,isButtonDown:H.isButtonDown,isButtonReleased:H.isButtonReleased,setButton:H.setButton,getButton:H.getButton,pressButton:H.pressButton,releaseButton:H.releaseButton,getLastInputDeviceType:H.getLastInputDeviceType,charInputted:H.charInputted,loop:Kf,wait:l,play:s7,setVolume:V6,getVolume:W6,volume:d7,burp:Q6,audioCtx:N.ctx,Line:Tf,Rect:Af,Circle:Pf,Ellipse:K2,Point:a3,Polygon:Ef,Vec2:E,Color:a,Mat4:wf,Quad:Xf,RNG:WY,rand:Bf,randi:BY,randSeed:U3,vec2:y,rgb:ff,hsl2rgb:C3,quad:$f,choose:T3,chooseMultiple:P3,shuffle:_Y,chance:h3,lerp:hf,tween:t,easings:A0,map:df,mapc:M3,wave:VY,deg2rad:Qf,rad2deg:G2,clamp:af,evaluateQuadratic:o3,evaluateQuadraticFirstDerivative:i3,evaluateQuadraticSecondDerivative:n3,evaluateBezier:b1,evaluateBezierFirstDerivative:t3,evaluateBezierSecondDerivative:e3,evaluateCatmullRom:f8,evaluateCatmullRomFirstDerivative:Y8,curveLengthApproximation:MY,normalizedCurve:K8,hermite:J0,cardinal:OY,catmullRom:h0,bezier:A8,kochanekBartels:L8,easingSteps:Z8,easingLinear:J8,easingCubicBezier:I8,testLineLine:u1,testRectRect:jY,testRectLine:v1,testRectPoint:S0,testCirclePolygon:l0,testLinePoint:S1,testLineCircle:H0,isConvex:B8,triangulate:UY,NavMesh:j4,drawSprite:f7,drawText:qY,formatText:F2,drawRect:lf,drawLine:n2,drawLines:w1,drawTriangle:iY,drawCircle:l2,drawEllipse:wY,drawUVQuad:X0,drawPolygon:J2,drawCurve:oY,drawBezier:a4,drawFormattedText:E2,drawMasked:e4,drawSubtracted:Y7,pushTransform:Sf,popTransform:Uf,pushTranslate:Hf,pushScale:L0,pushRotate:v2,pushMatrix:y4,usePostEffect:D,makeCanvas:M,debug:G,scene:t7,getSceneName:YK,go:e7,onSceneLeave:fK,layers:i7,getLayers:w7,setLayers:_6,getDefaultLayer:o7,addLevel:$7,getData:O,setData:P,download:c1,downloadJSON:T8,downloadText:uY,downloadBlob:YY,plug:T,ASCII_CHARS:hY,canvas:H.canvas,addKaboom:a7,LEFT:E.LEFT,RIGHT:E.RIGHT,UP:E.UP,DOWN:E.DOWN,RED:a.RED,GREEN:a.GREEN,BLUE:a.BLUE,YELLOW:a.YELLOW,MAGENTA:a.MAGENTA,CYAN:a.CYAN,WHITE:a.WHITE,BLACK:a.BLACK,quit:r2,KEvent:Ff,KEventHandler:K0,KEventController:M2,cancel:()=>TY};$.k=gf;let D2=f.plugins;if(D2&&D2.forEach(T),f.global!==!1)for(let S in gf)window[S]=gf[S];return f.focus!==!1&&H.canvas.focus(),gf},F6=vK;function t1(){return F6({background:[0,0,0],width:1280,height:720,scale:2,debug:!0,debugKey:"p",letterbox:!0,global:!1,maxFPS:30})}function of(f,Y){if(Y.isZero())return Y;let K=f.width(),A=f.height();return f.vec2(K*Y.x,A*Y.y)}function E6({k:f,sizePercentage:Y,color:K,posPercentage:A=f.vec2(),opacity:L=1,fixed:z=!1}){let X=of(f,A),I=of(f,Y);return function(){f.drawRect({pos:X,width:I.x,height:I.y,color:f.rgb(K),anchor:"center",opacity:L,fixed:z})}}function mf(f){return E6(f)}function Jf({k:f,text:Y,posPercentage:K,scale:A=1,inactive:L=!1,fixed:z=!1}){let X=of(f,K),I=L?"#888888":"#CCCCCC",J=f.rgb(I);return function(){f.drawText({text:Y,pos:X,color:J,scale:A,anchor:"center",fixed:z})}}function Cf({k:f,posPercentage:Y,sizePercentage:K,onClick:A,fixed:L=!1,text:z,scale:X=1}){let I=of(f,Y),J=of(f,K),H=Jf({k:f,posPercentage:Y,fixed:L,text:z,scale:X}),Z=f.add([f.pos(I),f.rect(J.x,J.y),f.color("#2563EB"),f.opacity(0.8),f.area(),f.timer(),L?f.fixed():null,{setText(Q){H=Jf({k:f,posPercentage:Y,fixed:L,text:Q,scale:X})}}]);return Z.onHover(()=>{Z.use(f.opacity(1)),f.setCursor("pointer")}),Z.onHoverEnd(()=>{Z.use(f.opacity(0.8)),f.setCursor("default")}),Z.onDraw(()=>{H()}),Z.onClick(()=>A()),Z}function C6({k:f}){f.scene("menu",()=>{mf({k:f,sizePercentage:f.vec2(1,1),color:"#1F1F1F"}),Jf({k:f,text:"Welcome to the Sember",posPercentage:f.vec2(0.5,0.3),scale:2}),Cf({k:f,text:"Join Room",posPercentage:f.vec2(0.3,0.65),sizePercentage:f.vec2(0.3,0.2),onClick:function(){if(navigator.onLine)f.go("join");else f.go("offline")},scale:1.5}),Cf({k:f,text:"Offline",posPercentage:f.vec2(0.7,0.65),sizePercentage:f.vec2(0.25,0.2),onClick:function(){f.go("offline")},scale:1.5})})}function A2({k:f,message:Y,duration:K,callback:A}){let L=f.add([f.timer()]);function z(){if(L.destroy(),A)A()}let X=mf({k:f,posPercentage:f.vec2(0.1,0.1),sizePercentage:f.vec2(0.8,0.8),color:"#1F1F1F"}),I=Jf({k:f,text:"Alert",posPercentage:f.vec2(0.5,0.25),scale:1.5}),J=Jf({k:f,text:Y,posPercentage:f.vec2(0.5,0.5)});Cf({k:f,posPercentage:f.vec2(0.5,0.8),sizePercentage:f.vec2(0.2,0.1),onClick:()=>z(),fixed:!1,text:"OK"}),L.onDraw(()=>{X(),I(),J()}),L.wait(K,()=>z())}function e1({k:f,server:Y}){f.scene("waiting",()=>{mf({k:f,sizePercentage:f.vec2(1,1),color:"#1F1F1F"}),Jf({k:f,text:"Waiting for Players...",scale:1.5,posPercentage:f.vec2(0.5,0.1)}),Jf({k:f,text:"Host Name:",posPercentage:f.vec2(0.25,0.3)});let K=Y.getHostId();if(K==null){A2({k:f,message:"Host ID is undefined",duration:3,callback:()=>f.go("join")});return}Jf({k:f,text:Y.getPlayerData(K).getUsername().slice(0,20),posPercentage:f.vec2(0.65,0.3)}),Jf({k:f,text:"Room ID:",posPercentage:f.vec2(0.25,0.4)});let A=Cf({k:f,posPercentage:f.vec2(0.2,0.6),sizePercentage:f.vec2(0.2,0.1),text:"Copy ID",onClick:()=>{navigator.clipboard.writeText(K).then(()=>{A.setText("Copied!"),A.wait(1,()=>{A.setText("Copy ID")})}).catch(()=>{A2({k:f,message:"Failed to copy Room ID:",duration:3})})}});Cf({k:f,posPercentage:f.vec2(0.5,0.6),sizePercentage:f.vec2(0.3,0.1),text:"Enter World",onClick:()=>{f.go("world")}});let L=Y.getPlayers(),z=0;Object.keys(L).sort().forEach((X)=>{let I=L[X],J=0.1*z;Jf({k:f,text:`player #${z++}: ${I.getUsername().slice(0,8)}`,posPercentage:f.vec2(0.5,0.5+J)})})})}function f5({k:f,text:Y,posPercentage:K,onClick:A,placeholder:L,fixed:z=!1,scale:X=1}){let I=of(f,K),J=f.add([f.text(L),f.pos(I),f.area(),f.anchor("center"),f.scale(X),z?f.fixed():!1,{onChange({newText:H}){if(H){J.use(f.text(H)),J.use(f.color(f.rgb("#CCCCCC")));return}J.use(f.text(L)),J.use(f.color(f.rgb("#888888")))}}]);return J.onChange({newText:Y}),J.onClick(()=>A()),J}function Y5({k:f,server:Y}){f.scene("join",()=>{mf({k:f,sizePercentage:f.vec2(1,1),color:"#1F1F1F"});let K=!0,A=!1;Cf({k:f,posPercentage:f.vec2(0.1,0.1),sizePercentage:f.vec2(0.15,0.1),text:"Offline",onClick:()=>f.go("offline")}),Jf({k:f,text:"Player data",posPercentage:f.vec2(0.5,0.2),scale:1.5}),Jf({k:f,text:"Username:",posPercentage:f.vec2(0.25,0.45)});let L=f5({k:f,placeholder:"<Enter Username>",scale:1,posPercentage:f.vec2(0.65,0.45),onClick:()=>{let Z=prompt("Enter your username:");if(Z!==null)L.use(f.text(Z.slice(0,20))),L.use(f.color("#CCCCCC"))}});Jf({k:f,text:"Host ID:",posPercentage:f.vec2(0.25,0.55)});let z=f5({k:f,placeholder:"<Enter Host ID>",text:"Default ID: PUBLIC ROOM",posPercentage:f.vec2(0.65,0.55),onClick:()=>{if(K)return;let Z=prompt("Enter the Host ID:");if(Z!==null)z.use(f.text(`${Z.slice(0,20)}`)),z.use("#CCCCCC");else if(z.text===""||z.text==="<Enter Host ID>")z.use(f.text("<Enter Host ID>")),z.use("#888888")}}),X=Cf({k:f,posPercentage:f.vec2(0.3,0.8),sizePercentage:f.vec2(0.45,0.1),text:"Use Default Host ID: Yes",onClick:()=>{K=!K,X.setText(`Use Default Host ID: ${K?"Yes":"No"}`),I()}}),I=()=>{if(K)z.use(f.text("Default ID: PUBLIC ROOM")),z.use("#888888"),f.setCursor("default");else{if(z.text==="Default ID: PUBLIC ROOM"||z.text==="")z.use(f.text("<Enter Host ID>")),z.use("#CCCCCC");f.setCursor("pointer")}};I();let J=function(){if(A){A2({k:f,message:"Please wait, connecting to the network",duration:3});return}A=!0;let Z=L.text,Q=z.text;if(K)Q="cc934d7d02a0d9a175b8c60bb0ff326d77fca920";if(Z==="<Enter Username>"){A2({k:f,message:"Enter your username",duration:3}),A=!1;return}if(Q==="<Enter Host ID>"){A2({k:f,message:"Enter your host ID",duration:3}),A=!1;return}H.setText("Connecting..."),Y.joinRoom(Z,Q,()=>f.go("waiting"))},H=Cf({k:f,posPercentage:f.vec2(0.75,0.8),sizePercentage:f.vec2(0.25,0.1),text:"Connect",scale:1,onClick:()=>J()})})}class M6{constructor(){this.encoder=new TextEncoder,this._pieces=[],this._parts=[]}append_buffer(f){this.flush(),this._parts.push(f)}append(f){this._pieces.push(f)}flush(){if(this._pieces.length>0){let f=new Uint8Array(this._pieces);this._parts.push(f),this._pieces=[]}}toArrayBuffer(){let f=[];for(let Y of this._parts)f.push(Y);return SK(f).buffer}}function SK(f){let Y=0;for(let L of f)Y+=L.byteLength;let K=new Uint8Array(Y),A=0;for(let L of f){let z=new Uint8Array(L.buffer,L.byteOffset,L.byteLength);K.set(z,A),A+=L.byteLength}return K}function K5(f){return new O6(f).unpack()}function A5(f){let Y=new x6,K=Y.pack(f);if(K instanceof Promise)return K.then(()=>Y.getBuffer());return Y.getBuffer()}class O6{constructor(f){this.index=0,this.dataBuffer=f,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}unpack(){let f=this.unpack_uint8();if(f<128)return f;else if((f^224)<32)return(f^224)-32;let Y;if((Y=f^160)<=15)return this.unpack_raw(Y);else if((Y=f^176)<=15)return this.unpack_string(Y);else if((Y=f^144)<=15)return this.unpack_array(Y);else if((Y=f^128)<=15)return this.unpack_map(Y);switch(f){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return Y=this.unpack_uint16(),this.unpack_string(Y);case 217:return Y=this.unpack_uint32(),this.unpack_string(Y);case 218:return Y=this.unpack_uint16(),this.unpack_raw(Y);case 219:return Y=this.unpack_uint32(),this.unpack_raw(Y);case 220:return Y=this.unpack_uint16(),this.unpack_array(Y);case 221:return Y=this.unpack_uint32(),this.unpack_array(Y);case 222:return Y=this.unpack_uint16(),this.unpack_map(Y);case 223:return Y=this.unpack_uint32(),this.unpack_map(Y)}}unpack_uint8(){let f=this.dataView[this.index]&255;return this.index++,f}unpack_uint16(){let f=this.read(2),Y=(f[0]&255)*256+(f[1]&255);return this.index+=2,Y}unpack_uint32(){let f=this.read(4),Y=((f[0]*256+f[1])*256+f[2])*256+f[3];return this.index+=4,Y}unpack_uint64(){let f=this.read(8),Y=((((((f[0]*256+f[1])*256+f[2])*256+f[3])*256+f[4])*256+f[5])*256+f[6])*256+f[7];return this.index+=8,Y}unpack_int8(){let f=this.unpack_uint8();return f<128?f:f-256}unpack_int16(){let f=this.unpack_uint16();return f<32768?f:f-65536}unpack_int32(){let f=this.unpack_uint32();return f<2147483648?f:f-4294967296}unpack_int64(){let f=this.unpack_uint64();return f<9223372036854776000?f:f-18446744073709552000}unpack_raw(f){if(this.length<this.index+f)throw new Error(`BinaryPackFailure: index is out of range ${this.index} ${f} ${this.length}`);let Y=this.dataBuffer.slice(this.index,this.index+f);return this.index+=f,Y}unpack_string(f){let Y=this.read(f),K=0,A="",L,z;while(K<f){if(L=Y[K],L<160)z=L,K++;else if((L^192)<32)z=(L&31)<<6|Y[K+1]&63,K+=2;else if((L^224)<16)z=(L&15)<<12|(Y[K+1]&63)<<6|Y[K+2]&63,K+=3;else z=(L&7)<<18|(Y[K+1]&63)<<12|(Y[K+2]&63)<<6|Y[K+3]&63,K+=4;A+=String.fromCodePoint(z)}return this.index+=f,A}unpack_array(f){let Y=new Array(f);for(let K=0;K<f;K++)Y[K]=this.unpack();return Y}unpack_map(f){let Y={};for(let K=0;K<f;K++){let A=this.unpack();Y[A]=this.unpack()}return Y}unpack_float(){let f=this.unpack_uint32(),Y=f>>31,K=(f>>23&255)-127,A=f&8388607|8388608;return(Y===0?1:-1)*A*2**(K-23)}unpack_double(){let f=this.unpack_uint32(),Y=this.unpack_uint32(),K=f>>31,A=(f>>20&2047)-1023,z=(f&1048575|1048576)*2**(A-20)+Y*2**(A-52);return(K===0?1:-1)*z}read(f){let Y=this.index;if(Y+f<=this.length)return this.dataView.subarray(Y,Y+f);else throw new Error("BinaryPackFailure: read index out of range")}}class x6{getBuffer(){return this._bufferBuilder.toArrayBuffer()}pack(f){if(typeof f==="string")this.pack_string(f);else if(typeof f==="number")if(Math.floor(f)===f)this.pack_integer(f);else this.pack_double(f);else if(typeof f==="boolean"){if(f===!0)this._bufferBuilder.append(195);else if(f===!1)this._bufferBuilder.append(194)}else if(f===void 0)this._bufferBuilder.append(192);else if(typeof f==="object")if(f===null)this._bufferBuilder.append(192);else{let Y=f.constructor;if(f instanceof Array){let K=this.pack_array(f);if(K instanceof Promise)return K.then(()=>this._bufferBuilder.flush())}else if(f instanceof ArrayBuffer)this.pack_bin(new Uint8Array(f));else if("BYTES_PER_ELEMENT"in f){let K=f;this.pack_bin(new Uint8Array(K.buffer,K.byteOffset,K.byteLength))}else if(f instanceof Date)this.pack_string(f.toString());else if(f instanceof Blob)return f.arrayBuffer().then((K)=>{this.pack_bin(new Uint8Array(K)),this._bufferBuilder.flush()});else if(Y==Object||Y.toString().startsWith("class")){let K=this.pack_object(f);if(K instanceof Promise)return K.then(()=>this._bufferBuilder.flush())}else throw new Error(`Type "${Y.toString()}" not yet supported`)}else throw new Error(`Type "${typeof f}" not yet supported`);this._bufferBuilder.flush()}pack_bin(f){let Y=f.length;if(Y<=15)this.pack_uint8(160+Y);else if(Y<=65535)this._bufferBuilder.append(218),this.pack_uint16(Y);else if(Y<=4294967295)this._bufferBuilder.append(219),this.pack_uint32(Y);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(f)}pack_string(f){let Y=this._textEncoder.encode(f),K=Y.length;if(K<=15)this.pack_uint8(176+K);else if(K<=65535)this._bufferBuilder.append(216),this.pack_uint16(K);else if(K<=4294967295)this._bufferBuilder.append(217),this.pack_uint32(K);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(Y)}pack_array(f){let Y=f.length;if(Y<=15)this.pack_uint8(144+Y);else if(Y<=65535)this._bufferBuilder.append(220),this.pack_uint16(Y);else if(Y<=4294967295)this._bufferBuilder.append(221),this.pack_uint32(Y);else throw new Error("Invalid length");let K=(A)=>{if(A<Y){let L=this.pack(f[A]);if(L instanceof Promise)return L.then(()=>K(A+1));return K(A+1)}};return K(0)}pack_integer(f){if(f>=-32&&f<=127)this._bufferBuilder.append(f&255);else if(f>=0&&f<=255)this._bufferBuilder.append(204),this.pack_uint8(f);else if(f>=-128&&f<=127)this._bufferBuilder.append(208),this.pack_int8(f);else if(f>=0&&f<=65535)this._bufferBuilder.append(205),this.pack_uint16(f);else if(f>=-32768&&f<=32767)this._bufferBuilder.append(209),this.pack_int16(f);else if(f>=0&&f<=4294967295)this._bufferBuilder.append(206),this.pack_uint32(f);else if(f>=-2147483648&&f<=2147483647)this._bufferBuilder.append(210),this.pack_int32(f);else if(f>=-9223372036854776000&&f<=9223372036854776000)this._bufferBuilder.append(211),this.pack_int64(f);else if(f>=0&&f<=18446744073709552000)this._bufferBuilder.append(207),this.pack_uint64(f);else throw new Error("Invalid integer")}pack_double(f){let Y=0;if(f<0)Y=1,f=-f;let K=Math.floor(Math.log(f)/Math.LN2),A=f/2**K-1,L=Math.floor(A*4503599627370496),z=4294967296,X=Y<<31|K+1023<<20|L/z&1048575,I=L%z;this._bufferBuilder.append(203),this.pack_int32(X),this.pack_int32(I)}pack_object(f){let Y=Object.keys(f),K=Y.length;if(K<=15)this.pack_uint8(128+K);else if(K<=65535)this._bufferBuilder.append(222),this.pack_uint16(K);else if(K<=4294967295)this._bufferBuilder.append(223),this.pack_uint32(K);else throw new Error("Invalid length");let A=(L)=>{if(L<Y.length){let z=Y[L];if(f.hasOwnProperty(z)){this.pack(z);let X=this.pack(f[z]);if(X instanceof Promise)return X.then(()=>A(L+1))}return A(L+1)}};return A(0)}pack_uint8(f){this._bufferBuilder.append(f)}pack_uint16(f){this._bufferBuilder.append(f>>8),this._bufferBuilder.append(f&255)}pack_uint32(f){let Y=f&4294967295;this._bufferBuilder.append((Y&4278190080)>>>24),this._bufferBuilder.append((Y&16711680)>>>16),this._bufferBuilder.append((Y&65280)>>>8),this._bufferBuilder.append(Y&255)}pack_uint64(f){let Y=f/4294967296,K=f%4294967296;this._bufferBuilder.append((Y&4278190080)>>>24),this._bufferBuilder.append((Y&16711680)>>>16),this._bufferBuilder.append((Y&65280)>>>8),this._bufferBuilder.append(Y&255),this._bufferBuilder.append((K&4278190080)>>>24),this._bufferBuilder.append((K&16711680)>>>16),this._bufferBuilder.append((K&65280)>>>8),this._bufferBuilder.append(K&255)}pack_int8(f){this._bufferBuilder.append(f&255)}pack_int16(f){this._bufferBuilder.append((f&65280)>>8),this._bufferBuilder.append(f&255)}pack_int32(f){this._bufferBuilder.append(f>>>24&255),this._bufferBuilder.append((f&16711680)>>>16),this._bufferBuilder.append((f&65280)>>>8),this._bufferBuilder.append(f&255)}pack_int64(f){let Y=Math.floor(f/4294967296),K=f%4294967296;this._bufferBuilder.append((Y&4278190080)>>>24),this._bufferBuilder.append((Y&16711680)>>>16),this._bufferBuilder.append((Y&65280)>>>8),this._bufferBuilder.append(Y&255),this._bufferBuilder.append((K&4278190080)>>>24),this._bufferBuilder.append((K&16711680)>>>16),this._bufferBuilder.append((K&65280)>>>8),this._bufferBuilder.append(K&255)}constructor(){this._bufferBuilder=new M6,this._textEncoder=new TextEncoder}}var h6=!0,P6=!0;function k2(f,Y,K){let A=f.match(Y);return A&&A.length>=K&&parseFloat(A[K],10)}function nf(f,Y,K){if(!f.RTCPeerConnection)return;let A=f.RTCPeerConnection.prototype,L=A.addEventListener;A.addEventListener=function(X,I){if(X!==Y)return L.apply(this,arguments);let J=(H)=>{let Z=K(H);if(Z)if(I.handleEvent)I.handleEvent(Z);else I(Z)};if(this._eventMap=this._eventMap||{},!this._eventMap[Y])this._eventMap[Y]=new Map;return this._eventMap[Y].set(I,J),L.apply(this,[X,J])};let z=A.removeEventListener;A.removeEventListener=function(X,I){if(X!==Y||!this._eventMap||!this._eventMap[Y])return z.apply(this,arguments);if(!this._eventMap[Y].has(I))return z.apply(this,arguments);let J=this._eventMap[Y].get(I);if(this._eventMap[Y].delete(I),this._eventMap[Y].size===0)delete this._eventMap[Y];if(Object.keys(this._eventMap).length===0)delete this._eventMap;return z.apply(this,[X,J])},Object.defineProperty(A,"on"+Y,{get(){return this["_on"+Y]},set(X){if(this["_on"+Y])this.removeEventListener(Y,this["_on"+Y]),delete this["_on"+Y];if(X)this.addEventListener(Y,this["_on"+Y]=X)},enumerable:!0,configurable:!0})}function T6(f){if(typeof f!=="boolean")return new Error("Argument type: "+typeof f+". Please use a boolean.");return h6=f,f?"adapter.js logging disabled":"adapter.js logging enabled"}function D6(f){if(typeof f!=="boolean")return new Error("Argument type: "+typeof f+". Please use a boolean.");return P6=!f,"adapter.js deprecation warnings "+(f?"disabled":"enabled")}function r0(){if(typeof window==="object"){if(h6)return;if(typeof console!=="undefined"&&typeof console.log==="function")console.log.apply(console,arguments)}}function b2(f,Y){if(!P6)return;console.warn(f+" is deprecated, please use "+Y+" instead.")}function g6(f){let Y={browser:null,version:null};if(typeof f==="undefined"||!f.navigator||!f.navigator.userAgent)return Y.browser="Not a browser.",Y;let{navigator:K}=f;if(K.userAgentData&&K.userAgentData.brands){let A=K.userAgentData.brands.find((L)=>{return L.brand==="Chromium"});if(A)return{browser:"chrome",version:parseInt(A.version,10)}}if(K.mozGetUserMedia)Y.browser="firefox",Y.version=parseInt(k2(K.userAgent,/Firefox\/(\d+)\./,1));else if(K.webkitGetUserMedia||f.isSecureContext===!1&&f.webkitRTCPeerConnection)Y.browser="chrome",Y.version=parseInt(k2(K.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(f.RTCPeerConnection&&K.userAgent.match(/AppleWebKit\/(\d+)\./))Y.browser="safari",Y.version=parseInt(k2(K.userAgent,/AppleWebKit\/(\d+)\./,1)),Y.supportsUnifiedPlan=f.RTCRtpTransceiver&&"currentDirection"in f.RTCRtpTransceiver.prototype,Y._safariVersion=k2(K.userAgent,/Version\/(\d+(\.?\d+))/,1);else return Y.browser="Not a supported browser.",Y;return Y}function U6(f){return Object.prototype.toString.call(f)==="[object Object]"}function z5(f){if(!U6(f))return f;return Object.keys(f).reduce(function(Y,K){let A=U6(f[K]),L=A?z5(f[K]):f[K],z=A&&!Object.keys(L).length;if(L===void 0||z)return Y;return Object.assign(Y,{[K]:L})},{})}function L5(f,Y,K){if(!Y||K.has(Y.id))return;K.set(Y.id,Y),Object.keys(Y).forEach((A)=>{if(A.endsWith("Id"))L5(f,f.get(Y[A]),K);else if(A.endsWith("Ids"))Y[A].forEach((L)=>{L5(f,f.get(L),K)})})}function X5(f,Y,K){let A=K?"outbound-rtp":"inbound-rtp",L=new Map;if(Y===null)return L;let z=[];return f.forEach((X)=>{if(X.type==="track"&&X.trackIdentifier===Y.id)z.push(X)}),z.forEach((X)=>{f.forEach((I)=>{if(I.type===A&&I.trackId===X.id)L5(f,I,L)})}),L}var a0={};y0(a0,{shimSenderReceiverGetStats:()=>Z5,shimPeerConnection:()=>d0,shimOnTrack:()=>J5,shimMediaStream:()=>H5,shimGetUserMedia:()=>s0,shimGetSendersWithDtmf:()=>I5,shimAddTrackRemoveTrackWithNative:()=>v6,shimAddTrackRemoveTrack:()=>q5,fixNegotiationNeeded:()=>$5});var u6=r0;function s0(f,Y){let K=f&&f.navigator;if(!K.mediaDevices)return;let A=function(I){if(typeof I!=="object"||I.mandatory||I.optional)return I;let J={};if(Object.keys(I).forEach((H)=>{if(H==="require"||H==="advanced"||H==="mediaSource")return;let Z=typeof I[H]==="object"?I[H]:{ideal:I[H]};if(Z.exact!==void 0&&typeof Z.exact==="number")Z.min=Z.max=Z.exact;let Q=function(q,V){if(q)return q+V.charAt(0).toUpperCase()+V.slice(1);return V==="deviceId"?"sourceId":V};if(Z.ideal!==void 0){J.optional=J.optional||[];let q={};if(typeof Z.ideal==="number")q[Q("min",H)]=Z.ideal,J.optional.push(q),q={},q[Q("max",H)]=Z.ideal,J.optional.push(q);else q[Q("",H)]=Z.ideal,J.optional.push(q)}if(Z.exact!==void 0&&typeof Z.exact!=="number")J.mandatory=J.mandatory||{},J.mandatory[Q("",H)]=Z.exact;else["min","max"].forEach((q)=>{if(Z[q]!==void 0)J.mandatory=J.mandatory||{},J.mandatory[Q(q,H)]=Z[q]})}),I.advanced)J.optional=(J.optional||[]).concat(I.advanced);return J},L=function(I,J){if(Y.version>=61)return J(I);if(I=JSON.parse(JSON.stringify(I)),I&&typeof I.audio==="object"){let H=function(Z,Q,q){if(Q in Z&&!(q in Z))Z[q]=Z[Q],delete Z[Q]};I=JSON.parse(JSON.stringify(I)),H(I.audio,"autoGainControl","googAutoGainControl"),H(I.audio,"noiseSuppression","googNoiseSuppression"),I.audio=A(I.audio)}if(I&&typeof I.video==="object"){let H=I.video.facingMode;H=H&&(typeof H==="object"?H:{ideal:H});let Z=Y.version<66;if(H&&(H.exact==="user"||H.exact==="environment"||H.ideal==="user"||H.ideal==="environment")&&!(K.mediaDevices.getSupportedConstraints&&K.mediaDevices.getSupportedConstraints().facingMode&&!Z)){delete I.video.facingMode;let Q;if(H.exact==="environment"||H.ideal==="environment")Q=["back","rear"];else if(H.exact==="user"||H.ideal==="user")Q=["front"];if(Q)return K.mediaDevices.enumerateDevices().then((q)=>{q=q.filter((W)=>W.kind==="videoinput");let V=q.find((W)=>Q.some((N)=>W.label.toLowerCase().includes(N)));if(!V&&q.length&&Q.includes("back"))V=q[q.length-1];if(V)I.video.deviceId=H.exact?{exact:V.deviceId}:{ideal:V.deviceId};return I.video=A(I.video),u6("chrome: "+JSON.stringify(I)),J(I)})}I.video=A(I.video)}return u6("chrome: "+JSON.stringify(I)),J(I)},z=function(I){if(Y.version>=64)return I;return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[I.name]||I.name,message:I.message,constraint:I.constraint||I.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},X=function(I,J,H){L(I,(Z)=>{K.webkitGetUserMedia(Z,J,(Q)=>{if(H)H(z(Q))})})};if(K.getUserMedia=X.bind(K),K.mediaDevices.getUserMedia){let I=K.mediaDevices.getUserMedia.bind(K.mediaDevices);K.mediaDevices.getUserMedia=function(J){return L(J,(H)=>I(H).then((Z)=>{if(H.audio&&!Z.getAudioTracks().length||H.video&&!Z.getVideoTracks().length)throw Z.getTracks().forEach((Q)=>{Q.stop()}),new DOMException("","NotFoundError");return Z},(Z)=>Promise.reject(z(Z))))}}}function H5(f){f.MediaStream=f.MediaStream||f.webkitMediaStream}function J5(f){if(typeof f==="object"&&f.RTCPeerConnection&&!("ontrack"in f.RTCPeerConnection.prototype)){Object.defineProperty(f.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(K){if(this._ontrack)this.removeEventListener("track",this._ontrack);this.addEventListener("track",this._ontrack=K)},enumerable:!0,configurable:!0});let Y=f.RTCPeerConnection.prototype.setRemoteDescription;f.RTCPeerConnection.prototype.setRemoteDescription=function K(){if(!this._ontrackpoly)this._ontrackpoly=(A)=>{A.stream.addEventListener("addtrack",(L)=>{let z;if(f.RTCPeerConnection.prototype.getReceivers)z=this.getReceivers().find((I)=>I.track&&I.track.id===L.track.id);else z={track:L.track};let X=new Event("track");X.track=L.track,X.receiver=z,X.transceiver={receiver:z},X.streams=[A.stream],this.dispatchEvent(X)}),A.stream.getTracks().forEach((L)=>{let z;if(f.RTCPeerConnection.prototype.getReceivers)z=this.getReceivers().find((I)=>I.track&&I.track.id===L.id);else z={track:L};let X=new Event("track");X.track=L,X.receiver=z,X.transceiver={receiver:z},X.streams=[A.stream],this.dispatchEvent(X)})},this.addEventListener("addstream",this._ontrackpoly);return Y.apply(this,arguments)}}else nf(f,"track",(Y)=>{if(!Y.transceiver)Object.defineProperty(Y,"transceiver",{value:{receiver:Y.receiver}});return Y})}function I5(f){if(typeof f==="object"&&f.RTCPeerConnection&&!("getSenders"in f.RTCPeerConnection.prototype)&&"createDTMFSender"in f.RTCPeerConnection.prototype){let Y=function(L,z){return{track:z,get dtmf(){if(this._dtmf===void 0)if(z.kind==="audio")this._dtmf=L.createDTMFSender(z);else this._dtmf=null;return this._dtmf},_pc:L}};if(!f.RTCPeerConnection.prototype.getSenders){f.RTCPeerConnection.prototype.getSenders=function X(){return this._senders=this._senders||[],this._senders.slice()};let L=f.RTCPeerConnection.prototype.addTrack;f.RTCPeerConnection.prototype.addTrack=function X(I,J){let H=L.apply(this,arguments);if(!H)H=Y(this,I),this._senders.push(H);return H};let z=f.RTCPeerConnection.prototype.removeTrack;f.RTCPeerConnection.prototype.removeTrack=function X(I){z.apply(this,arguments);let J=this._senders.indexOf(I);if(J!==-1)this._senders.splice(J,1)}}let K=f.RTCPeerConnection.prototype.addStream;f.RTCPeerConnection.prototype.addStream=function L(z){this._senders=this._senders||[],K.apply(this,[z]),z.getTracks().forEach((X)=>{this._senders.push(Y(this,X))})};let A=f.RTCPeerConnection.prototype.removeStream;f.RTCPeerConnection.prototype.removeStream=function L(z){this._senders=this._senders||[],A.apply(this,[z]),z.getTracks().forEach((X)=>{let I=this._senders.find((J)=>J.track===X);if(I)this._senders.splice(this._senders.indexOf(I),1)})}}else if(typeof f==="object"&&f.RTCPeerConnection&&"getSenders"in f.RTCPeerConnection.prototype&&"createDTMFSender"in f.RTCPeerConnection.prototype&&f.RTCRtpSender&&!("dtmf"in f.RTCRtpSender.prototype)){let Y=f.RTCPeerConnection.prototype.getSenders;f.RTCPeerConnection.prototype.getSenders=function K(){let A=Y.apply(this,[]);return A.forEach((L)=>L._pc=this),A},Object.defineProperty(f.RTCRtpSender.prototype,"dtmf",{get(){if(this._dtmf===void 0)if(this.track.kind==="audio")this._dtmf=this._pc.createDTMFSender(this.track);else this._dtmf=null;return this._dtmf}})}}function Z5(f){if(!(typeof f==="object"&&f.RTCPeerConnection&&f.RTCRtpSender&&f.RTCRtpReceiver))return;if(!("getStats"in f.RTCRtpSender.prototype)){let K=f.RTCPeerConnection.prototype.getSenders;if(K)f.RTCPeerConnection.prototype.getSenders=function L(){let z=K.apply(this,[]);return z.forEach((X)=>X._pc=this),z};let A=f.RTCPeerConnection.prototype.addTrack;if(A)f.RTCPeerConnection.prototype.addTrack=function L(){let z=A.apply(this,arguments);return z._pc=this,z};f.RTCRtpSender.prototype.getStats=function L(){let z=this;return this._pc.getStats().then((X)=>X5(X,z.track,!0))}}if(!("getStats"in f.RTCRtpReceiver.prototype)){let K=f.RTCPeerConnection.prototype.getReceivers;if(K)f.RTCPeerConnection.prototype.getReceivers=function A(){let L=K.apply(this,[]);return L.forEach((z)=>z._pc=this),L};nf(f,"track",(A)=>{return A.receiver._pc=A.srcElement,A}),f.RTCRtpReceiver.prototype.getStats=function A(){let L=this;return this._pc.getStats().then((z)=>X5(z,L.track,!1))}}if(!(("getStats"in f.RTCRtpSender.prototype)&&("getStats"in f.RTCRtpReceiver.prototype)))return;let Y=f.RTCPeerConnection.prototype.getStats;f.RTCPeerConnection.prototype.getStats=function K(){if(arguments.length>0&&arguments[0]instanceof f.MediaStreamTrack){let A=arguments[0],L,z,X;if(this.getSenders().forEach((I)=>{if(I.track===A)if(L)X=!0;else L=I}),this.getReceivers().forEach((I)=>{if(I.track===A)if(z)X=!0;else z=I;return I.track===A}),X||L&&z)return Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError"));else if(L)return L.getStats();else if(z)return z.getStats();return Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return Y.apply(this,arguments)}}function v6(f){f.RTCPeerConnection.prototype.getLocalStreams=function z(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((X)=>this._shimmedLocalStreams[X][0])};let Y=f.RTCPeerConnection.prototype.addTrack;f.RTCPeerConnection.prototype.addTrack=function z(X,I){if(!I)return Y.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let J=Y.apply(this,arguments);if(!this._shimmedLocalStreams[I.id])this._shimmedLocalStreams[I.id]=[I,J];else if(this._shimmedLocalStreams[I.id].indexOf(J)===-1)this._shimmedLocalStreams[I.id].push(J);return J};let K=f.RTCPeerConnection.prototype.addStream;f.RTCPeerConnection.prototype.addStream=function z(X){this._shimmedLocalStreams=this._shimmedLocalStreams||{},X.getTracks().forEach((H)=>{if(this.getSenders().find((Q)=>Q.track===H))throw new DOMException("Track already exists.","InvalidAccessError")});let I=this.getSenders();K.apply(this,arguments);let J=this.getSenders().filter((H)=>I.indexOf(H)===-1);this._shimmedLocalStreams[X.id]=[X].concat(J)};let A=f.RTCPeerConnection.prototype.removeStream;f.RTCPeerConnection.prototype.removeStream=function z(X){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[X.id],A.apply(this,arguments)};let L=f.RTCPeerConnection.prototype.removeTrack;f.RTCPeerConnection.prototype.removeTrack=function z(X){if(this._shimmedLocalStreams=this._shimmedLocalStreams||{},X)Object.keys(this._shimmedLocalStreams).forEach((I)=>{let J=this._shimmedLocalStreams[I].indexOf(X);if(J!==-1)this._shimmedLocalStreams[I].splice(J,1);if(this._shimmedLocalStreams[I].length===1)delete this._shimmedLocalStreams[I]});return L.apply(this,arguments)}}function q5(f,Y){if(!f.RTCPeerConnection)return;if(f.RTCPeerConnection.prototype.addTrack&&Y.version>=65)return v6(f);let K=f.RTCPeerConnection.prototype.getLocalStreams;f.RTCPeerConnection.prototype.getLocalStreams=function H(){let Z=K.apply(this);return this._reverseStreams=this._reverseStreams||{},Z.map((Q)=>this._reverseStreams[Q.id])};let A=f.RTCPeerConnection.prototype.addStream;f.RTCPeerConnection.prototype.addStream=function H(Z){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},Z.getTracks().forEach((Q)=>{if(this.getSenders().find((V)=>V.track===Q))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[Z.id]){let Q=new f.MediaStream(Z.getTracks());this._streams[Z.id]=Q,this._reverseStreams[Q.id]=Z,Z=Q}A.apply(this,[Z])};let L=f.RTCPeerConnection.prototype.removeStream;f.RTCPeerConnection.prototype.removeStream=function H(Z){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},L.apply(this,[this._streams[Z.id]||Z]),delete this._reverseStreams[this._streams[Z.id]?this._streams[Z.id].id:Z.id],delete this._streams[Z.id]},f.RTCPeerConnection.prototype.addTrack=function H(Z,Q){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let q=[].slice.call(arguments,1);if(q.length!==1||!q[0].getTracks().find((N)=>N===Z))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((N)=>N.track===Z))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let W=this._streams[Q.id];if(W)W.addTrack(Z),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let N=new f.MediaStream([Z]);this._streams[Q.id]=N,this._reverseStreams[N.id]=Q,this.addStream(N)}return this.getSenders().find((N)=>N.track===Z)};function z(H,Z){let Q=Z.sdp;return Object.keys(H._reverseStreams||[]).forEach((q)=>{let V=H._reverseStreams[q],W=H._streams[V.id];Q=Q.replace(new RegExp(W.id,"g"),V.id)}),new RTCSessionDescription({type:Z.type,sdp:Q})}function X(H,Z){let Q=Z.sdp;return Object.keys(H._reverseStreams||[]).forEach((q)=>{let V=H._reverseStreams[q],W=H._streams[V.id];Q=Q.replace(new RegExp(V.id,"g"),W.id)}),new RTCSessionDescription({type:Z.type,sdp:Q})}["createOffer","createAnswer"].forEach(function(H){let Z=f.RTCPeerConnection.prototype[H],Q={[H](){let q=arguments;if(arguments.length&&typeof arguments[0]==="function")return Z.apply(this,[(W)=>{let N=z(this,W);q[0].apply(null,[N])},(W)=>{if(q[1])q[1].apply(null,W)},arguments[2]]);return Z.apply(this,arguments).then((W)=>z(this,W))}};f.RTCPeerConnection.prototype[H]=Q[H]});let I=f.RTCPeerConnection.prototype.setLocalDescription;f.RTCPeerConnection.prototype.setLocalDescription=function H(){if(!arguments.length||!arguments[0].type)return I.apply(this,arguments);return arguments[0]=X(this,arguments[0]),I.apply(this,arguments)};let J=Object.getOwnPropertyDescriptor(f.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(f.RTCPeerConnection.prototype,"localDescription",{get(){let H=J.get.apply(this);if(H.type==="")return H;return z(this,H)}}),f.RTCPeerConnection.prototype.removeTrack=function H(Z){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!Z._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(Z._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let q;if(Object.keys(this._streams).forEach((V)=>{if(this._streams[V].getTracks().find((N)=>Z.track===N))q=this._streams[V]}),q){if(q.getTracks().length===1)this.removeStream(this._reverseStreams[q.id]);else q.removeTrack(Z.track);this.dispatchEvent(new Event("negotiationneeded"))}}}function d0(f,Y){if(!f.RTCPeerConnection&&f.webkitRTCPeerConnection)f.RTCPeerConnection=f.webkitRTCPeerConnection;if(!f.RTCPeerConnection)return;if(Y.version<53)["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(K){let A=f.RTCPeerConnection.prototype[K],L={[K](){return arguments[0]=new(K==="addIceCandidate"?f.RTCIceCandidate:f.RTCSessionDescription)(arguments[0]),A.apply(this,arguments)}};f.RTCPeerConnection.prototype[K]=L[K]})}function $5(f,Y){nf(f,"negotiationneeded",(K)=>{let A=K.target;if(Y.version<72||A.getConfiguration&&A.getConfiguration().sdpSemantics==="plan-b"){if(A.signalingState!=="stable")return}return K})}var i0={};y0(i0,{shimSenderGetStats:()=>V5,shimRemoveStream:()=>B5,shimReceiverGetStats:()=>W5,shimRTCDataChannel:()=>_5,shimPeerConnection:()=>o0,shimOnTrack:()=>Q5,shimGetUserMedia:()=>w0,shimGetParameters:()=>R5,shimGetDisplayMedia:()=>S6,shimCreateOffer:()=>N5,shimCreateAnswer:()=>G5,shimAddTransceiver:()=>j5});function w0(f,Y){let K=f&&f.navigator,A=f&&f.MediaStreamTrack;if(K.getUserMedia=function(L,z,X){b2("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),K.mediaDevices.getUserMedia(L).then(z,X)},!(Y.version>55&&("autoGainControl"in K.mediaDevices.getSupportedConstraints()))){let L=function(X,I,J){if(I in X&&!(J in X))X[J]=X[I],delete X[I]},z=K.mediaDevices.getUserMedia.bind(K.mediaDevices);if(K.mediaDevices.getUserMedia=function(X){if(typeof X==="object"&&typeof X.audio==="object")X=JSON.parse(JSON.stringify(X)),L(X.audio,"autoGainControl","mozAutoGainControl"),L(X.audio,"noiseSuppression","mozNoiseSuppression");return z(X)},A&&A.prototype.getSettings){let X=A.prototype.getSettings;A.prototype.getSettings=function(){let I=X.apply(this,arguments);return L(I,"mozAutoGainControl","autoGainControl"),L(I,"mozNoiseSuppression","noiseSuppression"),I}}if(A&&A.prototype.applyConstraints){let X=A.prototype.applyConstraints;A.prototype.applyConstraints=function(I){if(this.kind==="audio"&&typeof I==="object")I=JSON.parse(JSON.stringify(I)),L(I,"autoGainControl","mozAutoGainControl"),L(I,"noiseSuppression","mozNoiseSuppression");return X.apply(this,[I])}}}}function S6(f,Y){if(f.navigator.mediaDevices&&"getDisplayMedia"in f.navigator.mediaDevices)return;if(!f.navigator.mediaDevices)return;f.navigator.mediaDevices.getDisplayMedia=function K(A){if(!(A&&A.video)){let L=new DOMException("getDisplayMedia without video constraints is undefined");return L.name="NotFoundError",L.code=8,Promise.reject(L)}if(A.video===!0)A.video={mediaSource:Y};else A.video.mediaSource=Y;return f.navigator.mediaDevices.getUserMedia(A)}}function Q5(f){if(typeof f==="object"&&f.RTCTrackEvent&&"receiver"in f.RTCTrackEvent.prototype&&!("transceiver"in f.RTCTrackEvent.prototype))Object.defineProperty(f.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function o0(f,Y){if(typeof f!=="object"||!(f.RTCPeerConnection||f.mozRTCPeerConnection))return;if(!f.RTCPeerConnection&&f.mozRTCPeerConnection)f.RTCPeerConnection=f.mozRTCPeerConnection;if(Y.version<53)["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(L){let z=f.RTCPeerConnection.prototype[L],X={[L](){return arguments[0]=new(L==="addIceCandidate"?f.RTCIceCandidate:f.RTCSessionDescription)(arguments[0]),z.apply(this,arguments)}};f.RTCPeerConnection.prototype[L]=X[L]});let K={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},A=f.RTCPeerConnection.prototype.getStats;f.RTCPeerConnection.prototype.getStats=function L(){let[z,X,I]=arguments;return A.apply(this,[z||null]).then((J)=>{if(Y.version<53&&!X)try{J.forEach((H)=>{H.type=K[H.type]||H.type})}catch(H){if(H.name!=="TypeError")throw H;J.forEach((Z,Q)=>{J.set(Q,Object.assign({},Z,{type:K[Z.type]||Z.type}))})}return J}).then(X,I)}}function V5(f){if(!(typeof f==="object"&&f.RTCPeerConnection&&f.RTCRtpSender))return;if(f.RTCRtpSender&&"getStats"in f.RTCRtpSender.prototype)return;let Y=f.RTCPeerConnection.prototype.getSenders;if(Y)f.RTCPeerConnection.prototype.getSenders=function A(){let L=Y.apply(this,[]);return L.forEach((z)=>z._pc=this),L};let K=f.RTCPeerConnection.prototype.addTrack;if(K)f.RTCPeerConnection.prototype.addTrack=function A(){let L=K.apply(this,arguments);return L._pc=this,L};f.RTCRtpSender.prototype.getStats=function A(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function W5(f){if(!(typeof f==="object"&&f.RTCPeerConnection&&f.RTCRtpSender))return;if(f.RTCRtpSender&&"getStats"in f.RTCRtpReceiver.prototype)return;let Y=f.RTCPeerConnection.prototype.getReceivers;if(Y)f.RTCPeerConnection.prototype.getReceivers=function K(){let A=Y.apply(this,[]);return A.forEach((L)=>L._pc=this),A};nf(f,"track",(K)=>{return K.receiver._pc=K.srcElement,K}),f.RTCRtpReceiver.prototype.getStats=function K(){return this._pc.getStats(this.track)}}function B5(f){if(!f.RTCPeerConnection||"removeStream"in f.RTCPeerConnection.prototype)return;f.RTCPeerConnection.prototype.removeStream=function Y(K){b2("removeStream","removeTrack"),this.getSenders().forEach((A)=>{if(A.track&&K.getTracks().includes(A.track))this.removeTrack(A)})}}function _5(f){if(f.DataChannel&&!f.RTCDataChannel)f.RTCDataChannel=f.DataChannel}function j5(f){if(!(typeof f==="object"&&f.RTCPeerConnection))return;let Y=f.RTCPeerConnection.prototype.addTransceiver;if(Y)f.RTCPeerConnection.prototype.addTransceiver=function K(){this.setParametersPromises=[];let A=arguments[1]&&arguments[1].sendEncodings;if(A===void 0)A=[];A=[...A];let L=A.length>0;if(L)A.forEach((X)=>{if("rid"in X){if(!/^[a-z0-9]{0,16}$/i.test(X.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in X){if(!(parseFloat(X.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0")}if("maxFramerate"in X){if(!(parseFloat(X.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}});let z=Y.apply(this,arguments);if(L){let{sender:X}=z,I=X.getParameters();if(!("encodings"in I)||I.encodings.length===1&&Object.keys(I.encodings[0]).length===0)I.encodings=A,X.sendEncodings=A,this.setParametersPromises.push(X.setParameters(I).then(()=>{delete X.sendEncodings}).catch(()=>{delete X.sendEncodings}))}return z}}function R5(f){if(!(typeof f==="object"&&f.RTCRtpSender))return;let Y=f.RTCRtpSender.prototype.getParameters;if(Y)f.RTCRtpSender.prototype.getParameters=function K(){let A=Y.apply(this,arguments);if(!("encodings"in A))A.encodings=[].concat(this.sendEncodings||[{}]);return A}}function N5(f){if(!(typeof f==="object"&&f.RTCPeerConnection))return;let Y=f.RTCPeerConnection.prototype.createOffer;f.RTCPeerConnection.prototype.createOffer=function K(){if(this.setParametersPromises&&this.setParametersPromises.length)return Promise.all(this.setParametersPromises).then(()=>{return Y.apply(this,arguments)}).finally(()=>{this.setParametersPromises=[]});return Y.apply(this,arguments)}}function G5(f){if(!(typeof f==="object"&&f.RTCPeerConnection))return;let Y=f.RTCPeerConnection.prototype.createAnswer;f.RTCPeerConnection.prototype.createAnswer=function K(){if(this.setParametersPromises&&this.setParametersPromises.length)return Promise.all(this.setParametersPromises).then(()=>{return Y.apply(this,arguments)}).finally(()=>{this.setParametersPromises=[]});return Y.apply(this,arguments)}}var n0={};y0(n0,{shimTrackEventTransceiver:()=>O5,shimRemoteStreamsAPI:()=>F5,shimRTCIceServerUrls:()=>M5,shimLocalStreamsAPI:()=>y5,shimGetUserMedia:()=>C5,shimCreateOfferLegacy:()=>x5,shimConstraints:()=>p6,shimCallbacksAPI:()=>E5,shimAudioContext:()=>U5});function y5(f){if(typeof f!=="object"||!f.RTCPeerConnection)return;if(!("getLocalStreams"in f.RTCPeerConnection.prototype))f.RTCPeerConnection.prototype.getLocalStreams=function Y(){if(!this._localStreams)this._localStreams=[];return this._localStreams};if(!("addStream"in f.RTCPeerConnection.prototype)){let Y=f.RTCPeerConnection.prototype.addTrack;f.RTCPeerConnection.prototype.addStream=function K(A){if(!this._localStreams)this._localStreams=[];if(!this._localStreams.includes(A))this._localStreams.push(A);A.getAudioTracks().forEach((L)=>Y.call(this,L,A)),A.getVideoTracks().forEach((L)=>Y.call(this,L,A))},f.RTCPeerConnection.prototype.addTrack=function K(A,...L){if(L)L.forEach((z)=>{if(!this._localStreams)this._localStreams=[z];else if(!this._localStreams.includes(z))this._localStreams.push(z)});return Y.apply(this,arguments)}}if(!("removeStream"in f.RTCPeerConnection.prototype))f.RTCPeerConnection.prototype.removeStream=function Y(K){if(!this._localStreams)this._localStreams=[];let A=this._localStreams.indexOf(K);if(A===-1)return;this._localStreams.splice(A,1);let L=K.getTracks();this.getSenders().forEach((z)=>{if(L.includes(z.track))this.removeTrack(z)})}}function F5(f){if(typeof f!=="object"||!f.RTCPeerConnection)return;if(!("getRemoteStreams"in f.RTCPeerConnection.prototype))f.RTCPeerConnection.prototype.getRemoteStreams=function Y(){return this._remoteStreams?this._remoteStreams:[]};if(!("onaddstream"in f.RTCPeerConnection.prototype)){Object.defineProperty(f.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(K){if(this._onaddstream)this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly);this.addEventListener("addstream",this._onaddstream=K),this.addEventListener("track",this._onaddstreampoly=(A)=>{A.streams.forEach((L)=>{if(!this._remoteStreams)this._remoteStreams=[];if(this._remoteStreams.includes(L))return;this._remoteStreams.push(L);let z=new Event("addstream");z.stream=L,this.dispatchEvent(z)})})}});let Y=f.RTCPeerConnection.prototype.setRemoteDescription;f.RTCPeerConnection.prototype.setRemoteDescription=function K(){let A=this;if(!this._onaddstreampoly)this.addEventListener("track",this._onaddstreampoly=function(L){L.streams.forEach((z)=>{if(!A._remoteStreams)A._remoteStreams=[];if(A._remoteStreams.indexOf(z)>=0)return;A._remoteStreams.push(z);let X=new Event("addstream");X.stream=z,A.dispatchEvent(X)})});return Y.apply(A,arguments)}}}function E5(f){if(typeof f!=="object"||!f.RTCPeerConnection)return;let Y=f.RTCPeerConnection.prototype,K=Y.createOffer,A=Y.createAnswer,L=Y.setLocalDescription,z=Y.setRemoteDescription,X=Y.addIceCandidate;Y.createOffer=function J(H,Z){let Q=arguments.length>=2?arguments[2]:arguments[0],q=K.apply(this,[Q]);if(!Z)return q;return q.then(H,Z),Promise.resolve()},Y.createAnswer=function J(H,Z){let Q=arguments.length>=2?arguments[2]:arguments[0],q=A.apply(this,[Q]);if(!Z)return q;return q.then(H,Z),Promise.resolve()};let I=function(J,H,Z){let Q=L.apply(this,[J]);if(!Z)return Q;return Q.then(H,Z),Promise.resolve()};Y.setLocalDescription=I,I=function(J,H,Z){let Q=z.apply(this,[J]);if(!Z)return Q;return Q.then(H,Z),Promise.resolve()},Y.setRemoteDescription=I,I=function(J,H,Z){let Q=X.apply(this,[J]);if(!Z)return Q;return Q.then(H,Z),Promise.resolve()},Y.addIceCandidate=I}function C5(f){let Y=f&&f.navigator;if(Y.mediaDevices&&Y.mediaDevices.getUserMedia){let K=Y.mediaDevices,A=K.getUserMedia.bind(K);Y.mediaDevices.getUserMedia=(L)=>{return A(p6(L))}}if(!Y.getUserMedia&&Y.mediaDevices&&Y.mediaDevices.getUserMedia)Y.getUserMedia=function K(A,L,z){Y.mediaDevices.getUserMedia(A).then(L,z)}.bind(Y)}function p6(f){if(f&&f.video!==void 0)return Object.assign({},f,{video:z5(f.video)});return f}function M5(f){if(!f.RTCPeerConnection)return;let Y=f.RTCPeerConnection;if(f.RTCPeerConnection=function K(A,L){if(A&&A.iceServers){let z=[];for(let X=0;X<A.iceServers.length;X++){let I=A.iceServers[X];if(I.urls===void 0&&I.url)b2("RTCIceServer.url","RTCIceServer.urls"),I=JSON.parse(JSON.stringify(I)),I.urls=I.url,delete I.url,z.push(I);else z.push(A.iceServers[X])}A.iceServers=z}return new Y(A,L)},f.RTCPeerConnection.prototype=Y.prototype,"generateCertificate"in Y)Object.defineProperty(f.RTCPeerConnection,"generateCertificate",{get(){return Y.generateCertificate}})}function O5(f){if(typeof f==="object"&&f.RTCTrackEvent&&"receiver"in f.RTCTrackEvent.prototype&&!("transceiver"in f.RTCTrackEvent.prototype))Object.defineProperty(f.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function x5(f){let Y=f.RTCPeerConnection.prototype.createOffer;f.RTCPeerConnection.prototype.createOffer=function K(A){if(A){if(typeof A.offerToReceiveAudio!=="undefined")A.offerToReceiveAudio=!!A.offerToReceiveAudio;let L=this.getTransceivers().find((X)=>X.receiver.track.kind==="audio");if(A.offerToReceiveAudio===!1&&L){if(L.direction==="sendrecv")if(L.setDirection)L.setDirection("sendonly");else L.direction="sendonly";else if(L.direction==="recvonly")if(L.setDirection)L.setDirection("inactive");else L.direction="inactive"}else if(A.offerToReceiveAudio===!0&&!L)this.addTransceiver("audio",{direction:"recvonly"});if(typeof A.offerToReceiveVideo!=="undefined")A.offerToReceiveVideo=!!A.offerToReceiveVideo;let z=this.getTransceivers().find((X)=>X.receiver.track.kind==="video");if(A.offerToReceiveVideo===!1&&z){if(z.direction==="sendrecv")if(z.setDirection)z.setDirection("sendonly");else z.direction="sendonly";else if(z.direction==="recvonly")if(z.setDirection)z.setDirection("inactive");else z.direction="inactive"}else if(A.offerToReceiveVideo===!0&&!z)this.addTransceiver("video",{direction:"recvonly"})}return Y.apply(this,arguments)}}function U5(f){if(typeof f!=="object"||f.AudioContext)return;f.AudioContext=f.webkitAudioContext}var T5={};y0(T5,{shimSendThrowTypeError:()=>q0,shimRTCIceCandidateRelayProtocol:()=>t0,shimRTCIceCandidate:()=>I0,shimParameterlessSetLocalDescription:()=>Q0,shimMaxMessageSize:()=>Z0,shimConnectionState:()=>e0,shimAddIceCandidateNullOrEmpty:()=>$0,removeExtmapAllowMixed:()=>f1});var m2=t5(P5(),1);function I0(f){if(!f.RTCIceCandidate||f.RTCIceCandidate&&"foundation"in f.RTCIceCandidate.prototype)return;let Y=f.RTCIceCandidate;f.RTCIceCandidate=function K(A){if(typeof A==="object"&&A.candidate&&A.candidate.indexOf("a=")===0)A=JSON.parse(JSON.stringify(A)),A.candidate=A.candidate.substring(2);if(A.candidate&&A.candidate.length){let L=new Y(A),z=m2.default.parseCandidate(A.candidate);for(let X in z)if(!(X in L))Object.defineProperty(L,X,{value:z[X]});return L.toJSON=function X(){return{candidate:L.candidate,sdpMid:L.sdpMid,sdpMLineIndex:L.sdpMLineIndex,usernameFragment:L.usernameFragment}},L}return new Y(A)},f.RTCIceCandidate.prototype=Y.prototype,nf(f,"icecandidate",(K)=>{if(K.candidate)Object.defineProperty(K,"candidate",{value:new f.RTCIceCandidate(K.candidate),writable:"false"});return K})}function t0(f){if(!f.RTCIceCandidate||f.RTCIceCandidate&&"relayProtocol"in f.RTCIceCandidate.prototype)return;nf(f,"icecandidate",(Y)=>{if(Y.candidate){let K=m2.default.parseCandidate(Y.candidate.candidate);if(K.type==="relay")Y.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[K.priority>>24]}return Y})}function Z0(f,Y){if(!f.RTCPeerConnection)return;if(!("sctp"in f.RTCPeerConnection.prototype))Object.defineProperty(f.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp}});let K=function(I){if(!I||!I.sdp)return!1;let J=m2.default.splitSections(I.sdp);return J.shift(),J.some((H)=>{let Z=m2.default.parseMLine(H);return Z&&Z.kind==="application"&&Z.protocol.indexOf("SCTP")!==-1})},A=function(I){let J=I.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(J===null||J.length<2)return-1;let H=parseInt(J[1],10);return H!==H?-1:H},L=function(I){let J=65536;if(Y.browser==="firefox")if(Y.version<57)if(I===-1)J=16384;else J=2147483637;else if(Y.version<60)J=Y.version===57?65535:65536;else J=2147483637;return J},z=function(I,J){let H=65536;if(Y.browser==="firefox"&&Y.version===57)H=65535;let Z=m2.default.matchPrefix(I.sdp,"a=max-message-size:");if(Z.length>0)H=parseInt(Z[0].substring(19),10);else if(Y.browser==="firefox"&&J!==-1)H=2147483637;return H},X=f.RTCPeerConnection.prototype.setRemoteDescription;f.RTCPeerConnection.prototype.setRemoteDescription=function I(){if(this._sctp=null,Y.browser==="chrome"&&Y.version>=76){let{sdpSemantics:J}=this.getConfiguration();if(J==="plan-b")Object.defineProperty(this,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:!0,configurable:!0})}if(K(arguments[0])){let J=A(arguments[0]),H=L(J),Z=z(arguments[0],J),Q;if(H===0&&Z===0)Q=Number.POSITIVE_INFINITY;else if(H===0||Z===0)Q=Math.max(H,Z);else Q=Math.min(H,Z);let q={};Object.defineProperty(q,"maxMessageSize",{get(){return Q}}),this._sctp=q}return X.apply(this,arguments)}}function q0(f){if(!(f.RTCPeerConnection&&("createDataChannel"in f.RTCPeerConnection.prototype)))return;function Y(A,L){let z=A.send;A.send=function X(){let I=arguments[0],J=I.length||I.size||I.byteLength;if(A.readyState==="open"&&L.sctp&&J>L.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+L.sctp.maxMessageSize+" bytes)");return z.apply(A,arguments)}}let K=f.RTCPeerConnection.prototype.createDataChannel;f.RTCPeerConnection.prototype.createDataChannel=function A(){let L=K.apply(this,arguments);return Y(L,this),L},nf(f,"datachannel",(A)=>{return Y(A.channel,A.target),A})}function e0(f){if(!f.RTCPeerConnection||"connectionState"in f.RTCPeerConnection.prototype)return;let Y=f.RTCPeerConnection.prototype;Object.defineProperty(Y,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(Y,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(K){if(this._onconnectionstatechange)this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange;if(K)this.addEventListener("connectionstatechange",this._onconnectionstatechange=K)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((K)=>{let A=Y[K];Y[K]=function(){if(!this._connectionstatechangepoly)this._connectionstatechangepoly=(L)=>{let z=L.target;if(z._lastConnectionState!==z.connectionState){z._lastConnectionState=z.connectionState;let X=new Event("connectionstatechange",L);z.dispatchEvent(X)}return L},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly);return A.apply(this,arguments)}})}function f1(f,Y){if(!f.RTCPeerConnection)return;if(Y.browser==="chrome"&&Y.version>=71)return;if(Y.browser==="safari"&&Y._safariVersion>=13.1)return;let K=f.RTCPeerConnection.prototype.setRemoteDescription;f.RTCPeerConnection.prototype.setRemoteDescription=function A(L){if(L&&L.sdp&&L.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let z=L.sdp.split(`
`).filter((X)=>{return X.trim()!=="a=extmap-allow-mixed"}).join(`
`);if(f.RTCSessionDescription&&L instanceof f.RTCSessionDescription)arguments[0]=new f.RTCSessionDescription({type:L.type,sdp:z});else L.sdp=z}return K.apply(this,arguments)}}function $0(f,Y){if(!(f.RTCPeerConnection&&f.RTCPeerConnection.prototype))return;let K=f.RTCPeerConnection.prototype.addIceCandidate;if(!K||K.length===0)return;f.RTCPeerConnection.prototype.addIceCandidate=function A(){if(!arguments[0]){if(arguments[1])arguments[1].apply(null);return Promise.resolve()}if((Y.browser==="chrome"&&Y.version<78||Y.browser==="firefox"&&Y.version<68||Y.browser==="safari")&&arguments[0]&&arguments[0].candidate==="")return Promise.resolve();return K.apply(this,arguments)}}function Q0(f,Y){if(!(f.RTCPeerConnection&&f.RTCPeerConnection.prototype))return;let K=f.RTCPeerConnection.prototype.setLocalDescription;if(!K||K.length===0)return;f.RTCPeerConnection.prototype.setLocalDescription=function A(){let L=arguments[0]||{};if(typeof L!=="object"||L.type&&L.sdp)return K.apply(this,arguments);if(L={type:L.type,sdp:L.sdp},!L.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":L.type="offer";break;default:L.type="answer";break}if(L.sdp||L.type!=="offer"&&L.type!=="answer")return K.apply(this,[L]);return(L.type==="offer"?this.createOffer:this.createAnswer).apply(this).then((X)=>K.apply(this,[X]))}}var pK=t5(P5(),1);function l6({window:f}={},Y={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let K=r0,A=g6(f),L={browserDetails:A,commonShim:T5,extractVersion:k2,disableLog:T6,disableWarnings:D6,sdp:pK};switch(A.browser){case"chrome":if(!a0||!d0||!Y.shimChrome)return K("Chrome shim is not included in this adapter release."),L;if(A.version===null)return K("Chrome shim can not determine version, not shimming."),L;K("adapter.js shimming chrome."),L.browserShim=a0,$0(f,A),Q0(f,A),s0(f,A),H5(f,A),d0(f,A),J5(f,A),q5(f,A),I5(f,A),Z5(f,A),$5(f,A),I0(f,A),t0(f,A),e0(f,A),Z0(f,A),q0(f,A),f1(f,A);break;case"firefox":if(!i0||!o0||!Y.shimFirefox)return K("Firefox shim is not included in this adapter release."),L;K("adapter.js shimming firefox."),L.browserShim=i0,$0(f,A),Q0(f,A),w0(f,A),o0(f,A),Q5(f,A),B5(f,A),V5(f,A),W5(f,A),_5(f,A),j5(f,A),R5(f,A),N5(f,A),G5(f,A),I0(f,A),e0(f,A),Z0(f,A),q0(f,A);break;case"safari":if(!n0||!Y.shimSafari)return K("Safari shim is not included in this adapter release."),L;K("adapter.js shimming safari."),L.browserShim=n0,$0(f,A),Q0(f,A),M5(f,A),x5(f,A),E5(f,A),y5(f,A),F5(f,A),O5(f,A),C5(f,A),U5(f,A),I0(f,A),t0(f,A),Z0(f,A),q0(f,A),f1(f,A);break;default:K("Unsupported browser!");break}return L}var lK=l6({window:typeof window==="undefined"?void 0:window}),D5=lK;function U2(f,Y,K,A){Object.defineProperty(f,Y,{get:K,set:A,enumerable:!0,configurable:!0})}class v5{constructor(){this.chunkedMTU=16300,this._dataCount=1,this.chunk=(f)=>{let Y=[],K=f.byteLength,A=Math.ceil(K/this.chunkedMTU),L=0,z=0;while(z<K){let X=Math.min(K,z+this.chunkedMTU),I=f.slice(z,X),J={__peerData:this._dataCount,n:L,data:I,total:A};Y.push(J),z=X,L++}return this._dataCount++,Y}}}function kK(f){let Y=0;for(let L of f)Y+=L.byteLength;let K=new Uint8Array(Y),A=0;for(let L of f)K.set(L,A),A+=L.byteLength;return K}var g5=D5.default||D5,V0=new class{isWebRTCSupported(){return typeof RTCPeerConnection!=="undefined"}isBrowserSupported(){let f=this.getBrowser(),Y=this.getVersion();if(!this.supportedBrowsers.includes(f))return!1;if(f==="chrome")return Y>=this.minChromeVersion;if(f==="firefox")return Y>=this.minFirefoxVersion;if(f==="safari")return!this.isIOS&&Y>=this.minSafariVersion;return!1}getBrowser(){return g5.browserDetails.browser}getVersion(){return g5.browserDetails.version||0}isUnifiedPlanSupported(){let f=this.getBrowser(),Y=g5.browserDetails.version||0;if(f==="chrome"&&Y<this.minChromeVersion)return!1;if(f==="firefox"&&Y>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let K,A=!1;try{K=new RTCPeerConnection,K.addTransceiver("audio"),A=!0}catch(L){}finally{if(K)K.close()}return A}toString(){return`Supports:
    browser:${this.getBrowser()}
    version:${this.getVersion()}
    isIOS:${this.isIOS}
    isWebRTCSupported:${this.isWebRTCSupported()}
    isBrowserSupported:${this.isBrowserSupported()}
    isUnifiedPlanSupported:${this.isUnifiedPlanSupported()}`}constructor(){this.isIOS=typeof navigator!=="undefined"?["iPad","iPhone","iPod"].includes(navigator.platform):!1,this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}},bK=(f)=>{return!f||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(f)},b6=()=>Math.random().toString(36).slice(2),k6={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"};class m6 extends v5{noop(){}blobToArrayBuffer(f,Y){let K=new FileReader;return K.onload=function(A){if(A.target)Y(A.target.result)},K.readAsArrayBuffer(f),K}binaryStringToArrayBuffer(f){let Y=new Uint8Array(f.length);for(let K=0;K<f.length;K++)Y[K]=f.charCodeAt(K)&255;return Y.buffer}isSecure(){return location.protocol==="https:"}constructor(...f){super(...f),this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.defaultConfig=k6,this.browser=V0.getBrowser(),this.browserVersion=V0.getVersion(),this.pack=A5,this.unpack=K5,this.supports=function(){let Y={browser:V0.isBrowserSupported(),webRTC:V0.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!Y.webRTC)return Y;let K;try{K=new RTCPeerConnection(k6),Y.audioVideo=!0;let A;try{A=K.createDataChannel("_PEERJSTEST",{ordered:!0}),Y.data=!0,Y.reliable=!!A.ordered;try{A.binaryType="blob",Y.binaryBlob=!V0.isIOS}catch(L){}}catch(L){}finally{if(A)A.close()}}catch(A){}finally{if(K)K.close()}return Y}(),this.validateId=bK,this.randomToken=b6}}var Mf=new m6,mK="PeerJS: ";class c6{get logLevel(){return this._logLevel}set logLevel(f){this._logLevel=f}log(...f){if(this._logLevel>=3)this._print(3,...f)}warn(...f){if(this._logLevel>=2)this._print(2,...f)}error(...f){if(this._logLevel>=1)this._print(1,...f)}setLogFunction(f){this._print=f}_print(f,...Y){let K=[mK,...Y];for(let A in K)if(K[A]instanceof Error)K[A]="("+K[A].name+") "+K[A].message;if(f>=3)console.log(...K);else if(f>=2)console.warn("WARNING",...K);else if(f>=1)console.error("ERROR",...K)}constructor(){this._logLevel=0}}var v=new c6,S5={},cK=Object.prototype.hasOwnProperty,yf="~";function W0(){}if(Object.create){if(W0.prototype=Object.create(null),!new W0().__proto__)yf=!1}function rK(f,Y,K){this.fn=f,this.context=Y,this.once=K||!1}function r6(f,Y,K,A,L){if(typeof K!=="function")throw new TypeError("The listener must be a function");var z=new rK(K,A||f,L),X=yf?yf+Y:Y;if(!f._events[X])f._events[X]=z,f._eventsCount++;else if(!f._events[X].fn)f._events[X].push(z);else f._events[X]=[f._events[X],z];return f}function Y1(f,Y){if(--f._eventsCount===0)f._events=new W0;else delete f._events[Y]}function Nf(){this._events=new W0,this._eventsCount=0}Nf.prototype.eventNames=function f(){var Y=[],K,A;if(this._eventsCount===0)return Y;for(A in K=this._events)if(cK.call(K,A))Y.push(yf?A.slice(1):A);if(Object.getOwnPropertySymbols)return Y.concat(Object.getOwnPropertySymbols(K));return Y};Nf.prototype.listeners=function f(Y){var K=yf?yf+Y:Y,A=this._events[K];if(!A)return[];if(A.fn)return[A.fn];for(var L=0,z=A.length,X=new Array(z);L<z;L++)X[L]=A[L].fn;return X};Nf.prototype.listenerCount=function f(Y){var K=yf?yf+Y:Y,A=this._events[K];if(!A)return 0;if(A.fn)return 1;return A.length};Nf.prototype.emit=function f(Y,K,A,L,z,X){var I=yf?yf+Y:Y;if(!this._events[I])return!1;var J=this._events[I],H=arguments.length,Z,Q;if(J.fn){if(J.once)this.removeListener(Y,J.fn,void 0,!0);switch(H){case 1:return J.fn.call(J.context),!0;case 2:return J.fn.call(J.context,K),!0;case 3:return J.fn.call(J.context,K,A),!0;case 4:return J.fn.call(J.context,K,A,L),!0;case 5:return J.fn.call(J.context,K,A,L,z),!0;case 6:return J.fn.call(J.context,K,A,L,z,X),!0}for(Q=1,Z=new Array(H-1);Q<H;Q++)Z[Q-1]=arguments[Q];J.fn.apply(J.context,Z)}else{var q=J.length,V;for(Q=0;Q<q;Q++){if(J[Q].once)this.removeListener(Y,J[Q].fn,void 0,!0);switch(H){case 1:J[Q].fn.call(J[Q].context);break;case 2:J[Q].fn.call(J[Q].context,K);break;case 3:J[Q].fn.call(J[Q].context,K,A);break;case 4:J[Q].fn.call(J[Q].context,K,A,L);break;default:if(!Z)for(V=1,Z=new Array(H-1);V<H;V++)Z[V-1]=arguments[V];J[Q].fn.apply(J[Q].context,Z)}}}return!0};Nf.prototype.on=function f(Y,K,A){return r6(this,Y,K,A,!1)};Nf.prototype.once=function f(Y,K,A){return r6(this,Y,K,A,!0)};Nf.prototype.removeListener=function f(Y,K,A,L){var z=yf?yf+Y:Y;if(!this._events[z])return this;if(!K)return Y1(this,z),this;var X=this._events[z];if(X.fn){if(X.fn===K&&(!L||X.once)&&(!A||X.context===A))Y1(this,z)}else{for(var I=0,J=[],H=X.length;I<H;I++)if(X[I].fn!==K||L&&!X[I].once||A&&X[I].context!==A)J.push(X[I]);if(J.length)this._events[z]=J.length===1?J[0]:J;else Y1(this,z)}return this};Nf.prototype.removeAllListeners=function f(Y){var K;if(Y){if(K=yf?yf+Y:Y,this._events[K])Y1(this,K)}else this._events=new W0,this._eventsCount=0;return this};Nf.prototype.off=Nf.prototype.removeListener;Nf.prototype.addListener=Nf.prototype.on;Nf.prefixed=yf;Nf.EventEmitter=Nf;S5=Nf;var h2={};U2(h2,"ConnectionType",()=>W2);U2(h2,"PeerErrorType",()=>If);U2(h2,"BaseConnectionErrorType",()=>u5);U2(h2,"DataConnectionErrorType",()=>p5);U2(h2,"SerializationType",()=>z1);U2(h2,"SocketEventType",()=>V2);U2(h2,"ServerMessageType",()=>Rf);var W2=function(f){return f.Data="data",f.Media="media",f}({}),If=function(f){return f.BrowserIncompatible="browser-incompatible",f.Disconnected="disconnected",f.InvalidID="invalid-id",f.InvalidKey="invalid-key",f.Network="network",f.PeerUnavailable="peer-unavailable",f.SslUnavailable="ssl-unavailable",f.ServerError="server-error",f.SocketError="socket-error",f.SocketClosed="socket-closed",f.UnavailableID="unavailable-id",f.WebRTC="webrtc",f}({}),u5=function(f){return f.NegotiationFailed="negotiation-failed",f.ConnectionClosed="connection-closed",f}({}),p5=function(f){return f.NotOpenYet="not-open-yet",f.MessageToBig="message-too-big",f}({}),z1=function(f){return f.Binary="binary",f.BinaryUTF8="binary-utf8",f.JSON="json",f.None="raw",f}({}),V2=function(f){return f.Message="message",f.Disconnected="disconnected",f.Error="error",f.Close="close",f}({}),Rf=function(f){return f.Heartbeat="HEARTBEAT",f.Candidate="CANDIDATE",f.Offer="OFFER",f.Answer="ANSWER",f.Open="OPEN",f.Error="ERROR",f.IdTaken="ID-TAKEN",f.InvalidKey="INVALID-KEY",f.Leave="LEAVE",f.Expire="EXPIRE",f}({}),s6="1.5.5";class d6 extends S5.EventEmitter{constructor(f,Y,K,A,L,z=5000){super(),this.pingInterval=z,this._disconnected=!0,this._messagesQueue=[];let X=f?"wss://":"ws://";this._baseUrl=X+Y+":"+K+A+"peerjs?key="+L}start(f,Y){this._id=f;let K=`${this._baseUrl}&id=${f}&token=${Y}`;if(!!this._socket||!this._disconnected)return;this._socket=new WebSocket(K+"&version="+s6),this._disconnected=!1,this._socket.onmessage=(A)=>{let L;try{L=JSON.parse(A.data),v.log("Server message received:",L)}catch(z){v.log("Invalid server message",A.data);return}this.emit(V2.Message,L)},this._socket.onclose=(A)=>{if(this._disconnected)return;v.log("Socket closed.",A),this._cleanup(),this._disconnected=!0,this.emit(V2.Disconnected)},this._socket.onopen=()=>{if(this._disconnected)return;this._sendQueuedMessages(),v.log("Socket open"),this._scheduleHeartbeat()}}_scheduleHeartbeat(){this._wsPingTimer=setTimeout(()=>{this._sendHeartbeat()},this.pingInterval)}_sendHeartbeat(){if(!this._wsOpen()){v.log("Cannot send heartbeat, because socket closed");return}let f=JSON.stringify({type:Rf.Heartbeat});this._socket.send(f),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&this._socket.readyState===1}_sendQueuedMessages(){let f=[...this._messagesQueue];this._messagesQueue=[];for(let Y of f)this.send(Y)}send(f){if(this._disconnected)return;if(!this._id){this._messagesQueue.push(f);return}if(!f.type){this.emit(V2.Error,"Invalid message");return}if(!this._wsOpen())return;let Y=JSON.stringify(f);this._socket.send(Y)}close(){if(this._disconnected)return;this._cleanup(),this._disconnected=!0}_cleanup(){if(this._socket)this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0;clearTimeout(this._wsPingTimer)}}class l5{constructor(f){this.connection=f}startConnection(f){let Y=this._startPeerConnection();if(this.connection.peerConnection=Y,this.connection.type===W2.Media&&f._stream)this._addTracksToConnection(f._stream,Y);if(f.originator){let K=this.connection,A={ordered:!!f.reliable},L=Y.createDataChannel(K.label,A);K._initializeDataChannel(L),this._makeOffer()}else this.handleSDP("OFFER",f.sdp)}_startPeerConnection(){v.log("Creating RTCPeerConnection.");let f=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(f),f}_setupListeners(f){let Y=this.connection.peer,K=this.connection.connectionId,A=this.connection.type,L=this.connection.provider;v.log("Listening for ICE candidates."),f.onicecandidate=(z)=>{if(!z.candidate||!z.candidate.candidate)return;v.log(`Received ICE candidates for ${Y}:`,z.candidate),L.socket.send({type:Rf.Candidate,payload:{candidate:z.candidate,type:A,connectionId:K},dst:Y})},f.oniceconnectionstatechange=()=>{switch(f.iceConnectionState){case"failed":v.log("iceConnectionState is failed, closing connections to "+Y),this.connection.emitError(u5.NegotiationFailed,"Negotiation of connection to "+Y+" failed."),this.connection.close();break;case"closed":v.log("iceConnectionState is closed, closing connections to "+Y),this.connection.emitError(u5.ConnectionClosed,"Connection to "+Y+" closed."),this.connection.close();break;case"disconnected":v.log("iceConnectionState changed to disconnected on the connection with "+Y);break;case"completed":f.onicecandidate=()=>{};break}this.connection.emit("iceStateChanged",f.iceConnectionState)},v.log("Listening for data channel"),f.ondatachannel=(z)=>{v.log("Received data channel");let X=z.channel;L.getConnection(Y,K)._initializeDataChannel(X)},v.log("Listening for remote stream"),f.ontrack=(z)=>{v.log("Received remote stream");let X=z.streams[0],I=L.getConnection(Y,K);if(I.type===W2.Media){let J=I;this._addStreamToMediaConnection(X,J)}}}cleanup(){v.log("Cleaning up PeerConnection to "+this.connection.peer);let f=this.connection.peerConnection;if(!f)return;this.connection.peerConnection=null,f.onicecandidate=f.oniceconnectionstatechange=f.ondatachannel=f.ontrack=()=>{};let Y=f.signalingState!=="closed",K=!1,A=this.connection.dataChannel;if(A)K=!!A.readyState&&A.readyState!=="closed";if(Y||K)f.close()}async _makeOffer(){let f=this.connection.peerConnection,Y=this.connection.provider;try{let K=await f.createOffer(this.connection.options.constraints);if(v.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform==="function")K.sdp=this.connection.options.sdpTransform(K.sdp)||K.sdp;try{await f.setLocalDescription(K),v.log("Set localDescription:",K,`for:${this.connection.peer}`);let A={sdp:K,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type===W2.Data){let L=this.connection;A={...A,label:L.label,reliable:L.reliable,serialization:L.serialization}}Y.socket.send({type:Rf.Offer,payload:A,dst:this.connection.peer})}catch(A){if(A!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer")Y.emitError(If.WebRTC,A),v.log("Failed to setLocalDescription, ",A)}}catch(K){Y.emitError(If.WebRTC,K),v.log("Failed to createOffer, ",K)}}async _makeAnswer(){let f=this.connection.peerConnection,Y=this.connection.provider;try{let K=await f.createAnswer();if(v.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform==="function")K.sdp=this.connection.options.sdpTransform(K.sdp)||K.sdp;try{await f.setLocalDescription(K),v.log("Set localDescription:",K,`for:${this.connection.peer}`),Y.socket.send({type:Rf.Answer,payload:{sdp:K,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(A){Y.emitError(If.WebRTC,A),v.log("Failed to setLocalDescription, ",A)}}catch(K){Y.emitError(If.WebRTC,K),v.log("Failed to create answer, ",K)}}async handleSDP(f,Y){Y=new RTCSessionDescription(Y);let K=this.connection.peerConnection,A=this.connection.provider;v.log("Setting remote description",Y);let L=this;try{if(await K.setRemoteDescription(Y),v.log(`Set remoteDescription:${f} for:${this.connection.peer}`),f==="OFFER")await L._makeAnswer()}catch(z){A.emitError(If.WebRTC,z),v.log("Failed to setRemoteDescription, ",z)}}async handleCandidate(f){v.log("handleCandidate:",f);try{await this.connection.peerConnection.addIceCandidate(f),v.log(`Added ICE candidate for:${this.connection.peer}`)}catch(Y){this.connection.provider.emitError(If.WebRTC,Y),v.log("Failed to handleCandidate, ",Y)}}_addTracksToConnection(f,Y){if(v.log(`add tracks from stream ${f.id} to peer connection`),!Y.addTrack)return v.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");f.getTracks().forEach((K)=>{Y.addTrack(K,f)})}_addStreamToMediaConnection(f,Y){v.log(`add stream ${f.id} to media connection ${Y.connectionId}`),Y.addStream(f)}}class k5 extends S5.EventEmitter{emitError(f,Y){v.error("Error:",Y),this.emit("error",new a6(`${f}`,Y))}}class a6 extends Error{constructor(f,Y){if(typeof Y==="string")super(Y);else{super();Object.assign(this,Y)}this.type=f}}class b5 extends k5{get open(){return this._open}constructor(f,Y,K){super(),this.peer=f,this.provider=Y,this.options=K,this._open=!1,this.metadata=K.metadata}}class A1 extends b5{static#f=this.ID_PREFIX="mc_";get type(){return W2.Media}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}constructor(f,Y,K){super(f,Y,K);if(this._localStream=this.options._stream,this.connectionId=this.options.connectionId||A1.ID_PREFIX+Mf.randomToken(),this._negotiator=new l5(this),this._localStream)this._negotiator.startConnection({_stream:this._localStream,originator:!0})}_initializeDataChannel(f){this.dataChannel=f,this.dataChannel.onopen=()=>{v.log(`DC#${this.connectionId} dc connection success`),this.emit("willCloseOnRemote")},this.dataChannel.onclose=()=>{v.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}addStream(f){v.log("Receiving stream",f),this._remoteStream=f,super.emit("stream",f)}handleMessage(f){let{type:Y,payload:K}=f;switch(f.type){case Rf.Answer:this._negotiator.handleSDP(Y,K.sdp),this._open=!0;break;case Rf.Candidate:this._negotiator.handleCandidate(K.candidate);break;default:v.warn(`Unrecognized message type:${Y} from peer:${this.peer}`);break}}answer(f,Y={}){if(this._localStream){v.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}if(this._localStream=f,Y&&Y.sdpTransform)this.options.sdpTransform=Y.sdpTransform;this._negotiator.startConnection({...this.options._payload,_stream:f});let K=this.provider._getMessages(this.connectionId);for(let A of K)this.handleMessage(A);this._open=!0}close(){if(this._negotiator)this._negotiator.cleanup(),this._negotiator=null;if(this._localStream=null,this._remoteStream=null,this.provider)this.provider._removeConnection(this),this.provider=null;if(this.options&&this.options._stream)this.options._stream=null;if(!this.open)return;this._open=!1,super.emit("close")}}class w6{constructor(f){this._options=f}_buildRequest(f){let Y=this._options.secure?"https":"http",{host:K,port:A,path:L,key:z}=this._options,X=new URL(`${Y}://${K}:${A}${L}${z}/${f}`);return X.searchParams.set("ts",`${Date.now()}${Math.random()}`),X.searchParams.set("version",s6),fetch(X.href,{referrerPolicy:this._options.referrerPolicy})}async retrieveId(){try{let f=await this._buildRequest("id");if(f.status!==200)throw new Error(`Error. Status:${f.status}`);return f.text()}catch(f){v.error("Error retrieving ID",f);let Y="";if(this._options.path==="/"&&this._options.host!==Mf.CLOUD_HOST)Y=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer.";throw new Error("Could not get an ID from the server."+Y)}}async listAllPeers(){try{let f=await this._buildRequest("peers");if(f.status!==200){if(f.status===401){let Y="";if(this._options.host===Mf.CLOUD_HOST)Y="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.";else Y="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.";throw new Error("It doesn't look like you have permission to list peers IDs. "+Y)}throw new Error(`Error. Status:${f.status}`)}return f.json()}catch(f){throw v.error("Error retrieving list peers",f),new Error("Could not get list peers from the server."+f)}}}class L1 extends b5{static#f=this.ID_PREFIX="dc_";static#Y=this.MAX_BUFFERED_AMOUNT=8388608;get type(){return W2.Data}constructor(f,Y,K){super(f,Y,K);this.connectionId=this.options.connectionId||L1.ID_PREFIX+b6(),this.label=this.options.label||this.connectionId,this.reliable=!!this.options.reliable,this._negotiator=new l5(this),this._negotiator.startConnection(this.options._payload||{originator:!0,reliable:this.reliable})}_initializeDataChannel(f){this.dataChannel=f,this.dataChannel.onopen=()=>{v.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=(Y)=>{v.log(`DC#${this.connectionId} dc onmessage:`,Y.data)},this.dataChannel.onclose=()=>{v.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}close(f){if(f?.flush){this.send({__peerData:{type:"close"}});return}if(this._negotiator)this._negotiator.cleanup(),this._negotiator=null;if(this.provider)this.provider._removeConnection(this),this.provider=null;if(this.dataChannel)this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this.dataChannel=null;if(!this.open)return;this._open=!1,super.emit("close")}send(f,Y=!1){if(!this.open){this.emitError(p5.NotOpenYet,"Connection is not open. You should listen for the `open` event before sending messages.");return}return this._send(f,Y)}async handleMessage(f){let Y=f.payload;switch(f.type){case Rf.Answer:await this._negotiator.handleSDP(f.type,Y.sdp);break;case Rf.Candidate:await this._negotiator.handleCandidate(Y.candidate);break;default:v.warn("Unrecognized message type:",f.type,"from peer:",this.peer);break}}}class X1 extends L1{get bufferSize(){return this._bufferSize}_initializeDataChannel(f){super._initializeDataChannel(f),this.dataChannel.binaryType="arraybuffer",this.dataChannel.addEventListener("message",(Y)=>this._handleDataMessage(Y))}_bufferedSend(f){if(this._buffering||!this._trySend(f))this._buffer.push(f),this._bufferSize=this._buffer.length}_trySend(f){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>L1.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(()=>{this._buffering=!1,this._tryBuffer()},50),!1;try{this.dataChannel.send(f)}catch(Y){return v.error(`DC#:${this.connectionId} Error when sending:`,Y),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open)return;if(this._buffer.length===0)return;let f=this._buffer[0];if(this._trySend(f))this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer()}close(f){if(f?.flush){this.send({__peerData:{type:"close"}});return}this._buffer=[],this._bufferSize=0,super.close()}constructor(...f){super(...f),this._buffer=[],this._bufferSize=0,this._buffering=!1}}class K1 extends X1{close(f){super.close(f),this._chunkedData={}}constructor(f,Y,K){super(f,Y,K),this.chunker=new v5,this.serialization=z1.Binary,this._chunkedData={}}_handleDataMessage({data:f}){let Y=K5(f),K=Y.__peerData;if(K){if(K.type==="close"){this.close();return}this._handleChunk(Y);return}this.emit("data",Y)}_handleChunk(f){let Y=f.__peerData,K=this._chunkedData[Y]||{data:[],count:0,total:f.total};if(K.data[f.n]=new Uint8Array(f.data),K.count++,this._chunkedData[Y]=K,K.total===K.count){delete this._chunkedData[Y];let A=kK(K.data);this._handleDataMessage({data:A})}}_send(f,Y){let K=A5(f);if(K instanceof Promise)return this._send_blob(K);if(!Y&&K.byteLength>this.chunker.chunkedMTU){this._sendChunks(K);return}this._bufferedSend(K)}async _send_blob(f){let Y=await f;if(Y.byteLength>this.chunker.chunkedMTU){this._sendChunks(Y);return}this._bufferedSend(Y)}_sendChunks(f){let Y=this.chunker.chunk(f);v.log(`DC#${this.connectionId} Try to send ${Y.length} chunks...`);for(let K of Y)this.send(K,!0)}}class o6 extends X1{_handleDataMessage({data:f}){super.emit("data",f)}_send(f,Y){this._bufferedSend(f)}constructor(...f){super(...f),this.serialization=z1.None}}class i6 extends X1{_handleDataMessage({data:f}){let Y=this.parse(this.decoder.decode(f)),K=Y.__peerData;if(K&&K.type==="close"){this.close();return}this.emit("data",Y)}_send(f,Y){let K=this.encoder.encode(this.stringify(f));if(K.byteLength>=Mf.chunkedMTU){this.emitError(p5.MessageToBig,"Message too big for JSON channel");return}this._bufferedSend(K)}constructor(...f){super(...f),this.serialization=z1.JSON,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.stringify=JSON.stringify,this.parse=JSON.parse}}class m5 extends k5{static#f=this.DEFAULT_KEY="peerjs";get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){let f=Object.create(null);for(let[Y,K]of this._connections)f[Y]=K;return f}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}constructor(f,Y){super(),this._serializers={raw:o6,json:i6,binary:K1,"binary-utf8":K1,default:K1},this._id=null,this._lastServerId=null,this._destroyed=!1,this._disconnected=!1,this._open=!1,this._connections=new Map,this._lostMessages=new Map;let K;if(f&&f.constructor==Object)Y=f;else if(f)K=f.toString();if(Y={debug:0,host:Mf.CLOUD_HOST,port:Mf.CLOUD_PORT,path:"/",key:m5.DEFAULT_KEY,token:Mf.randomToken(),config:Mf.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin",serializers:{},...Y},this._options=Y,this._serializers={...this._serializers,...this.options.serializers},this._options.host==="/")this._options.host=window.location.hostname;if(this._options.path){if(this._options.path[0]!=="/")this._options.path="/"+this._options.path;if(this._options.path[this._options.path.length-1]!=="/")this._options.path+="/"}if(this._options.secure===void 0&&this._options.host!==Mf.CLOUD_HOST)this._options.secure=Mf.isSecure();else if(this._options.host==Mf.CLOUD_HOST)this._options.secure=!0;if(this._options.logFunction)v.setLogFunction(this._options.logFunction);if(v.logLevel=this._options.debug||0,this._api=new w6(Y),this._socket=this._createServerConnection(),!Mf.supports.audioVideo&&!Mf.supports.data){this._delayedAbort(If.BrowserIncompatible,"The current browser does not support WebRTC");return}if(!!K&&!Mf.validateId(K)){this._delayedAbort(If.InvalidID,`ID "${K}" is invalid`);return}if(K)this._initialize(K);else this._api.retrieveId().then((A)=>this._initialize(A)).catch((A)=>this._abort(If.ServerError,A))}_createServerConnection(){let f=new d6(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return f.on(V2.Message,(Y)=>{this._handleMessage(Y)}),f.on(V2.Error,(Y)=>{this._abort(If.SocketError,Y)}),f.on(V2.Disconnected,()=>{if(this.disconnected)return;this.emitError(If.Network,"Lost connection to server."),this.disconnect()}),f.on(V2.Close,()=>{if(this.disconnected)return;this._abort(If.SocketClosed,"Underlying socket is already closed.")}),f}_initialize(f){this._id=f,this.socket.start(f,this._options.token)}_handleMessage(f){let{type:Y,payload:K,src:A}=f;switch(Y){case Rf.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case Rf.Error:this._abort(If.ServerError,K.msg);break;case Rf.IdTaken:this._abort(If.UnavailableID,`ID "${this.id}" is taken`);break;case Rf.InvalidKey:this._abort(If.InvalidKey,`API KEY "${this._options.key}" is invalid`);break;case Rf.Leave:v.log(`Received leave message from ${A}`),this._cleanupPeer(A),this._connections.delete(A);break;case Rf.Expire:this.emitError(If.PeerUnavailable,`Could not connect to peer ${A}`);break;case Rf.Offer:{let L=K.connectionId,z=this.getConnection(A,L);if(z)z.close(),v.warn(`Offer received for existing Connection ID:${L}`);if(K.type===W2.Media){let I=new A1(A,this,{connectionId:L,_payload:K,metadata:K.metadata});z=I,this._addConnection(A,z),this.emit("call",I)}else if(K.type===W2.Data){let I=new this._serializers[K.serialization](A,this,{connectionId:L,_payload:K,metadata:K.metadata,label:K.label,serialization:K.serialization,reliable:K.reliable});z=I,this._addConnection(A,z),this.emit("connection",I)}else{v.warn(`Received malformed connection type:${K.type}`);return}let X=this._getMessages(L);for(let I of X)z.handleMessage(I);break}default:{if(!K){v.warn(`You received a malformed message from ${A} of type ${Y}`);return}let L=K.connectionId,z=this.getConnection(A,L);if(z&&z.peerConnection)z.handleMessage(f);else if(L)this._storeMessage(L,f);else v.warn("You received an unrecognized message:",f);break}}}_storeMessage(f,Y){if(!this._lostMessages.has(f))this._lostMessages.set(f,[]);this._lostMessages.get(f).push(Y)}_getMessages(f){let Y=this._lostMessages.get(f);if(Y)return this._lostMessages.delete(f),Y;return[]}connect(f,Y={}){if(Y={serialization:"default",...Y},this.disconnected){v.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(If.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}let K=new this._serializers[Y.serialization](f,this,Y);return this._addConnection(f,K),K}call(f,Y,K={}){if(this.disconnected){v.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(If.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!Y){v.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}let A=new A1(f,this,{...K,_stream:Y});return this._addConnection(f,A),A}_addConnection(f,Y){if(v.log(`add connection ${Y.type}:${Y.connectionId} to peerId:${f}`),!this._connections.has(f))this._connections.set(f,[]);this._connections.get(f).push(Y)}_removeConnection(f){let Y=this._connections.get(f.peer);if(Y){let K=Y.indexOf(f);if(K!==-1)Y.splice(K,1)}this._lostMessages.delete(f.connectionId)}getConnection(f,Y){let K=this._connections.get(f);if(!K)return null;for(let A of K)if(A.connectionId===Y)return A;return null}_delayedAbort(f,Y){setTimeout(()=>{this._abort(f,Y)},0)}_abort(f,Y){if(v.error("Aborting!"),this.emitError(f,Y),!this._lastServerId)this.destroy();else this.disconnect()}destroy(){if(this.destroyed)return;v.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close")}_cleanup(){for(let f of this._connections.keys())this._cleanupPeer(f),this._connections.delete(f);this.socket.removeAllListeners()}_cleanupPeer(f){let Y=this._connections.get(f);if(!Y)return;for(let K of Y)K.close()}disconnect(){if(this.disconnected)return;let f=this.id;v.log(`Disconnect peer with ID:${f}`),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=f,this._id=null,this.emit("disconnected",f)}reconnect(){if(this.disconnected&&!this.destroyed)v.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this._initialize(this._lastServerId);else if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");else if(!this.disconnected&&!this.open)v.error("In a hurry? We're still trying to make the initial connection!");else throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`)}listAllPeers(f=(Y)=>{}){this._api.listAllPeers().then((Y)=>f(Y)).catch((Y)=>this._abort(If.ServerError,Y))}}var c5=m5;class B0{k;username;pos;life;peer;getUsername(){return this.username}getPos(){return this.pos}getLife(){return this.life}getPeer(){return this.peer}constructor(f,Y,K){if(this.k=f,this.peer=Y,this.username="",this.pos=f.vec2(),this.life=0,K)this.setData(K)}setData(f){if(f.username)this.username=f.username;if(f.pos)this.k.vec2(f.pos.x,f.pos.y),this.pos=f.pos,console.log(this.pos.isZero()),console.log(f.pos.isZero());if(f.life)this.life=f.life}}class r5{k;peer;isHost;error;hostId;connections;players;reject;getHostId(){return this.hostId}getIsHost(){return this.isHost}getPlayerData(f){return this.players[f]}getPlayers(){return this.players}constructor(f,Y){this.k=f,this.connections={},this.players={},this.isHost=!1,this.error=!1,this.reject=Y}async joinRoom(f,Y,K){this.hostId=Y,this.peer=new c5(this.hostId),this.peer.on("open",(A)=>{if(this.isHost=A==this.hostId,this.hostId==null){this.reject("Host ID is undefined");return}this.players[this.hostId]=new B0(this.k,this.hostId,{username:f,peer:this.hostId}),K()}),this.peer.on("connection",(A)=>{this.hostNewClientConnection(A,K)}),this.peer.on("error",()=>{if(this.error==!0){this.reject("Error connecting to the network");return}this.error=!0,this.isHost=!1,this.peer=new c5,this.peer.on("open",()=>{this.clientOpen(f,K)}),this.peer.on("error",()=>this.reject("Error connecting to the network"))})}connectionPlayerData(f){f.forEach((Y)=>{let K=Y.peer;if(this.players[K])this.players[K].setData(Y);else this.players[K]=new B0(this.k,K,Y)})}async hostNewClientConnection(f,Y){if(!this.isHost){this.reject("You are not the host");return}this.connections[f.peer]=f,f.on("open",()=>{if(this.hostId==null){this.reject("Host ID is undefined");return}let K=Object.keys(this.players).map((A)=>{return{username:this.players[A].getUsername(),peer:this.players[A].getPeer()}});this.sendPlayerData(f,K)}),f.on("data",(K)=>{let A=K,L=JSON.parse(A);this.connectionPlayerData(L),this.hostDistributePlayerData(L),Y()}),f.on("close",()=>{delete this.players[f.peer],console.log("player delete",this.players[f.peer]),console.log("Cliente desconectado: "+f.peer)}),f.on("error",()=>this.reject("Error connecting to the network"))}hostDistributePlayerData(f){if(!this.isHost)return;for(let Y in this.connections){let K=this.connections[Y];if(K&&K.open)this.sendPlayerData(K,f);else delete this.connections[Y]}}clientOpen(f,Y){if(this.hostId==null){this.reject("Host ID is undefined");return}let K=this.peer?.connect(this.hostId);if(K==null){this.reject("Error connecting to the network");return}if(this.peer==null){this.reject("Error connecting to the network");return}this.connections[this.hostId]=K,this.players[this.peer.id]=new B0(this.k,this.peer.id,{username:f,peer:this.peer.id}),K.on("open",()=>{if(this.peer==null){this.reject("Error connecting to the network");return}this.clientSend({username:f,peer:this.peer.id})}),K.on("data",(A)=>{let L=A,z=JSON.parse(L);this.connectionPlayerData(z),Y()}),K.on("close",()=>{this.k.go("closedRoom")}),K.on("error",()=>this.reject("Error connecting to the network"))}clientSend(f){if(this.hostId==null){this.reject("Host ID is undefined");return}let Y=this.connections[this.hostId];if(Y&&Y.open)this.sendPlayerData(Y,[f]);else delete this.connections[this.hostId],this.reject("Host connection closed")}sendPlayerData(f,Y){f.send(JSON.stringify(Y))}}function n6({k:f,src:Y,pos:K,z:A,scale:L=1}){let z=f.add([f.pos(K.x,K.y),f.scale(L),f.sprite(Y),f.z(A),f.offscreen()]);return z.onExitScreen(()=>{z.hidden=!0}),z.onEnterScreen(()=>{z.hidden=!1}),z}var H1=100;function sK({k:f,src:Y,widthSprite:K,boxPos:A,z:L}){let z=H1/K,X=f.vec2(A.x*H1,A.y*H1);return n6({k:f,src:Y,pos:X,scale:z,z:L})}var n={Add:sK,size:H1};function J1({k:f,boxPos:Y}){Y.x-=1,Y.y-=1;let K=64,A="terrain/water/foam.png",L=n.Add({k:f,src:A,widthSprite:K,boxPos:Y,z:3});return L.play("loop"),L}function s5({k:f,boxPos:Y}){Y.x-=1,Y.y-=1;let K=64,A="terrain/ground/shadows.png";return n.Add({k:f,src:A,widthSprite:K,boxPos:Y,z:5})}function t6({k:f,boxPos:Y,matrix:K}){if(K[Y.y][Y.x]==null)return!1;let X=n.Add({k:f,src:"terrain/ground/tilemap_elevation.png",widthSprite:64,boxPos:Y,z:6}),I=!1,J=!1,H=!1,Z=!1,Q=!1;if(Y.y>0)I=K[Y.y-1][Y.x]==6;if(Y.y<K.length-1){let V=K[Y.y+1][Y.x];J=V==6,Q=V==7||V==9||V==8||V==10}if(Y.x>0)H=K[Y.y][Y.x-1]==6;if(Y.x<K[0].length-1)Z=K[Y.y][Y.x+1]==6;function q(V,W,N,_){f.add([f.pos(X.pos.x+(V?n.size:0),X.pos.y+(W?n.size:0)),f.rect(N?n.size:1,_?n.size:1),f.area(),f.body({isStatic:!0})])}if(!I&&!H&&J&&Z)X.frame=0,q(!1,!1,!0,!1),q(!1,!1,!1,!0);else if(!I&&H&&J&&Z)X.frame=1,q(!1,!1,!0,!1);else if(!I&&H&&J&&!Z)X.frame=2,q(!0,!1,!1,!0),q(!1,!1,!0,!1);else if(!I&&!H&&!Z&&J)X.frame=3,q(!1,!1,!0,!1),q(!1,!1,!1,!0),q(!0,!1,!1,!0);else if(I&&J&&!H&&Z)X.frame=4,q(!1,!1,!1,!0);else if(I&&J&&H&&Z)X.frame=5;else if(I&&J&&H&&!Z)X.frame=6,q(!0,!1,!1,!0);else if(I&&J&&!H&&!Z)X.frame=7,q(!1,!1,!1,!0),q(!0,!1,!1,!0);else if(I&&Q&&!H&&Z)X.frame=8,q(!1,!1,!1,!0);else if(I&&Q&&H&&Z)X.frame=9;else if(I&&Q&&H&&!Z)X.frame=10,q(!0,!1,!1,!0);else if(I&&Q&&!H&&!Z)X.frame=11,q(!1,!1,!1,!0),q(!0,!1,!1,!0);else if(!I&&Q&&!H&&Z)X.frame=16,q(!1,!1,!1,!0),q(!1,!1,!0,!1);else if(!I&&Q&&H&&Z)X.frame=17,q(!1,!1,!0,!1);else if(!I&&Q&&H&&!Z)X.frame=18,q(!0,!1,!1,!0),q(!1,!1,!0,!1);else if(!I&&Q&&!H&&!Z)X.frame=19,q(!1,!1,!1,!0),q(!0,!1,!1,!0),q(!1,!1,!0,!1);return{soul:X}}function I1({k:f,boxPos:Y,type:K}){let z=n.Add({k:f,src:"terrain/ground/tilemap_flat.png",widthSprite:64,boxPos:Y,z:11});if(K==11)z.frame=4;else if(K==12)z.frame=9;return console.log(z.frame),z}function e6(f,Y,K,A){if(Y[K.y][K.x]==null)return!1;let I=n.Add({k:f,src:"terrain/ground/tilemap_elevation.png",widthSprite:64,boxPos:K,z:7}),J=!1,H=!1,Z=!1,Q=!1;if(K.y>0)J=Y[K.y-1][K.x]==6;if(K.y<Y.length-1)H=Y[K.y+1][K.x]==6;if(K.x>0)Z=Y[K.y][K.x-1]==A;if(K.x<Y[0].length-1)Q=Y[K.y][K.x+1]==A;if(I.use(f.body({isStatic:!0})),I.use(f.area({scale:1,offset:f.vec2(0,0)})),J&&!H&&!Z&&Q)I.frame=12;else if(J&&!H&&Z&&Q)I.frame=13;else if(J&&!H&&Z&&!Q)I.frame=14;else if(J&&!H&&!Z&&!Q)I.frame=15;function q(){if(A==7)return;if(Math.round(Math.random()*100)>20)return;let W=11;if(A==8)W=12;I1({k:f,boxPos:K,type:W})}return q(),{soul:I}}function f3({k:f,boxPos:Y,matrix:K}){if(K[Y.y][Y.x]==null)return!1;let L="terrain/ground/tilemap_flat.png",z=n.Add({k:f,src:L,widthSprite:64,boxPos:Y,z:4}),X=!1,I=!1,J=!1,H=!1;if(Y.y>0)X=K[Y.y-1][Y.x]==4;if(Y.y<K.length-1)I=K[Y.y+1][Y.x]==4;if(Y.x>0)J=K[Y.y][Y.x-1]==4;if(Y.x<K[0].length-1)H=K[Y.y][Y.x+1]==4;function Z(Q,q,V,W){f.add([f.pos(z.pos.x+(Q?n.size:0),z.pos.y+(q?n.size:0)),f.rect(V?n.size:1,W?n.size:1),f.area(),f.body({isStatic:!0})])}if(!X&&!J&&I&&H)z.frame=5,Z(!1,!1,!0,!1),Z(!1,!1,!1,!0);else if(!X&&J&&I&&H)z.frame=6,Z(!1,!1,!0,!1);else if(!X&&J&&I&&!H)z.frame=7,Z(!0,!1,!1,!0),Z(!1,!1,!0,!1);else if(!X&&!J&&!H&&I)z.frame=8,Z(!1,!1,!0,!1),Z(!1,!1,!1,!0),Z(!0,!1,!1,!0);else if(X&&I&&!J&&H)z.frame=15,Z(!1,!1,!1,!0);else if(X&&I&&J&&H)z.frame=16;else if(X&&I&&J&&!H)z.frame=17,Z(!0,!1,!1,!0);else if(X&&I&&!J&&!H)z.frame=18,Z(!1,!1,!1,!0),Z(!0,!1,!1,!0);else if(X&&!I&&!J&&H)z.frame=25,Z(!1,!1,!1,!0),Z(!1,!0,!0,!1);else if(X&&!I&&J&&H)z.frame=26,Z(!1,!0,!0,!1);else if(X&&!I&&J&&!H)z.frame=27,Z(!0,!1,!1,!0),Z(!1,!0,!0,!1);else if(X&&!I&&!J&&!H)z.frame=28,Z(!1,!1,!1,!0),Z(!0,!1,!1,!0);else if(!X&&!I&&!J&&H)z.frame=35,Z(!1,!1,!1,!0),Z(!1,!1,!0,!1);else if(!X&&!I&&J&&H)z.frame=36,Z(!1,!1,!0,!1);else if(!X&&!I&&J&&!H)z.frame=37,Z(!0,!1,!1,!0),Z(!1,!1,!0,!1);else if(!X&&!I&&!J&&!H)z.frame=38,Z(!1,!1,!1,!0),Z(!0,!1,!1,!0),Z(!1,!1,!0,!1);return z}function Y3({k:f,boxPos:Y,matrix:K}){if(K[Y.y][Y.x]==null)return!1;let L="terrain/ground/tilemap_flat.png",z=n.Add({k:f,src:L,widthSprite:64,boxPos:Y,z:13}),X=!1,I=!1,J=!1,H=!1;if(Y.y>0)X=K[Y.y-1][Y.x]==13;if(Y.y<K.length-1)I=K[Y.y+1][Y.x]==13;if(Y.x>0)J=K[Y.y][Y.x-1]==13;if(Y.x<K[0].length-1)H=K[Y.y][Y.x+1]==13;function Z({plusX:Q=!1,plusY:q=!1,sizeX:V=!1,sizeY:W=!1}){f.add([f.pos(z.pos.x+(Q?n.size:0),z.pos.y+(q?n.size:0)),f.rect(V?n.size:1,W?n.size:1),f.area(),f.body({isStatic:!0})])}if(!X&&!J&&I&&H)z.frame=0,Z({sizeX:!0}),Z({sizeY:!0});else if(!X&&J&&I&&H)z.frame=1,Z({sizeX:!0});else if(!X&&J&&I&&!H)z.frame=2,Z({plusX:!0,sizeY:!0}),Z({sizeX:!0});else if(!X&&!J&&!H&&I)z.frame=3,Z({sizeX:!0}),Z({sizeY:!0}),Z({plusX:!0,sizeY:!0});else if(X&&I&&!J&&H)z.frame=10,Z({sizeY:!0});else if(X&&I&&J&&H)z.frame=11;else if(X&&I&&J&&!H)z.frame=12,Z({plusX:!0,sizeY:!0});else if(X&&I&&!J&&!H)z.frame=13,Z({sizeY:!0}),Z({plusX:!0,sizeY:!0});else if(X&&!I&&!J&&H)z.frame=20,Z({sizeY:!0});else if(X&&!I&&J&&H)z.frame=21;else if(X&&!I&&J&&!H)z.frame=22,Z({plusX:!0,sizeY:!0});else if(X&&!I&&!J&&!H)z.frame=23,Z({sizeY:!0}),Z({plusX:!0,sizeY:!0});else if(!X&&!I&&!J&&H)z.frame=30,Z({sizeY:!0}),Z({sizeX:!0});else if(!X&&!I&&J&&H)z.frame=31,Z({sizeX:!0});else if(!X&&!I&&J&&!H)z.frame=32,Z({plusX:!0,sizeY:!0}),Z({sizeX:!0});else if(!X&&!I&&!J&&!H)z.frame=33,Z({sizeY:!0}),Z({plusX:!0,sizeY:!0}),Z({sizeX:!0});return z}function K3(f,Y,K){if(!K[Y.y][Y.x])return!1;let X=n.Add({k:f,src:"terrain/ground/tilemap_elevation.png",widthSprite:64,boxPos:Y,z:10}),I=!1,J=!1;if(Y.x>0)I=K[Y.y][Y.x-1]==10;if(Y.x<K.length-1)J=K[Y.y][Y.x+1]==10;if(!I&&J)X.frame=28;else if(I&&J)X.frame=29;else if(I&&!J)X.frame=30;else if(!I&&!J)X.frame=31;return{soul:X}}function A3({k:f,length:Y}){let K=[];for(let X=0;X<Y;X++){K[X]=[];for(let I=0;I<Y;I++)K[X][I]=0}function A(){for(let X=0;X<Y;X++)for(let I=0;I<Y;I++){if(K[X][I]==0)continue;K[X][I]=0}}function L({init:X=f.vec2(),end:I=f.vec2(),type:J}){for(let H=X.y;H<=I.y;H++)for(let Z=X.x;Z<=I.x;Z++)K[H][Z]=J}function z(){K.forEach((X,I)=>{X.forEach((J,H)=>{if(J==0)return;if(J==1)Z1({k:f,boxPos:f.vec2(H,I)});else if(J==3)J1({k:f,boxPos:f.vec2(H,I)});else if(J==4)f3({k:f,boxPos:f.vec2(H,I),matrix:K});else if(J==6)s5({k:f,boxPos:f.vec2(H,I)}),t6({k:f,boxPos:f.vec2(H,I),matrix:K});else if(J==7||J==9||J==8)s5({k:f,boxPos:f.vec2(H,I)}),e6(f,K,f.vec2(H,I),J);else if(J==11||J==12)I1({k:f,boxPos:f.vec2(H,I),type:J});else if(J==10)K3(f,f.vec2(H,I),K);else if(J==13)Y3({k:f,boxPos:f.vec2(H,I),matrix:K})})}),A()}return{setRect:L,draw:z}}function Z1({k:f,boxPos:Y}){return n.Add({k:f,src:"terrain/water/water.png",widthSprite:64,boxPos:Y,z:1})}function q1({k:f,src:Y,widthSprite:K,boxPos:A,area:L}){A.x-=1,A.y-=1;let z=n.Add({k:f,src:Y,widthSprite:K,boxPos:A,z:2}),X=z.scale,I=f.area({scale:X.x/L.scale,offset:f.vec2(n.size/L.offset.x,n.size/L.offset.y)});return z.use(I),z.use(f.body({isStatic:!0})),z.play("loop"),z}function L3({k:f,boxPos:Y}){let K={scale:6,offset:{x:1.2,y:1.2}},A=64,L="terrain/water/rocks/rocks_01.png";return q1({k:f,src:"terrain/water/rocks/rocks_01.png",widthSprite:64,boxPos:Y,area:K})}function z3({k:f,boxPos:Y}){let K={scale:5,offset:{x:1.3,y:1.2}},A=64,L="terrain/water/rocks/rocks_02.png";return q1({k:f,src:"terrain/water/rocks/rocks_02.png",widthSprite:64,boxPos:Y,area:K})}function _0({k:f,components:Y=f.vec2()}){function K(){if(Y.x<0)return"left";if(Y.x>0)return"right";if(Y.y<0)return"up";return"down"}function A({direction:L}){Y.x=L.components.x,Y.y=L.components.y}return{components:Y,getTextDirection:K,setOtherDirection:A}}function X3({k:f}){let Y=f.add([]),K=f.vec2(0,0),A=2;Y.onMouseDown(()=>L());function L(){let H=f.mousePos(),Z=f.getCamPos(),Q=f.getCamScale();H.x=H.x-f.width()/2,H.y=H.y-f.height()/2,H.x=H.x/Q.x,H.y=H.y/Q.y,H.x=H.x+Z.x,H.y=H.y+Z.y,K=H}function z({position:H}){let Z=K.x-H.x,Q=K.y-H.y;return f.vec2(Z,Q)}function X({distance:H}){if(H.x>A)return 1;if(H.x<-A)return-1;return 0}function I({distance:H}){if(H.y>A)return 1;if(H.y<-A)return-1;return 0}function J({position:H}){if(K.isZero())return!1;let Z=z({position:H}),Q=X({distance:Z}),q=I({distance:Z});if(Q==0&&q==0)return K=f.vec2(),!1;return _0({k:f,components:f.vec2(Q,q)})}return{getDirection:J,moveClick:Y}}function H3({k:f,src:Y,pos:K}){let L=f.add([f.pos(K.x,K.y),f.scale(1.5),f.sprite(Y),f.area({scale:0.3,offset:f.vec2(0,20)}),f.body(),f.z(100)]),z="idle",X={q:"thrust",space:"jump",e:"emote",r:"sit",b:"climb",shift:"run",h:"spellcast",j:"slash",k:"shoot",y:"combatIdle",u:"handedSlash",i:"handedBackSlash"},I={idle:()=>P(),walk:()=>u(),spellcast:()=>s(),thrust:()=>w(),slash:()=>l(),shoot:()=>o(),hurt:()=>t(),climb:()=>k(),jump:()=>B2(),sit:()=>P2(),emote:()=>c2(),run:()=>z2(),combatIdle:()=>D2(),handedSlash:()=>m(),handedBackSlash:()=>Yf()},J={idle:()=>O(),walk:()=>T(),spellcast:()=>p(),thrust:()=>d(),slash:()=>b(),shoot:()=>Kf(),hurt:()=>Vf(),climb:()=>ef(),jump:()=>L2(),sit:()=>T2(),emote:()=>r2(),run:()=>gf(),combatIdle:()=>S(),handedSlash:()=>r(),handedBackSlash:()=>Zf()},H={idle:!1,walk:!1,spellcast:!1,slash:!1,thrust:!1,shoot:!1,hurt:!1,climb:!1,jump:!1,sit:!1,emote:!1,run:!1,combatIdle:!1,handedSlash:!1,handedBackSlash:!1},Z=1,Q=_0({k:f}),q=_0({k:f}),V=4,W=7,N=V,_=X3({k:f});L.use(f.anchor("center")),G();function j({anim:c,animation:qf}){if(!c.includes(qf))return!1;return H[qf]=!0,i({newState:"idle"}),!0}function M({anim:c}){let qf=["jump","thrust","emote","sit","climb","spellcast","slash","shoot","combatIdle","handedSlash","handedBackSlash"];for(let s2 of qf)if(j({anim:c,animation:s2}))break;Wf()}function U({key:c}){let qf=X[c];if(qf!=null)i({newState:qf})}function D({key:c}){if(c=="w"||c=="s"){let qf=0;if(c=="w")qf=-1;else if(c=="s")qf=1;q.components.y=qf}else if(c=="a"||c=="d"){let qf=0;if(c=="a")qf=-1;else if(c=="d")qf=1;q.components.x=qf}}function C(){let c=_.getDirection({position:L.pos});if(c===!1){if(q.components.isZero())i({newState:"idle"});else if(Q.setOtherDirection({direction:q}),z=="idle")i({newState:"walk"})}else Q.setOtherDirection({direction:c}),i({newState:"walk"});if(z=="walk"||z=="run")cf()}function R({key:c}){if(c=="w"||c=="s")q.components.y=0;else if(c=="a"||c=="d")q.components.x=0;else if(c=="shift")i({newState:"idle"})}function G(){L.onAnimEnd((c)=>M({anim:c})),L.onKeyDown(Object.keys(X),(c)=>U({key:c})),L.onKeyDown(["w","s","a","d"],(c)=>D({key:c})),L.onKeyRelease(["w","s","a","d","shift"],(c)=>R({key:c})),L.onUpdate(()=>C())}function O(){Z=0.2}function P(){switch(z){case"thrust":return H.thrust;case"spellcast":return H.spellcast;case"slash":return H.slash;case"shoot":return H.shoot;case"jump":return H.jump;case"thrust":return H.thrust;case"emote":return H.emote;case"sit":return H.sit;case"climb":return H.climb;case"run":return!0;case"spellcast":return H.spellcast;case"slash":return H.slash;case"shoot":return H.shoot;case"combatIdle":return H.combatIdle;case"handedSlash":return H.handedSlash;case"handedBackSlash":return H.handedBackSlash;case"walk":return!0}return!1}function T(){Z=1,N=V}function u(){switch(z){case"run":case"idle":return!0}return!1}function p(){H.spellcast=!1,Z=1}function s(){switch(z){case"walk":case"run":case"idle":case"combatIdle":case"sit":case"emote":return!0}return!1}function d(){Z=1,H.thrust=!1}function w(){switch(z){case"walk":case"run":case"idle":case"combatIdle":case"sit":case"emote":case"climb":return!0}return!1}function b(){Z=1,H.slash=!1}function l(){switch(z){case"walk":case"run":case"idle":case"combatIdle":case"sit":case"emote":return!0}return!1}function Kf(){Z=1,H.shoot=!1}function o(){switch(z){case"walk":case"run":case"idle":return!0}return!1}function t(){switch(z){case"handedBackSlash":return!1}return!0}function Vf(){Z=1,H.hurt=!1}function k(){switch(z){case"walk":case"run":case"idle":case"combatIdle":case"jump":return!0}return!1}function ef(){Z=1,H.climb=!1}function L2(){Z=1,H.jump=!1}function B2(){switch(z){case"walk":case"run":case"idle":case"combatIdle":return!0}return!1}function P2(){switch(z){case"walk":case"run":case"idle":case"combatIdle":return!0}return!1}function T2(){Z=1,H.sit=!1}function c2(){switch(z){case"walk":case"run":case"idle":case"combatIdle":return!0}return!1}function r2(){Z=1,H.emote=!1}function z2(){switch(z){case"walk":case"idle":case"combatIdle":return!0}return!1}function gf(){Z=1,N=W,H.run=!1}function D2(){switch(z){case"walk":case"idle":return!0}return!1}function S(){Z=1,H.combatIdle=!1}function m(){switch(z){case"walk":case"idle":case"combatIdle":return!0}return!1}function r(){Z=1,H.handedSlash=!1}function Yf(){switch(z){case"walk":case"idle":case"combatIdle":return!0}return!1}function Zf(){Z=1,H.handedBackSlash=!1}function i({newState:c}){if(c==z)return;if(!I[c]())return;J[c](),z=c,Wf()}function Wf(){L.animSpeed=Z;let c=`${z}${Q.getTextDirection()}`;L.play(c)}function cf(){f.setCamPos(L.pos.x,L.pos.y),L.pos.x+=Q.components.x*N,L.pos.y+=Q.components.y*N}return{soul:L}}function $1({k:f}){return H3({k:f,src:"characters/warwick.png",pos:f.vec2(500,500)})}function J3({k:f,server:Y}){f.scene("world",()=>{mf({k:f,sizePercentage:f.vec2(1,1),color:"#1F1F1F"});for(let K=0;K<10;K++)for(let A=0;A<10;A++)Z1({k:f,boxPos:f.vec2(A,K)});J1({k:f,boxPos:f.vec2(2,2)}),$1({k:f}),L3({k:f,boxPos:f.vec2(4,4)}),z3({k:f,boxPos:f.vec2(5,5)})})}function I3({k:f}){f.scene("offline",()=>{mf({k:f,color:"#1F1F1F",sizePercentage:f.vec2(1,1),fixed:!0});let Y=A3({k:f,length:41});Y.setRect({end:f.vec2(40,40),type:1}),Y.setRect({init:f.vec2(1,1),end:f.vec2(15,15),type:3}),Y.setRect({init:f.vec2(1,20),end:f.vec2(15,35),type:4}),Y.draw(),Y.setRect({init:f.vec2(1,1),end:f.vec2(15,15),type:4}),Y.setRect({init:f.vec2(1,20),end:f.vec2(15,30),type:4}),Y.draw(),Y.setRect({init:f.vec2(2,2),end:f.vec2(7,6),type:6}),Y.setRect({init:f.vec2(2,7),end:f.vec2(7,7),type:8}),Y.setRect({init:f.vec2(4,7),end:f.vec2(5,7),type:10}),Y.draw(),Y.setRect({init:f.vec2(2,2),end:f.vec2(7,6),type:13}),Y.draw(),$1({k:f}),Jf({k:f,text:"You are offline",scale:0.5,posPercentage:f.vec2(0.9,0.05),fixed:!0,inactive:!0}),Cf({k:f,posPercentage:f.vec2(0.08,0.08),sizePercentage:f.vec2(0.12,0.09),text:"Retry",onClick:()=>{if(navigator.onLine)f.go("join")},fixed:!0})})}function Z3(){let f={animations:[{name:"spellcast",frames:7,directions:["up","left","down","right"]},{name:"thrust",frames:8,directions:["up","left","down","right"]},{name:"walk",frames:9,directions:["up","left","down","right"]},{name:"slash",frames:6,directions:["up","left","down","right"]},{name:"shoot",frames:13,directions:["up","left","down","right"]},{name:"hurt",frames:6,directions:["down"]},{name:"climb",frames:6,directions:["up"]},{name:"idle",frames:2,directions:["up","left","down","right"]},{name:"jump",frames:5,directions:["up","left","down","right"]},{name:"sit",frames:3,directions:["up","left","down","right"]},{name:"emote",frames:3,directions:["up","left","down","right"]},{name:"run",frames:8,directions:["up","left","down","right"]},{name:"combatIdle",frames:2,directions:["up","left","down","right"]},{name:"handedSlash",frames:13,directions:["up","left","down","right"]},{name:"handedBackSlash",frames:6,directions:["up","left","down","right"]}],options:{sliceX:13,sliceY:54}},Y=0,K=f.options.sliceX;if(K==null)throw new Error("characterJSON.ts sliceX = undefined");f.options.anims={};for(let A of f.animations)for(let L of A.directions)f.options.anims[A.name+L]={from:Y,to:Y+(A.frames-1)},Y+=K;return f.options}var q3={sliceX:8,sliceY:1,anims:{loop:{from:0,to:7,loop:!0}}},dK=Z3(),aK={sliceX:4,sliceY:8},wK={sliceX:10,sliceY:4};function $3({k:f}){function Y({src:K,options:A}){f.loadSprite(K,K,A)}Y({src:"terrain/water/water.png"}),Y({src:"terrain/water/foam.png",options:q3}),Y({src:"characters/warwick.png",options:dK});for(let K=1;K<=4;K++)Y({src:`terrain/water/rocks/rocks_0${K}.png`,options:q3});Y({src:"terrain/ground/shadows.png"}),Y({src:"terrain/ground/tilemap_elevation.png",options:aK}),Y({src:"terrain/ground/tilemap_flat.png",options:wK})}function d5(){let f=t1();$3({k:f});let Y=new r5(f,(K)=>{A2({k:f,message:K,duration:3,callback:()=>f.go("join")})});C6({k:f}),J3({k:f,server:Y}),e1({k:f,server:Y}),Y5({k:f,server:Y}),I3({k:f}),f.go("offline")}window.addEventListener("load",()=>{d5()});
